{% extends "base.html" %}

{% block title %}Questionnaires - FabriceKonan Corporate{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête avec boutons d'action -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-1">
                <i class="fas fa-poll me-2" style="color: var(--fk-accent);"></i>
                Gestion des Questionnaires
            </h1>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Tableau de bord</a></li>
                    <li class="breadcrumb-item active">Questionnaires</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{{ url_for('importer_questionnaire') }}" class="fk-btn fk-btn-outline me-2">
                <i class="fas fa-file-import me-2"></i>
                Importer
            </a>
            <a href="{{ url_for('nouveau_questionnaire') }}" class="fk-btn fk-btn-primary">
                <i class="fas fa-plus-circle me-2"></i>
                Nouveau questionnaire
            </a>
        </div>
    </div>

    <!-- Statistiques rapides - Design plat -->
    <div class="row mb-4">
        {% set total_questionnaires = questionnaires|length %}
        {% set actifs = questionnaires|selectattr("est_actif", "equalto", true)|list|length %}
        {% set publics = questionnaires|selectattr("est_public", "equalto", true)|list|length %}
        
        <!-- Calcul du nombre total de réponses -->
        {% set total_reponses = namespace(value=0) %}
        {% for questionnaire in questionnaires %}
            {% set total_reponses.value = total_reponses.value + questionnaire.reponses|length %}
        {% endfor %}
        
        <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-3">
            <div class="fk-card h-100 border-0 shadow-sm">
                <div class="fk-card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center" 
                                 style="width: 50px; height: 50px;">
                                <i class="fas fa-file-alt text-primary"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h2 class="mb-0">{{ total_questionnaires }}</h2>
                            <p class="text-muted mb-0 small">Questionnaires</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-3">
            <div class="fk-card h-100 border-0 shadow-sm">
                <div class="fk-card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center" 
                                 style="width: 50px; height: 50px;">
                                <i class="fas fa-check-circle text-success"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h2 class="mb-0">{{ actifs }}</h2>
                            <p class="text-muted mb-0 small">Actifs</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-3">
            <div class="fk-card h-100 border-0 shadow-sm">
                <div class="fk-card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-info bg-opacity-10 d-flex align-items-center justify-content-center" 
                                 style="width: 50px; height: 50px;">
                                <i class="fas fa-globe text-info"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h2 class="mb-0">{{ publics }}</h2>
                            <p class="text-muted mb-0 small">Publics</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-lg-6 col-md-6 col-sm-6 mb-3">
            <div class="fk-card h-100 border-0 shadow-sm">
                <div class="fk-card-body p-3">
                    <div class="d-flex align-items-center">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-warning bg-opacity-10 d-flex align-items-center justify-content-center" 
                                 style="width: 50px; height: 50px;">
                                <i class="fas fa-users text-warning"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                            <h2 class="mb-0">{{ total_reponses.value }}</h2>
                            <p class="text-muted mb-0 small">Réponses</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau des questionnaires - Design plat -->
    <div class="fk-card border-0 shadow-sm">
        <div class="fk-card-header bg-transparent border-bottom px-4 py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="mb-0 fw-semibold">Liste des Questionnaires</h5>
                </div>
                <div class="d-flex align-items-center">
                    <div class="input-group input-group-sm me-2" style="width: 200px;">
                        <span class="input-group-text bg-transparent border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control border-start-0" placeholder="Rechercher..." id="searchQuestionnaire">
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary border" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-filter me-1"></i>
                            Filtrer
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end border shadow-sm">
                            <li><a class="dropdown-item py-2" href="{{ url_for('liste_questionnaires') }}">Tous les questionnaires</a></li>
                            <li><a class="dropdown-item py-2" href="{{ url_for('liste_questionnaires', statut='actif') }}">Questionnaires actifs</a></li>
                            <li><a class="dropdown-item py-2" href="{{ url_for('liste_questionnaires', statut='inactif') }}">Questionnaires inactifs</a></li>
                            <li><a class="dropdown-item py-2" href="{{ url_for('liste_questionnaires', type='public') }}">Questionnaires publics</a></li>
                            <li><a class="dropdown-item py-2" href="{{ url_for('liste_questionnaires', type='prive') }}">Questionnaires privés</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="fk-card-body p-0">
            {% if questionnaires %}
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light">
                        <tr>
                            <th class="ps-4 py-3 border-bottom" width="300">QUESTIONNAIRE</th>
                            <th class="py-3 border-bottom" width="120">CODE</th>
                            <th class="py-3 border-bottom" width="100">STATUT</th>
                            <th class="py-3 border-bottom" width="100">VISIBILITÉ</th>
                            <th class="py-3 border-bottom" width="100">RÉPONSES</th>
                            <th class="py-3 border-bottom" width="120">CRÉATION</th>
                            <th class="py-3 border-bottom text-center pe-4" width="150">ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for questionnaire in questionnaires %}
                        <tr class="questionnaire-row border-bottom">
                            <td class="ps-4 py-3">
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0">
                                        <div class="bg-primary bg-opacity-10 rounded p-2 me-3">
                                            <i class="fas fa-poll text-primary"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <div class="mb-1">
                                            <strong>{{ questionnaire.titre }}</strong>
                                        </div>
                                        {% if questionnaire.description %}
                                        <div class="text-muted small text-truncate" style="max-width: 250px;">
                                            {{ questionnaire.description }}
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td class="py-3">
                                <code class="small bg-light px-2 py-1 rounded border">
                                    {{ questionnaire.code }}
                                </code>
                            </td>
                            <td class="py-3">
                                {% if questionnaire.est_actif %}
                                <span class="badge bg-success bg-opacity-10 text-success border border-success py-1 px-2">
                                    Actif
                                </span>
                                {% else %}
                                <span class="badge bg-danger bg-opacity-10 text-danger border border-danger py-1 px-2">
                                    Inactif
                                </span>
                                {% endif %}
                            </td>
                            <td class="py-3">
                                {% if questionnaire.est_public %}
                                <span class="badge bg-info bg-opacity-10 text-info border border-info py-1 px-2">
                                    Public
                                </span>
                                {% else %}
                                <span class="badge bg-secondary bg-opacity-10 text-secondary border border-secondary py-1 px-2">
                                    Privé
                                </span>
                                {% endif %}
                            </td>
                            <td class="py-3">
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <i class="fas fa-users text-muted"></i>
                                    </div>
                                    <div>
                                        <span class="fw-medium">{{ questionnaire.reponses|length }}</span>
                                    </div>
                                </div>
                            </td>
                            <td class="py-3">
                                <div class="small">
                                    <div>{{ questionnaire.date_creation.strftime('%d/%m/%Y') }}</div>
                                </div>
                            </td>
                            <td class="py-3 pe-4">
                                <div class="d-flex justify-content-center">
                                    <!-- Actions principales - Boutons séparés -->
                                    <div class="d-flex gap-1">
                                        <a href="{{ url_for('editer_questionnaire', id=questionnaire.id) }}" 
                                           class="btn btn-sm btn-outline-primary rounded-circle d-flex align-items-center justify-content-center"
                                           style="width: 32px; height: 32px;"
                                           title="Éditer">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        
                                        {% if questionnaire.est_actif %}
                                        <a href="{{ url_for('generer_lien_questionnaire', id=questionnaire.id) }}" 
                                        target="_blank" 
                                        class="btn btn-sm btn-outline-success rounded-circle d-flex align-items-center justify-content-center"
                                        style="width: 32px; height: 32px;"
                                        title="Lien public">
                                            <i class="fas fa-external-link-alt"></i>
                                        </a>
                                        {% endif %}
                                        
                                        <a href="{{ url_for('voir_reponses_questionnaire', id=questionnaire.id) }}" 
                                           class="btn btn-sm btn-outline-info rounded-circle d-flex align-items-center justify-content-center"
                                           style="width: 32px; height: 32px;"
                                           title="Statistiques">
                                            <i class="fas fa-chart-bar"></i>
                                        </a>
                                        
                                        <!-- Menu dropdown corrigé -->
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary rounded-circle d-flex align-items-center justify-content-center"
                                                    style="width: 32px; height: 32px;"
                                                    type="button" 
                                                    data-bs-toggle="dropdown"
                                                    data-bs-boundary="viewport"
                                                    data-bs-offset="0,10"
                                                    title="Plus d'options">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end border shadow-sm" style="min-width: 200px;">
                                                <li>
                                                    <a class="dropdown-item py-2" href="#" onclick="dupliquerQuestionnaire({{ questionnaire.id }})">
                                                        <i class="fas fa-copy me-2 text-muted"></i>
                                                        Dupliquer
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item py-2" href="#" onclick="exporterQuestionnaire({{ questionnaire.id }})">
                                                        <i class="fas fa-download me-2 text-muted"></i>
                                                        Exporter les réponses
                                                    </a>
                                                </li>
                                                <li><hr class="dropdown-divider my-1"></li>
                                                <li>
                                                    <form action="{{ url_for('changer_statut_questionnaire', id=questionnaire.id) }}" 
                                                          method="POST" class="d-inline w-100">
                                                        <button type="submit" class="dropdown-item py-2 w-100 text-start">
                                                            {% if questionnaire.est_actif %}
                                                            <i class="fas fa-ban me-2 text-warning"></i>
                                                            <span class="text-warning">Désactiver</span>
                                                            {% else %}
                                                            <i class="fas fa-check me-2 text-success"></i>
                                                            <span class="text-success">Activer</span>
                                                            {% endif %}
                                                        </button>
                                                    </form>
                                                </li>
                                                <li>
                                                    <a class="dropdown-item py-2 text-danger" href="#" 
                                                       onclick="supprimerQuestionnaire({{ questionnaire.id }}, '{{ questionnaire.titre }}')">
                                                        <i class="fas fa-trash me-2"></i>
                                                        Supprimer
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <!-- État vide - Design plat -->
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-poll fa-4x text-muted opacity-25"></i>
                </div>
                <h5 class="mb-3">Aucun questionnaire créé</h5>
                <p class="text-muted mb-4" style="max-width: 500px; margin: 0 auto;">
                    Commencez par créer votre premier questionnaire pour collecter des données.
                </p>
                <div class="d-flex justify-content-center gap-2">
                    <a href="{{ url_for('nouveau_questionnaire') }}" class="fk-btn fk-btn-primary px-3">
                        <i class="fas fa-plus-circle me-2"></i>
                        Créer un questionnaire
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
        
        <!-- Footer avec informations -->
        {% if questionnaires and questionnaires|length > 0 %}
        <div class="fk-card-footer bg-transparent border-top px-4 py-3">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <small class="text-muted">
                        {{ questionnaires|length }} questionnaire{% if questionnaires|length > 1 %}s{% endif %}
                    </small>
                </div>
                <div>
                    <small class="text-muted">
                        <i class="fas fa-sync-alt me-1"></i>
                        Actualisé à l'instant
                    </small>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modals pour les actions -->
<div class="modal fade" id="confirmationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-bottom">
                <h5 class="modal-title" id="modalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Le contenu sera rempli par JavaScript -->
            </div>
            <div class="modal-footer border-top">
                <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-sm btn-primary" id="modalConfirmBtn">Confirmer</button>
            </div>
        </div>
    </div>
</div>

<!-- Script pour les interactions -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Recherche en temps réel
    const searchInput = document.getElementById('searchQuestionnaire');
    if (searchInput) {
        searchInput.addEventListener('keyup', function() {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('tbody tr.questionnaire-row');
            
            rows.forEach(row => {
                const rowText = row.textContent.toLowerCase();
                if (rowText.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    }
    
    // Prévenir la propagation du clic sur les formulaires dans le dropdown
    document.querySelectorAll('.dropdown form').forEach(form => {
        form.addEventListener('click', function(e) {
            e.stopPropagation();
        });
    });
    
    // Initialisation des tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Fonctions pour les actions du dropdown
function dupliquerQuestionnaire(id) {
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    document.getElementById('modalTitle').textContent = 'Dupliquer le questionnaire';
    document.getElementById('modalBody').innerHTML = `
        <p>Êtes-vous sûr de vouloir dupliquer ce questionnaire ?</p>
        <p class="text-muted small">Une copie exacte sera créée avec le statut "inactif".</p>
    `;
    
    document.getElementById('modalConfirmBtn').onclick = function() {
        fetch(`/questionnaire/${id}/dupliquer`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erreur lors de la duplication');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la duplication');
        });
        modal.hide();
    };
    
    modal.show();
}

function exporterQuestionnaire(id) {
    window.location.href = `/questionnaire/${id}/exporter`;
}

function supprimerQuestionnaire(id, titre) {
    const modal = new bootstrap.Modal(document.getElementById('confirmationModal'));
    document.getElementById('modalTitle').textContent = 'Supprimer le questionnaire';
    document.getElementById('modalBody').innerHTML = `
        <p class="mb-3">Êtes-vous sûr de vouloir supprimer le questionnaire :</p>
        <div class="alert alert-light border mb-3">
            <strong>"${titre}"</strong>
        </div>
        <p class="text-danger small mb-0">
            <i class="fas fa-exclamation-triangle me-1"></i>
            Cette action est irréversible.
        </p>
    `;
    
    document.getElementById('modalConfirmBtn').className = 'btn btn-sm btn-danger';
    document.getElementById('modalConfirmBtn').textContent = 'Supprimer';
    
    document.getElementById('modalConfirmBtn').onclick = function() {
        fetch(`/questionnaire/${id}/supprimer`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken()
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erreur lors de la suppression');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la suppression');
        });
        modal.hide();
    };
    
    modal.show();
}

// Fonction utilitaire pour récupérer le token CSRF
function getCSRFToken() {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta ? meta.getAttribute('content') : '';
}
</script>

<style>
/* Styles spécifiques pour cette page - Design plat */
.fk-card {
    background: white;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
}

.fk-card-header {
    background-color: #f8fafc;
    border-bottom: 1px solid #e2e8f0;
}

.table {
    margin-bottom: 0;
}

.table thead th {
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: #64748b;
    background-color: #f8fafc;
}

.table tbody tr {
    transition: background-color 0.15s ease;
}

.table tbody tr:hover {
    background-color: #f8fafc;
}

.badge {
    font-weight: 500;
    font-size: 0.75rem;
}

.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.btn-outline-primary,
.btn-outline-success,
.btn-outline-info,
.btn-outline-secondary {
    border-width: 1px;
}

.btn-outline-primary:hover {
    background-color: var(--fk-accent);
    border-color: var(--fk-accent);
    color: white;
}

.btn-outline-success:hover {
    background-color: var(--fk-success);
    border-color: var(--fk-success);
    color: white;
}

.btn-outline-info:hover {
    background-color: #0dcaf0;
    border-color: #0dcaf0;
    color: white;
}

/* Correction du dropdown */
.dropdown-menu {
    border: 1px solid #e2e8f0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    border-radius: 6px;
    padding: 0.25rem 0;
}

.dropdown-item {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
    border-radius: 4px;
    margin: 0 0.25rem;
}

.dropdown-item:hover {
    background-color: #f1f5f9;
}

.dropdown-divider {
    margin: 0.25rem 0;
    border-color: #e2e8f0;
}

/* Boutons ronds pour les actions */
.btn.rounded-circle {
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
}

/* Barre de recherche */
.input-group-text {
    background-color: transparent;
    border-color: #cbd5e1;
}

.input-group .form-control {
    border-color: #cbd5e1;
}

.input-group .form-control:focus {
    box-shadow: none;
    border-color: var(--fk-accent);
}

.input-group:focus-within .input-group-text {
    border-color: var(--fk-accent);
}

/* Responsive */
@media (max-width: 768px) {
    .d-flex.justify-content-between {
        flex-direction: column;
        align-items: flex-start !important;
    }
    
    .d-flex.justify-content-between > div:last-child {
        margin-top: 1rem;
    }
    
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .btn-sm {
        padding: 0.2rem 0.4rem;
        font-size: 0.75rem;
    }
    
    .btn.rounded-circle {
        width: 28px;
        height: 28px;
    }
    
    .input-group {
        width: 100% !important;
        margin-bottom: 0.5rem;
    }
    
    .dropdown {
        width: 100%;
    }
    
    .dropdown > button {
        width: 100%;
    }
}
</style>
{% endblock %}
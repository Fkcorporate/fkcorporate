{% extends "base.html" %}

{% block title %}Lien public - {{ questionnaire.titre }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="fas fa-link me-2"></i>
                    Lien public - {{ questionnaire.titre }}
                </h1>
                <a href="{{ url_for('liste_questionnaires') }}" 
                   class="btn btn-modern btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>
                    Retour
                </a>
            </div>
            <p class="text-muted">Partagez ce lien pour collecter des réponses</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-globe me-2"></i>
                        Lien public
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-success">
                        <h6 class="alert-heading">
                            <i class="fas fa-check-circle me-2"></i>
                            Lien généré avec succès
                        </h6>
                        <p class="mb-2">Partagez ce lien avec vos répondants :</p>
                        
                        <div class="input-group mb-3">
                            <input type="text" 
                                   class="form-control" 
                                   id="lienPublic" 
                                   value="{{ lien_public }}" 
                                   readonly>
                            <button class="btn btn-primary" 
                                    type="button" 
                                    onclick="copyToClipboard('lienPublic')">
                                <i class="fas fa-copy me-2"></i>
                                Copier
                            </button>
                        </div>
                        
                        <div class="mt-3">
                            <a href="{{ lien_public }}" 
                               class="btn btn-modern btn-success" 
                               target="_blank">
                                <i class="fas fa-external-link-alt me-2"></i>
                                Ouvrir le questionnaire
                            </a>
                            
                            <button type="button" 
                                    class="btn btn-modern btn-outline-primary"
                                    onclick="generateQRCode()">
                                <i class="fas fa-qrcode me-2"></i>
                                Générer QR Code
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4" id="qrcode-container" style="display: none;">
                        <h6 class="mb-3">
                            <i class="fas fa-qrcode me-2"></i>
                            QR Code
                        </h6>
                        <div class="text-center">
                            <div id="qrcode"></div>
                            <p class="text-muted small mt-2">
                                Scannez ce code avec votre smartphone
                            </p>
                            <button type="button" 
                                    class="btn btn-sm btn-outline-secondary"
                                    onclick="downloadQRCode()">
                                <i class="fas fa-download me-2"></i>
                                Télécharger QR Code
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card-modern mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-share-alt me-2"></i>
                        Partager sur les réseaux sociaux
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-share btn-facebook" onclick="shareFacebook()">
                            <i class="fab fa-facebook-f me-2"></i>
                            Facebook
                        </button>
                        <button type="button" class="btn btn-share btn-twitter" onclick="shareTwitter()">
                            <i class="fab fa-twitter me-2"></i>
                            Twitter
                        </button>
                        <button type="button" class="btn btn-share btn-linkedin" onclick="shareLinkedIn()">
                            <i class="fab fa-linkedin-in me-2"></i>
                            LinkedIn
                        </button>
                        <button type="button" class="btn btn-share btn-whatsapp" onclick="shareWhatsApp()">
                            <i class="fab fa-whatsapp me-2"></i>
                            WhatsApp
                        </button>
                        <button type="button" class="btn btn-share btn-email" onclick="shareEmail()">
                            <i class="fas fa-envelope me-2"></i>
                            Email
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card-modern mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Informations du questionnaire
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Code
                            <span class="badge bg-primary">{{ questionnaire.code }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Statut
                            <span class="badge {{ 'bg-success' if questionnaire.est_actif else 'bg-danger' }}">
                                {{ 'Actif' if questionnaire.est_actif else 'Inactif' }}
                            </span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Visibilité
                            <span class="badge {{ 'bg-info' if questionnaire.est_public else 'bg-warning' }}">
                                {{ 'Public' if questionnaire.est_public else 'Privé' }}
                            </span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Date création
                            <span class="text-muted">
                                {{ questionnaire.date_creation.strftime('%d/%m/%Y') if questionnaire.date_creation else 'N/A' }}
                            </span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Créé par
                            <span class="text-muted">
                                {{ questionnaire.createur.nom if questionnaire.createur else 'Système' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-modern mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>
                        Statistiques
                    </h5>
                </div>
                <div class="card-body">
                    <div class="list-group">
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Réponses totales
                            <span class="badge bg-primary rounded-pill">{{ questionnaire.reponses|length }}</span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Réponses complètes
                            <span class="badge bg-success rounded-pill">
                                {{ questionnaire.reponses|selectattr('statut', 'equalto', 'complet')|list|length }}
                            </span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Première réponse
                            <span class="text-muted">
                                {% if questionnaire.reponses %}
                                    {% set reponses_triees = questionnaire.reponses|sort(attribute='date_debut') %}
                                    {% set premiere_reponse = reponses_triees[0] %}
                                    {% if premiere_reponse.date_debut %}
                                        {{ premiere_reponse.date_debut.strftime('%d/%m/%Y') }}
                                    {% else %}
                                        Non spécifié
                                    {% endif %}
                                {% else %}
                                    Aucune réponse
                                {% endif %}
                            </span>
                        </div>
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            Dernière réponse
                            <span class="text-muted">
                                {% if questionnaire.reponses %}
                                    {% set reponses_triees = questionnaire.reponses|sort(attribute='date_debut', reverse=true) %}
                                    {% set derniere_reponse = reponses_triees[0] %}
                                    {% if derniere_reponse.date_debut %}
                                        {{ derniere_reponse.date_debut.strftime('%d/%m/%Y') }}
                                    {% else %}
                                        Non spécifié
                                    {% endif %}
                                {% else %}
                                    Aucune réponse
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-modern">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-cog me-2"></i>
                        Paramètres
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning">
                        <h6 class="alert-heading">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Important
                        </h6>
                        <ul class="mb-0 ps-3">
                            <li>Le questionnaire doit être <strong>actif</strong> pour être accessible</li>
                            <li>Si <strong>privé</strong>, une authentification sera requise</li>
                            <li>Vérifiez les dates de validité si configurées</li>
                        </ul>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <a href="{{ url_for('editer_questionnaire', id=questionnaire.id) }}" 
                           class="btn btn-modern btn-outline-primary">
                            <i class="fas fa-edit me-2"></i>
                            Modifier le questionnaire
                        </a>
                        <a href="{{ url_for('voir_reponses_questionnaire', id=questionnaire.id) }}" 
                           class="btn btn-modern btn-outline-success">
                            <i class="fas fa-chart-bar me-2"></i>
                            Voir les réponses
                        </a>
                        <button type="button" 
                                class="btn btn-modern btn-outline-danger"
                                onclick="resetLink()">
                            <i class="fas fa-redo me-2"></i>
                            Régénérer le lien
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.btn-share {
    flex: 1;
    color: white;
    border: none;
}

.btn-facebook {
    background-color: #3b5998;
}

.btn-twitter {
    background-color: #1da1f2;
}

.btn-linkedin {
    background-color: #0077b5;
}

.btn-whatsapp {
    background-color: #25d366;
}

.btn-email {
    background-color: #ea4335;
}

.btn-share:hover {
    opacity: 0.9;
    transform: translateY(-1px);
}
</style>

<script>
function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999);
    
    try {
        const successful = document.execCommand('copy');
        if (successful) {
            const button = element.nextElementSibling;
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check me-2"></i>Copié!';
            button.classList.add('btn-success');
            
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
            }, 2000);
        }
    } catch (err) {
        console.error('Erreur copie:', err);
        alert('Impossible de copier le lien. Copiez-le manuellement.');
    }
}

function generateQRCode() {
    const container = document.getElementById('qrcode-container');
    const qrcodeDiv = document.getElementById('qrcode');
    
    // Vider le contenu précédent
    qrcodeDiv.innerHTML = '';
    
    // Afficher le conteneur
    container.style.display = 'block';
    
    // Générer le QR Code (utiliser une librairie comme qrcode.js)
    const lien = document.getElementById('lienPublic').value;
    
    // Si vous avez qrcode.js inclus
    if (typeof QRCode !== 'undefined') {
        new QRCode(qrcodeDiv, {
            text: lien,
            width: 200,
            height: 200,
            colorDark: "#000000",
            colorLight: "#ffffff",
            correctLevel: QRCode.CorrectLevel.H
        });
    } else {
        // Fallback : afficher un message
        qrcodeDiv.innerHTML = `
            <div class="alert alert-info">
                <p>Pour générer un QR Code, incluez la librairie qrcode.js :</p>
                <code>&lt;script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"&gt;&lt;/script&gt;</code>
            </div>
        `;
    }
}

function downloadQRCode() {
    const qrcodeCanvas = document.querySelector('#qrcode canvas');
    if (qrcodeCanvas) {
        const link = document.createElement('a');
        link.download = 'qrcode-questionnaire-{{ questionnaire.code }}.png';
        link.href = qrcodeCanvas.toDataURL('image/png');
        link.click();
    } else {
        alert('Générez d\'abord le QR Code');
    }
}

function shareFacebook() {
    const url = encodeURIComponent('{{ lien_public }}');
    const text = encodeURIComponent('Répondez à ce questionnaire: {{ questionnaire.titre }}');
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${text}`, '_blank');
}

function shareTwitter() {
    const url = encodeURIComponent('{{ lien_public }}');
    const text = encodeURIComponent('Répondez à ce questionnaire: {{ questionnaire.titre }}');
    window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank');
}

function shareLinkedIn() {
    const url = encodeURIComponent('{{ lien_public }}');
    const title = encodeURIComponent('{{ questionnaire.titre }}');
    const summary = encodeURIComponent('Questionnaire disponible pour réponse');
    window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank');
}

function shareWhatsApp() {
    const text = encodeURIComponent('Répondez à ce questionnaire: {{ questionnaire.titre }}\n{{ lien_public }}');
    window.open(`https://wa.me/?text=${text}`, '_blank');
}

function shareEmail() {
    const subject = encodeURIComponent('Questionnaire: {{ questionnaire.titre }}');
    const body = encodeURIComponent(`Bonjour,\n\nJe vous invite à répondre à ce questionnaire :\n\n{{ questionnaire.titre }}\n{{ lien_public }}\n\nMerci pour votre participation.`);
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
}

function resetLink() {
    if (confirm('Êtes-vous sûr de vouloir régénérer le lien ? Cela invalidera tous les liens précédents.')) {
        // Ajoutez ici la logique pour régénérer le lien
        alert('Fonctionnalité à implémenter');
    }
}

// Inclure qrcode.js si nécessaire
document.addEventListener('DOMContentLoaded', function() {
    // Vérifier si qrcode.js est déjà chargé
    if (typeof QRCode === 'undefined') {
        // Charger dynamiquement
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js';
        document.head.appendChild(script);
    }
});
</script>
{% endblock %}
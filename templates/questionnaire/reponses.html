{% extends "base.html" %}

{% block title %}Réponses - {{ questionnaire.titre }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="h3 mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Réponses - {{ questionnaire.titre }}
                </h1>
                <div>
                    <a href="{{ url_for('editer_questionnaire', id=questionnaire.id) }}" 
                       class="btn btn-modern btn-secondary me-2">
                        <i class="fas fa-arrow-left me-2"></i>
                        Retour
                    </a>
                    <a href="{{ url_for('statistiques_questionnaire', id=questionnaire.id) }}" 
                       class="btn btn-modern btn-info me-2">
                        <i class="fas fa-chart-pie me-2"></i>
                        Statistiques
                    </a>
                    <a href="{{ url_for('exporter_questionnaire', id=questionnaire.id) }}" 
                       class="btn btn-modern btn-primary">
                        <i class="fas fa-download me-2"></i>
                        Exporter
                    </a>
                </div>
            </div>
            <p class="text-muted">{{ questionnaire.description }}</p>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card-modern text-center">
                <div class="card-body">
                    <h2 class="text-primary mb-0">{{ reponses|length }}</h2>
                    <p class="text-muted mb-0">Réponses totales</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-modern text-center">
                <div class="card-body">
                    <h2 class="text-success mb-0">
                        {% set reponses_completes = reponses|selectattr('statut', 'equalto', 'complet')|list %}
                        {{ reponses_completes|length }}
                    </h2>
                    <p class="text-muted mb-0">Complètes</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-modern text-center">
                <div class="card-body">
                    <h2 class="text-warning mb-0">
                        {% set reponses_en_cours = reponses|selectattr('statut', 'equalto', 'en_cours')|list %}
                        {{ reponses_en_cours|length }}
                    </h2>
                    <p class="text-muted mb-0">En cours</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card-modern text-center">
                <div class="card-body">
                    <h2 class="text-danger mb-0">
                        {% set reponses_abandonnees = reponses|selectattr('statut', 'equalto', 'abandonne')|list %}
                        {{ reponses_abandonnees|length }}
                    </h2>
                    <p class="text-muted mb-0">Abandonnées</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card-modern">
                <div class="card-body">
                    <form class="row g-3" id="filtresForm" method="GET">
                        <div class="col-md-3">
                            <label class="form-label">Statut</label>
                            <select class="form-select" name="statut" onchange="this.form.submit()">
                                <option value="">Tous</option>
                                <option value="complet" {% if request.args.get('statut') == 'complet' %}selected{% endif %}>Complètes</option>
                                <option value="en_cours" {% if request.args.get('statut') == 'en_cours' %}selected{% endif %}>En cours</option>
                                <option value="abandonne" {% if request.args.get('statut') == 'abandonne' %}selected{% endif %}>Abandonnées</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Date début</label>
                            <input type="date" class="form-control" name="date_debut" 
                                   value="{{ request.args.get('date_debut', '') }}"
                                   onchange="this.form.submit()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Date fin</label>
                            <input type="date" class="form-control" name="date_fin"
                                   value="{{ request.args.get('date_fin', '') }}"
                                   onchange="this.form.submit()">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <a href="{{ url_for('voir_reponses_questionnaire', id=questionnaire.id) }}" 
                                   class="btn btn-secondary">
                                    Réinitialiser
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau des réponses -->
    <div class="row">
        <div class="col-12">
            <div class="card-modern">
                <div class="card-body">
                    {% if reponses %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="reponsesTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Date</th>
                                    <th>Statut</th>
                                    <th>Durée</th>
                                    <th>Nom</th>
                                    <th>Email</th>
                                    <th>IP</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for reponse in reponses %}
                                <tr>
                                    <td>#{{ reponse.id }}</td>
                                    <td>
                                        <small class="d-block">{{ reponse.date_debut.strftime('%d/%m/%Y') }}</small>
                                        <small class="text-muted">{{ reponse.date_debut.strftime('%H:%M') }}</small>
                                        {% if reponse.date_fin %}
                                        <br>
                                        <small class="text-muted">Terminé: {{ reponse.date_fin.strftime('%H:%M') }}</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if reponse.statut == 'complet' %}
                                        <span class="badge bg-success">Complet</span>
                                        {% elif reponse.statut == 'en_cours' %}
                                        <span class="badge bg-warning">En cours</span>
                                        {% else %}
                                        <span class="badge bg-danger">Abandonné</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if reponse.duree %}
                                            {% set minutes = reponse.duree // 60 %}
                                            {% set secondes = reponse.duree % 60 %}
                                            {% if minutes > 0 %}
                                                {{ minutes }}min 
                                            {% endif %}
                                            {{ secondes }}s
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td>{{ reponse.nom_repondant or '-' }}</td>
                                    <td>{{ reponse.email_repondant or '-' }}</td>
                                    <td>
                                        <small>{{ reponse.ip_address or '-' }}</small>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <a href="{{ url_for('detail_reponse', id=reponse.id) }}" 
                                               class="btn btn-sm btn-outline-primary" title="Voir détails">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <button class="btn btn-sm btn-outline-danger" 
                                                    title="Supprimer"
                                                    onclick="supprimerReponse({{ reponse.id }})">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <nav aria-label="Navigation des réponses">
                        <ul class="pagination justify-content-center mt-3">
                            <li class="page-item {% if not has_prev %}disabled{% endif %}">
                                <a class="page-link" href="?page={{ page-1 if has_prev else 1 }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    Précédent
                                </a>
                            </li>
                            
                            {% for p in range(1, total_pages + 1) %}
                                {% if p == page %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ p }}</span>
                                    </li>
                                {% else %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ p }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                            {{ p }}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                            
                            <li class="page-item {% if not has_next %}disabled{% endif %}">
                                <a class="page-link" href="?page={{ page+1 if has_next else total_pages }}{% for key, value in request.args.items() %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
                                    Suivant
                                </a>
                            </li>
                        </ul>
                    </nav>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Aucune réponse enregistrée</p>
                        <a href="{{ url_for('questionnaire_public', code=questionnaire.code) }}" 
                           target="_blank" class="btn btn-primary">
                            <i class="fas fa-external-link-alt me-2"></i>
                            Accéder au questionnaire
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal confirmation suppression -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir supprimer cette réponse ? Cette action est irréversible.</p>
                <p class="text-muted">Toutes les réponses associées seront également supprimées.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Supprimer</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
let reponseToDelete = null;

// Initialiser DataTable uniquement si des données existent
document.addEventListener('DOMContentLoaded', function() {
    const table = $('#reponsesTable');
    if (table.length && table.find('tbody tr').length > 0) {
        table.DataTable({
            language: {
                url: '//cdn.datatables.net/plug-ins/1.13.6/i18n/fr-FR.json'
            },
            pageLength: 25,
            order: [[0, 'desc']],
            responsive: true,
            dom: '<"top"f>rt<"bottom"lip><"clear">',
            columnDefs: [
                {
                    targets: [7], // Actions column
                    orderable: false,
                    searchable: false
                }
            ],
            initComplete: function() {
                console.log('DataTable initialisé avec succès');
            }
        });
    }
});

// Gestion de la suppression
function supprimerReponse(id) {
    reponseToDelete = id;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

document.getElementById('confirmDelete').addEventListener('click', function() {
    if (reponseToDelete) {
        fetch(`/api/reponse/${reponseToDelete}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur lors de la suppression');
            }
            return response.json();
        })
        .then(result => {
            if (result.success) {
                // Fermer le modal
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                // Recharger la page
                location.reload();
            } else {
                alert('Erreur: ' + (result.error || 'Erreur inconnue'));
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors de la suppression: ' + error.message);
        });
    }
});
</script>

<style>
.dataTables_wrapper .dataTables_length select {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

#reponsesTable {
    width: 100% !important;
}

@media (max-width: 768px) {
    #reponsesTable th:nth-child(6),
    #reponsesTable td:nth-child(6),
    #reponsesTable th:nth-child(7),
    #reponsesTable td:nth-child(7) {
        display: none;
    }
}
</style>
{% endblock %}
{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-4">
    <!-- En-tête avec navigation -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_cartographie', id=risque.cartographie_id) }}">Cartographie</a></li>
                            <li class="breadcrumb-item"><a href="{{ url_for('detail_risque', id=risque.id) }}">{{ risque.reference }}</a></li>
                            <li class="breadcrumb-item active">Évaluation Triphase</li>
                        </ol>
                    </nav>
                    <h1 class="h3 mb-2">Évaluation Triphase du Risque</h1>
                    <p class="text-muted">{{ risque.reference }} - {{ risque.intitule }}</p>
                </div>
                <div class="btn-group">
                    <a href="{{ url_for('detail_risque', id=risque.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>Retour au risque
                    </a>
                    <!-- Dans la section des boutons d'action -->
                    <div class="btn-group ms-2">
                        <button type="button" class="btn btn-success dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-2"></i>Exporter
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="{{ url_for('export_evaluations_triphase_excel') }}">
                                    <i class="fas fa-file-excel me-2 text-success"></i>
                                    Export Excel Complet
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="#" onclick="exporterEvaluationCourante()">
                                    <i class="fas fa-file-pdf me-2 text-danger"></i>
                                    PDF Évaluation Courante
                                </a>
                            </li>
                        </ul>
                    </div>
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#guideModal">
                        <i class="fas fa-question-circle me-2"></i>Guide
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Colonne principale - Processus d'évaluation -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <ul class="nav nav-pills nav-fill" id="evaluationTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="phase1-tab" data-bs-toggle="pill" data-bs-target="#phase1" type="button" role="tab">
                                <i class="fas fa-search me-2"></i>Phase 1<br>
                                <small class="text-muted">Pré-évaluation</small>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="phase2-tab" data-bs-toggle="pill" data-bs-target="#phase2" type="button" role="tab">
                                <i class="fas fa-check-circle me-2"></i>Phase 2<br>
                                <small class="text-muted">Validation</small>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="phase3-tab" data-bs-toggle="pill" data-bs-target="#phase3" type="button" role="tab">
                                <i class="fas fa-flag me-2"></i>Phase 3<br>
                                <small class="text-muted">Confirmation</small>
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="card-body p-4">
                    <div class="tab-content" id="evaluationTabsContent">
                        <!-- PHASE 1 - Pré-évaluation -->
                        <div class="tab-pane fade show active" id="phase1" role="tabpanel">
                            <form method="POST" id="phase1Form">
                                {{ form.csrf_token }}
                                <input type="hidden" name="phase" value="1">
                                
                                <!-- Sélecteur de risque de la cartographie -->
                                <div class="row mb-4">
                                    <div class="col-12">
                                        <div class="card bg-light border-0">
                                            <div class="card-body py-3">
                                                <div class="row align-items-center">
                                                    <div class="col-md-4">
                                                        <label class="form-label fw-bold mb-1">Risque à évaluer</label>
                                                        <select class="form-select" id="selectRisque" onchange="changerRisque()">
                                                            {% for r in risques_cartographie %}
                                                            <option value="{{ r.id }}" {% if r.id == risque.id %}selected{% endif %} 
                                                                data-archived="{{ r.is_archived|default(false) }}">
                                                                {{ r.reference }} - {{ r.intitule }}
                                                                {% if r.is_archived %}(Archivé){% endif %}
                                                            </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-8">
                                                        <div class="d-flex gap-2 flex-wrap">
                                                            <span class="badge bg-secondary">{{ risque.categorie }}</span>
                                                            <span class="badge bg-info">{{ risque.type_risque or 'Type non défini' }}</span>
                                                            {% if risque.processus_concerne %}
                                                            <span class="badge bg-dark">{{ risque.processus_concerne }}</span>
                                                            {% endif %}
                                                            {% if risque.is_archived %}
                                                            <span class="badge bg-warning">Archivé</span>
                                                            {% endif %}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Baromètre d'évaluation en ligne - VERSION DYNAMIQUE -->
                                <div class="row mb-4">
                                    <!-- Impact Potentiel -->
                                    <div class="col-md-4">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-header" style="background-color: {{ get_niveau_couleur('phase', 'phase1') or '#007bff' }}; color: white;">
                                                <h6 class="mb-0"><i class="fas fa-bullseye me-2"></i>Impact Potentiel</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="barometre-container">
                                                    <div class="barometre-echelles-horizontal">
                                                        {% for i in range(1, 6) %}
                                                        <div class="echelle-item-horizontal {% if evaluation_en_cours and evaluation_en_cours.impact_pre == i %}active{% endif %}" 
                                                             data-value="{{ i }}" data-type="impact">
                                                            <div class="echelle-niveau-horizontal" 
                                                                 style="background-color: {{ get_niveau_couleur('impact', i) }};"></div>
                                                            <div class="echelle-label-horizontal">
                                                                <strong>{{ i }}</strong>
                                                                <small class="d-block">{{ get_niveau_nom_court('impact', i) }}</small>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                    <input type="hidden" name="impact_pre" id="impactInput" 
                                                           value="{{ evaluation_en_cours.impact_pre if evaluation_en_cours }}" required>
                                                    <div class="form-text text-center mt-2" id="impactDescription">
                                                        {% if evaluation_en_cours and evaluation_en_cours.impact_pre %}
                                                            {{ get_niveau_description('impact', evaluation_en_cours.impact_pre) }}
                                                        {% else %}
                                                            Sélectionnez le niveau d'impact
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Probabilité -->
                                    <div class="col-md-4">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-header" style="background-color: {{ get_niveau_couleur('phase', 'phase2') or '#ffc107' }}; color: {% if get_niveau_couleur('phase', 'phase2') and get_niveau_couleur('phase', 'phase2')|length > 7 and get_niveau_couleur('phase', 'phase2')|slice(1,3)|int(base=16)*0.299 + get_niveau_couleur('phase', 'phase2')|slice(3,5)|int(base=16)*0.587 + get_niveau_couleur('phase', 'phase2')|slice(5,7)|int(base=16)*0.114 > 186 %}black{% else %}white{% endif %};">
                                                <h6 class="mb-0"><i class="fas fa-chart-line me-2"></i>Probabilité</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="barometre-container">
                                                    <div class="barometre-echelles-horizontal">
                                                        {% for i in range(1, 6) %}
                                                        <div class="echelle-item-horizontal {% if evaluation_en_cours and evaluation_en_cours.probabilite_pre == i %}active{% endif %}" 
                                                             data-value="{{ i }}" data-type="probabilite">
                                                            <div class="echelle-niveau-horizontal" 
                                                                 style="background-color: {{ get_niveau_couleur('probabilite', i) }};"></div>
                                                            <div class="echelle-label-horizontal">
                                                                <strong>{{ i }}</strong>
                                                                <small class="d-block">{{ get_niveau_nom_court('probabilite', i) }}</small>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                    <input type="hidden" name="probabilite_pre" id="probabiliteInput" 
                                                           value="{{ evaluation_en_cours.probabilite_pre if evaluation_en_cours }}" required>
                                                    <div class="form-text text-center mt-2" id="probabiliteDescription">
                                                        {% if evaluation_en_cours and evaluation_en_cours.probabilite_pre %}
                                                            {{ get_niveau_description('probabilite', evaluation_en_cours.probabilite_pre) }}
                                                        {% else %}
                                                            Sélectionnez la probabilité
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Niveau de Maîtrise -->
                                    <div class="col-md-4">
                                        <div class="card border-0 shadow-sm h-100">
                                            <div class="card-header" style="background-color: {{ get_niveau_couleur('phase', 'phase3') or '#28a745' }}; color: white;">
                                                <h6 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Maîtrise</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="barometre-container">
                                                    <div class="barometre-echelles-horizontal">
                                                        {% for i in range(1, 6) %}
                                                        {% set maitrise_order = 6 - i if get_parametres_evaluation().get('maitrise_inverse', True) else i %}
                                                        <div class="echelle-item-horizontal {% if evaluation_en_cours and evaluation_en_cours.niveau_maitrise_pre == i %}active{% endif %}" 
                                                             data-value="{{ i }}" data-type="maitrise">
                                                            <div class="echelle-niveau-horizontal" 
                                                                 style="background-color: {{ get_niveau_couleur('maitrise', maitrise_order) }};"></div>
                                                            <div class="echelle-label-horizontal">
                                                                <strong>{{ i }}</strong>
                                                                <small class="d-block">{{ get_niveau_nom_court('maitrise', i) }}</small>
                                                            </div>
                                                        </div>
                                                        {% endfor %}
                                                    </div>
                                                    <!-- Correction pour l'input maitrise -->
                                                    <input type="hidden" name="niveau_maitrise_pre" id="maitriseInput" 
                                                    value="{{ evaluation_en_cours.niveau_maitrise_pre if evaluation_en_cours and evaluation_en_cours.niveau_maitrise_pre else 3 }}">
                                                    <div class="form-text text-center mt-2" id="maitriseDescription">
                                                        {% if evaluation_en_cours and evaluation_en_cours.niveau_maitrise_pre %}
                                                            {{ get_niveau_description('maitrise', evaluation_en_cours.niveau_maitrise_pre) }}
                                                        {% else %}
                                                            Niveau de contrôle existant
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">Référent Pré-évaluation</label>
                                            <select class="form-select" name="referent_pre_evaluation_id">
                                                <option value="0">Sélectionnez un référent...</option>
                                                {% for user in referents %}
                                                <option value="{{ user.id }}" {% if evaluation_en_cours and evaluation_en_cours.referent_pre_evaluation_id == user.id %}selected{% endif %}>
                                                    {{ user.username }} - {{ user.role }}
                                                </option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">Score Calculé</label>
                                            <div class="card bg-light">
                                                <div class="card-body text-center py-3">
                                                    <div class="h2 mb-1" id="scoreAffiche">0</div>
                                                    <div class="badge fs-6" id="niveauAffiche">Non évalué</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Commentaire Pré-évaluation</label>
                                    <textarea class="form-control" name="commentaire_pre_evaluation" rows="3" placeholder="Observations, justifications, éléments contextuels...">{{ evaluation_en_cours.commentaire_pre_evaluation if evaluation_en_cours }}</textarea>
                                </div>

                                <!-- Résultat calculé -->
                                <div class="card bg-light mb-4" id="resultatPhase1" style="display: none;">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Résultat de la Pré-évaluation</h5>
                                        <div class="row">
                                            <div class="col-md-4">
                                                <div class="fw-bold">Score Calculé</div>
                                                <div class="h3" id="scoreCalculé">0</div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="fw-bold">Niveau de Risque</div>
                                                <div class="h3"><span class="badge" id="niveauRisque">-</span></div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="fw-bold">Position Matrice</div>
                                                <div id="positionMatrice">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <div>
                                        {% if evaluation_en_cours and evaluation_en_cours.date_pre_evaluation %}
                                        <small class="text-muted">
                                            Dernière pré-évaluation: {{ evaluation_en_cours.date_pre_evaluation.strftime('%d/%m/%Y à %H:%M') }}
                                            {% if evaluation_en_cours.referent_pre_evaluation %}
                                            par {{ evaluation_en_cours.referent_pre_evaluation.username }}
                                            {% endif %}
                                        </small>
                                        {% endif %}
                                    </div>
                                    <button type="submit" name="submit_phase" value="phase1" class="btn btn-primary btn-lg">
                                        <i class="fas fa-save me-2"></i>Enregistrer la Pré-évaluation
                                    </button>
                                </div>
                            </form>
                        </div>

                        <!-- PHASE 2 - Validation -->
                        <div class="tab-pane fade" id="phase2" role="tabpanel">
                            <form method="POST" id="phase2Form">
                                {{ form.csrf_token }}
                                <input type="hidden" name="phase" value="2">
                                
                                {% if evaluation_en_cours and evaluation_en_cours.date_pre_evaluation %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Pré-évaluation réalisée le {{ evaluation_en_cours.date_pre_evaluation.strftime('%d/%m/%Y') }}
                                    {% if evaluation_en_cours.referent_pre_evaluation %}
                                    par {{ evaluation_en_cours.referent_pre_evaluation.username }}
                                    {% endif %}
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Pré-évaluation</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row text-center">
                                                    <div class="col-4">
                                                        <small>Impact</small>
                                                        <div class="h5">{{ evaluation_en_cours.impact_pre }}/5</div>
                                                    </div>
                                                    <div class="col-4">
                                                        <small>Probabilité</small>
                                                        <div class="h5">{{ evaluation_en_cours.probabilite_pre }}/5</div>
                                                    </div>
                                                    <div class="col-4">
                                                        <small>Score</small>
                                                        <div class="h5">{{ evaluation_en_cours.impact_pre * evaluation_en_cours.probabilite_pre }}</div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Validation</h6>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label small">Impact ajusté</label>
                                                        <select class="form-select form-select-sm" name="impact_val" onchange="calculerScorePhase2()">
                                                            <option value="0">Identique</option>
                                                            {% for i in range(1, 6) %}
                                                            <option value="{{ i }}" {% if evaluation_en_cours.impact_val == i %}selected{% endif %}>{{ i }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small">Probabilité ajustée</label>
                                                        <select class="form-select form-select-sm" name="probabilite_val" onchange="calculerScorePhase2()">
                                                            <option value="0">Identique</option>
                                                            {% for i in range(1, 6) %}
                                                            <option value="{{ i }}" {% if evaluation_en_cours.probabilite_val == i %}selected{% endif %}>{{ i }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">Niveau de Maîtrise ajusté</label>
                                            <select class="form-select" name="niveau_maitrise_val">
                                                <option value="0">Identique</option>
                                                {% for i in range(1, 6) %}
                                                <option value="{{ i }}" {% if evaluation_en_cours.niveau_maitrise_val == i %}selected{% endif %}>{{ i }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">Statut de Validation</label>
                                            <select class="form-select" name="statut_validation" required>
                                                <option value="en_attente" {% if evaluation_en_cours.statut_validation == 'en_attente' %}selected{% endif %}>En attente</option>
                                                <option value="valide" {% if evaluation_en_cours.statut_validation == 'valide' %}selected{% endif %}>Validé</option>
                                                <option value="a_revoir" {% if evaluation_en_cours.statut_validation == 'a_revoir' %}selected{% endif %}>À revoir</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Commentaire Validation</label>
                                    <textarea class="form-control" name="commentaire_validation" rows="3" placeholder="Justification des ajustements, analyse complémentaire...">{{ evaluation_en_cours.commentaire_validation if evaluation_en_cours }}</textarea>
                                </div>

                                <!-- Résultat Phase 2 -->
                                <div class="card bg-warning bg-opacity-10 mb-4" id="resultatPhase2">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">Résultat Final de Validation</h5>
                                        <div class="row">
                                            <div class="col-md-3">
                                                <div class="fw-bold">Impact Final</div>
                                                <div class="h4" id="impactFinal2">-</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="fw-bold">Probabilité Finale</div>
                                                <div class="h4" id="probabiliteFinale2">-</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="fw-bold">Score Final</div>
                                                <div class="h4" id="scoreFinal2">-</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="fw-bold">Niveau Final</div>
                                                <div class="h4"><span class="badge" id="niveauFinal2">-</span></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <div>
                                        {% if evaluation_en_cours and evaluation_en_cours.date_validation %}
                                        <small class="text-muted">
                                            Dernière validation: {{ evaluation_en_cours.date_validation.strftime('%d/%m/%Y à %H:%M') }}
                                            {% if evaluation_en_cours.validateur %}
                                            par {{ evaluation_en_cours.validateur.username }}
                                            {% endif %}
                                        </small>
                                        {% endif %}
                                    </div>
                                    <button type="submit" name="submit_phase" value="phase2" class="btn btn-warning btn-lg">
                                        <i class="fas fa-check-double me-2"></i>Valider l'Évaluation
                                    </button>
                                </div>

                                {% else %}
                                <div class="alert alert-warning text-center">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    La Phase 1 (Pré-évaluation) doit être complétée avant de pouvoir valider.
                                </div>
                                {% endif %}
                            </form>
                        </div>

                        <!-- PHASE 3 - Confirmation -->
                        <div class="tab-pane fade" id="phase3" role="tabpanel">
                            <form method="POST" id="phase3Form">
                                {{ form.csrf_token }}
                                <input type="hidden" name="phase" value="3">
                                
                                {% if evaluation_en_cours and evaluation_en_cours.date_validation %}
                                <div class="alert alert-success">
                                    <i class="fas fa-check-circle me-2"></i>
                                    Évaluation validée le {{ evaluation_en_cours.date_validation.strftime('%d/%m/%Y') }}
                                    {% if evaluation_en_cours.validateur %}
                                    par {{ evaluation_en_cours.validateur.username }}
                                    {% endif %}
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header bg-light">
                                                <h6 class="mb-0">Pré-évaluation</h6>
                                            </div>
                                            <div class="card-body text-center">
                                                <div class="h6">{{ evaluation_en_cours.impact_pre }} × {{ evaluation_en_cours.probabilite_pre }}</div>
                                                <small class="text-muted">Score: {{ evaluation_en_cours.impact_pre * evaluation_en_cours.probabilite_pre }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card">
                                            <div class="card-header bg-warning bg-opacity-25">
                                                <h6 class="mb-0">Validation</h6>
                                            </div>
                                            <div class="card-body text-center">
                                                {% set impact_val = evaluation_en_cours.impact_val or evaluation_en_cours.impact_pre %}
                                                {% set prob_val = evaluation_en_cours.probabilite_val or evaluation_en_cours.probabilite_pre %}
                                                <div class="h6">{{ impact_val }} × {{ prob_val }}</div>
                                                <small class="text-muted">Score: {{ impact_val * prob_val }}</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card border-primary">
                                            <div class="card-header bg-primary bg-opacity-10">
                                                <h6 class="mb-0 text-primary">Confirmation Finale</h6>
                                            </div>
                                            <div class="card-body text-center">
                                                <div class="row">
                                                    <div class="col-6">
                                                        <label class="form-label small">Impact</label>
                                                        <select class="form-select form-select-sm" name="impact_conf" onchange="calculerScorePhase3()">
                                                            <option value="0">Identique</option>
                                                            {% for i in range(1, 6) %}
                                                            <option value="{{ i }}" {% if evaluation_en_cours.impact_conf == i %}selected{% endif %}>{{ i }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-6">
                                                        <label class="form-label small">Probabilité</label>
                                                        <select class="form-select form-select-sm" name="probabilite_conf" onchange="calculerScorePhase3()">
                                                            <option value="0">Identique</option>
                                                            {% for i in range(1, 6) %}
                                                            <option value="{{ i }}" {% if evaluation_en_cours.probabilite_conf == i %}selected{% endif %}>{{ i }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">Niveau de Maîtrise final</label>
                                            <select class="form-select" name="niveau_maitrise_conf">
                                                <option value="0">Identique</option>
                                                {% for i in range(1, 6) %}
                                                <option value="{{ i }}" {% if evaluation_en_cours.niveau_maitrise_conf == i %}selected{% endif %}>{{ i }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-4">
                                            <label class="form-label fw-bold">Campagne d'évaluation</label>
                                            <input type="text" class="form-control" name="campagne_nom" value="{{ evaluation_en_cours.campagne_nom or '' }}" placeholder="Nom de la campagne...">
                                        </div>
                                    </div>
                                </div>

                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Date de début</label>
                                        <input type="date" class="form-control" name="campagne_date_debut" value="{{ evaluation_en_cours.campagne_date_debut or '' }}">
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label fw-bold">Date de fin</label>
                                        <input type="date" class="form-control" name="campagne_date_fin" value="{{ evaluation_en_cours.campagne_date_fin or '' }}">
                                    </div>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Objectif de la campagne</label>
                                    <textarea class="form-control" name="campagne_objectif" rows="2" placeholder="Objectifs spécifiques, périmètre...">{{ evaluation_en_cours.campagne_objectif or '' }}</textarea>
                                </div>

                                <div class="mb-4">
                                    <label class="form-label fw-bold">Commentaire Final</label>
                                    <textarea class="form-control" name="commentaire_confirmation" rows="3" placeholder="Synthèse et recommandations finales...">{{ evaluation_en_cours.commentaire_confirmation if evaluation_en_cours }}</textarea>
                                </div>

                                <!-- Résultat Final -->
                                <div class="card border-primary mb-4" id="resultatPhase3">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fas fa-flag me-2"></i>Résultat Final de l'Évaluation</h5>
                                    </div>
                                    <div class="card-body text-center">
                                        <div class="row">
                                            <div class="col-md-2">
                                                <div class="fw-bold">Impact</div>
                                                <div class="h3 text-primary" id="impactFinal3">-</div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="fw-bold">Probabilité</div>
                                                <div class="h3 text-primary" id="probabiliteFinale3">-</div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="fw-bold">Score</div>
                                                <div class="h3 text-primary" id="scoreFinal3">-</div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="fw-bold">Niveau de Risque</div>
                                                <div class="h3"><span class="badge bg-primary" id="niveauFinal3">-</span></div>
                                            </div>
                                            <div class="col-md-3">
                                                <div class="fw-bold">Position Matrice</div>
                                                <div class="h5" id="positionFinale">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex justify-content-between">
                                    <div>
                                        {% if evaluation_en_cours and evaluation_en_cours.date_confirmation %}
                                        <small class="text-muted">
                                            Dernière confirmation: {{ evaluation_en_cours.date_confirmation.strftime('%d/%m/%Y à %H:%M') }}
                                            {% if evaluation_en_cours.evaluateur_final %}
                                            par {{ evaluation_en_cours.evaluateur_final.username }}
                                            {% endif %}
                                        </small>
                                        {% endif %}
                                    </div>
                                    <button type="submit" name="submit_phase" value="phase3" class="btn btn-success btn-lg">
                                        <i class="fas fa-flag-checkered me-2"></i>Confirmer l'Évaluation Finale
                                    </button>
                                </div>

                                {% else %}
                                <div class="alert alert-warning text-center">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    La Phase 2 (Validation) doit être complétée avant confirmation finale.
                                </div>
                                {% endif %}
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Colonne latérale - Informations et visualisations -->
        <div class="col-lg-4">
            <!-- Carte du risque -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Fiche du Risque</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Référence</strong>
                        <span class="h6">{{ risque.reference }}</span>
                    </div>
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Intitulé</strong>
                        <span>{{ risque.intitule }}</span>
                    </div>
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Catégorie</strong>
                        <span class="badge bg-secondary">{{ risque.categorie }}</span>
                    </div>
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Processus</strong>
                        <span>{{ risque.processus_concerne or 'Non spécifié' }}</span>
                    </div>
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Cartographie</strong>
                        <span>{{ risque.cartographie.nom }}</span>
                    </div>
                    
                    <hr>
                    
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Statut Évaluation</strong>
                        {% if phase_actuelle == 'termine' %}
                        <span class="badge bg-success">Terminée</span>
                        {% elif phase_actuelle == 'phase3' %}
                        <span class="badge bg-warning">En confirmation</span>
                        {% elif phase_actuelle == 'phase2' %}
                        <span class="badge bg-info">En validation</span>
                        {% else %}
                        <span class="badge bg-secondary">En pré-évaluation</span>
                        {% endif %}
                    </div>

                    {% if evaluation_en_cours and evaluation_en_cours.niveau_risque %}
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Niveau Actuel</strong>
                        {% set niveau = evaluation_en_cours.niveau_risque %}
                        {% if niveau == 'Critique' %}
                        <span class="badge bg-danger">{{ niveau }}</span>
                        {% elif niveau == 'Élevé' %}
                        <span class="badge bg-warning">{{ niveau }}</span>
                        {% elif niveau == 'Moyen' %}
                        <span class="badge bg-info">{{ niveau }}</span>
                        {% else %}
                        <span class="badge bg-success">{{ niveau }}</span>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Visualisation Matrice -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-chart-network me-2"></i>Position Matrice</h5>
                </div>
                <div class="card-body text-center">
                    {% if evaluation_en_cours %}
                        {% set impact_final = evaluation_en_cours.impact_conf or evaluation_en_cours.impact_val or evaluation_en_cours.impact_pre %}
                        {% set probabilite_final = evaluation_en_cours.probabilite_conf or evaluation_en_cours.probabilite_val or evaluation_en_cours.probabilite_pre %}
                        {% set score_final = impact_final * probabilite_final if impact_final and probabilite_final else 0 %}
                        
                        <div id="miniMatrice" class="mb-3">
                            <canvas id="matriceCanvas" width="200" height="200" style="max-width: 100%;"></canvas>
                        </div>
                        <div class="small text-muted">
                            Score: <strong id="positionScore">{{ score_final }}</strong> | 
                            Impact: <strong id="positionImpact">{{ impact_final }}</strong> | 
                            Probabilité: <strong id="positionProbabilite">{{ probabilite_final }}</strong>
                            {% if evaluation_en_cours.impact_conf or evaluation_en_cours.probabilite_conf %}
                            <br><span class="text-success">✓ Résultat final confirmé</span>
                            {% elif evaluation_en_cours.impact_val or evaluation_en_cours.probabilite_val %}
                            <br><span class="text-warning">↳ Résultat validé</span>
                            {% else %}
                            <br><span class="text-info">↲ Pré-évaluation</span>
                            {% endif %}
                        </div>
                    {% else %}
                        <div class="text-muted">
                            <i class="fas fa-chart-bar fa-2x mb-2"></i>
                            <p class="mb-0">Completez l'évaluation pour voir la position dans la matrice</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- KRI Associé -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>KRI Associé</h5>
                </div>
                <div class="card-body">
                    {% if risque.kri %}
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Indicateur</strong>
                        <span>{{ risque.kri.nom }}</span>
                    </div>
                    <div class="mb-3">
                        <strong class="d-block text-muted small">Dernière mesure</strong>
                        {% if risque.kri.mesures %}
                        {% set derniere_mesure = risque.kri.mesures|sort(attribute='date_mesure', reverse=true)|first %}
                        <span class="h5">{{ derniere_mesure.valeur }} {{ risque.kri.unite_mesure }}</span>
                        <small class="text-muted d-block">{{ derniere_mesure.date_mesure.strftime('%d/%m/%Y') }}</small>
                        {% else %}
                        <span class="text-muted">Aucune mesure</span>
                        {% endif %}
                    </div>
                    <a href="{{ url_for('liste_kri') }}" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-external-link-alt me-1"></i>Voir le KRI
                    </a>
                    {% else %}
                    <div class="text-center text-muted">
                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                        <p class="mb-3">Aucun KRI associé à ce risque</p>
                        <a href="{{ url_for('nouveau_kri', risque_id=risque.id) }}" class="btn btn-primary btn-sm">
                            <i class="fas fa-plus me-1"></i>Créer un KRI
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Guide Élargi - VERSION DYNAMIQUE -->
<div class="modal fade" id="guideModal" tabindex="-1" aria-labelledby="guideModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="guideModalLabel">
                    <i class="fas fa-book me-2"></i>Guide d'Évaluation Triphase - Référentiel Complet
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Phases d'évaluation -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="card border-primary mb-3">
                            <div class="card-header bg-primary text-white">
                                <h6 class="mb-0">Phase 1 - Pré-évaluation</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Objectif:</strong> Identification initiale du risque</p>
                                <p><strong>Acteur:</strong> Référent métier</p>
                                <p><strong>Livrable:</strong> Score préliminaire</p>
                                <p><strong>Critères:</strong> 
                                    <br>• Impact potentiel
                                    <br>• Probabilité d'occurrence  
                                    <br>• Niveau de maîtrise existant
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-warning mb-3">
                            <div class="card-header bg-warning text-dark">
                                <h6 class="mb-0">Phase 2 - Validation</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Objectif:</strong> Validation et ajustement</p>
                                <p><strong>Acteur:</strong> Comité de validation</p>
                                <p><strong>Livrable:</strong> Score validé</p>
                                <p><strong>Vérifications:</strong>
                                    <br>• Cohérence des évaluations
                                    <br>• Justification des écarts
                                    <br>• Validation collégiale
                                </p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card border-success mb-3">
                            <div class="card-header bg-success text-white">
                                <h6 class="mb-0">Phase 3 - Confirmation</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>Objectif:</strong> Finalisation et reporting</p>
                                <p><strong>Acteur:</strong> Évaluateur final</p>
                                <p><strong>Livrable:</strong> Score définitif</p>
                                <p><strong>Éléments:</strong>
                                    <br>• Consolidation finale
                                    <br>• Documentation complète
                                    <br>• Intégration reporting
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Guide détaillé des échelles d'évaluation -->
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="border-bottom pb-2">Échelles d'Évaluation Détaillées</h6>
                    </div>
                    
                    <!-- Échelle d'Impact -->
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header bg-primary text-white py-2">
                                <h6 class="mb-0">Impact Potentiel</h6>
                            </div>
                            <div class="card-body">
                                {% for i in range(1, 6) %}
                                <div class="echelle-item active mb-2">
                                    <div class="echelle-niveau" style="background-color: {{ get_niveau_couleur('impact', i) }};"></div>
                                    <div class="echelle-label"><strong>{{ i }} - {{ get_niveau_nom_court('impact', i) }}</strong></div>
                                </div>
                                <small>{{ get_niveau_description('impact', i) }}</small>
                                {% if not loop.last %}<hr class="my-2">{% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Échelle de Probabilité -->
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header bg-warning text-dark py-2">
                                <h6 class="mb-0">Probabilité d'Occurrence</h6>
                            </div>
                            <div class="card-body">
                                {% for i in range(1, 6) %}
                                <div class="echelle-item active mb-2">
                                    <div class="echelle-niveau" style="background-color: {{ get_niveau_couleur('probabilite', i) }};"></div>
                                    <div class="echelle-label"><strong>{{ i }} - {{ get_niveau_nom_court('probabilite', i) }}</strong></div>
                                </div>
                                <small>{{ get_niveau_description('probabilite', i) }}</small>
                                {% if not loop.last %}<hr class="my-2">{% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Échelle de Maîtrise -->
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-header bg-success text-white py-2">
                                <h6 class="mb-0">Niveau de Maîtrise</h6>
                            </div>
                            <div class="card-body">
                                {% for i in range(1, 6) %}
                                <div class="echelle-item active mb-2">
                                    <div class="echelle-niveau" style="background-color: {{ get_niveau_couleur('maitrise', i) }};"></div>
                                    <div class="echelle-label"><strong>{{ i }} - {{ get_niveau_nom_court('maitrise', i) }}</strong></div>
                                </div>
                                <small>{{ get_niveau_description('maitrise', i) }}</small>
                                {% if not loop.last %}<hr class="my-2">{% endif %}
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Matrice des risques -->
                <h6 class="mt-4 border-bottom pb-2">Matrice des Risques - Interprétation des Scores</h6>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr>
                                <th>Score</th>
                                <th>Niveau</th>
                                <th>Couleur</th>
                                <th>Interprétation</th>
                                <th>Actions Recommandées</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>1-4</td>
                                <td>Faible</td>
                                <td><span class="badge bg-success">Vert</span></td>
                                <td>Risque acceptable - Impact limité</td>
                                <td>Surveillance standard - Documentation</td>
                            </tr>
                            <tr>
                                <td>5-10</td>
                                <td>Moyen</td>
                                <td><span class="badge bg-warning">Jaune</span></td>
                                <td>Risque modéré - Surveillance nécessaire</td>
                                <td>Surveillance renforcée - Plan d'action recommandé</td>
                            </tr>
                            <tr>
                                <td>11-16</td>
                                <td>Élevé</td>
                                <td><span class="badge" style="background-color: #ff8c00; color: white;">Orange</span></td>
                                <td>Risque significatif - Action corrective requise</td>
                                <td>Actions correctives immédiates - Plan de traitement</td>
                            </tr>
                            <tr>
                                <td>17-25</td>
                                <td>Critique</td>
                                <td><span class="badge bg-danger">Rouge</span></td>
                                <td>Risque inacceptable - Traitement urgent</td>
                                <td>Actions immédiates - Escalade direction - Plan d'urgence</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Conseils d'évaluation -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Conseils pour une Évaluation de Qualité</h6>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>Bonnes Pratiques</h6>
                                        <ul class="small">
                                            <li>Utiliser des données objectives et vérifiables</li>
                                            <li>Considérer le contexte métier spécifique</li>
                                            <li>Documenter les hypothèses et justifications</li>
                                            <li>Impliquer les parties prenantes concernées</li>
                                            <li>Actualiser régulièrement les évaluations</li>
                                        </ul>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>Pièges à Éviter</h6>
                                        <ul class="small">
                                            <li>Subjectivité excessive dans l'évaluation</li>
                                            <li>Ignorer les contrôles existants</li>
                                            <li>Sur-estimation systématique</li>
                                            <li>Manque de cohérence entre évaluateurs</li>
                                            <li>Oubli des risques émergents</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                <button type="button" class="btn btn-primary" onclick="imprimerGuide()">
                    <i class="fas fa-print me-2"></i>Imprimer le Guide
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Données des descriptions détaillées - CHARGÉES DYNAMIQUEMENT
const impactDescriptions = {
    {% for i in range(1, 6) %}
    {{ i }}: "{{ get_niveau_description('impact', i)|replace('"', '\\"')|safe }}",
    {% endfor %}
};

const probabiliteDescriptions = {
    {% for i in range(1, 6) %}
    {{ i }}: "{{ get_niveau_description('probabilite', i)|replace('"', '\\"')|safe }}",
    {% endfor %}
};

const maitriseDescriptions = {
    {% for i in range(1, 6) %}
    {{ i }}: "{{ get_niveau_description('maitrise', i)|replace('"', '\\"')|safe }}",
    {% endfor %}
};

// Initialisation du baromètre
document.addEventListener('DOMContentLoaded', function() {
    initialiserBarometre();
    
    // FORCER l'utilisation des valeurs FINALES dès le chargement
    setTimeout(() => {
        calculerScorePhase1();
        calculerScorePhase2(); 
        calculerScorePhase3();
        dessinerMiniMatrice();
        
        // Restaurer les valeurs si elles existent
        restaurerValeursBarometre();
    }, 100);
});

function initialiserBarometre() {
    // Initialiser tous les baromètres horizontaux
    document.querySelectorAll('.barometre-echelles-horizontal').forEach(barometre => {
        barometre.addEventListener('click', function(e) {
            const echelleItem = e.target.closest('.echelle-item-horizontal');
            if (echelleItem) {
                const valeur = echelleItem.getAttribute('data-value');
                const type = echelleItem.getAttribute('data-type');
                
                selectionnerEchelle(type, valeur, echelleItem);
                calculerScorePhase1();
            }
        });
    });
}

function selectionnerEchelle(type, valeur, element) {
    // Retirer la classe active de tous les éléments du même type dans le même conteneur
    const parent = element.closest('.barometre-echelles-horizontal');
    const elements = parent.querySelectorAll(`.echelle-item-horizontal[data-type="${type}"]`);
    elements.forEach(el => el.classList.remove('active'));
    
    // Activer l'élément sélectionné
    element.classList.add('active');
    
    // Mettre à jour l'input caché
    const inputId = `${type}Input`;
    document.getElementById(inputId).value = valeur;
    
    // Mettre à jour la description
    const descriptionId = `${type}Description`;
    let description = '';
    
    switch(type) {
        case 'impact':
            description = impactDescriptions[valeur] || '';
            break;
        case 'probabilite':
            description = probabiliteDescriptions[valeur] || '';
            break;
        case 'maitrise':
            description = maitriseDescriptions[valeur] || '';
            break;
    }
    
    document.getElementById(descriptionId).textContent = description;
}

function restaurerValeursBarometre() {
    // Restaurer les valeurs depuis les inputs cachés
    const types = ['impact', 'probabilite', 'maitrise'];
    
    types.forEach(type => {
        const input = document.getElementById(`${type}Input`);
        if (input && input.value) {
            const element = document.querySelector(`.echelle-item-horizontal[data-type="${type}"][data-value="${input.value}"]`);
            if (element) {
                selectionnerEchelle(type, input.value, element);
            }
        }
    });
}

// Fonction pour changer de risque
function changerRisque() {
    const select = document.getElementById('selectRisque');
    const selectedOption = select.options[select.selectedIndex];
    const risqueId = select.value;
    const isArchived = selectedOption.getAttribute('data-archived') === 'true';
    
    if (!isArchived) {
        window.location.href = `/risque/${risqueId}/evaluation-triphase`;
    } else {
        alert('Ce risque est archivé. Veuillez sélectionner un risque actif.');
        select.value = '{{ risque.id }}'; // Revenir à la valeur précédente
    }
}

// 1. Mettre à jour la fonction calculerScorePhase1() pour utiliser les valeurs finales
function calculerScorePhase1() {
    // Récupérer les valeurs FINALES (priorité: confirmation > validation > pré-évaluation)
    let impactFinal, probabiliteFinale;
    
    {% if evaluation_en_cours %}
        // PRIORITÉ : Confirmation > Validation > Pré-évaluation
        impactFinal = {{ evaluation_en_cours.impact_conf or evaluation_en_cours.impact_val or evaluation_en_cours.impact_pre or 0 }};
        probabiliteFinale = {{ evaluation_en_cours.probabilite_conf or evaluation_en_cours.probabilite_val or evaluation_en_cours.probabilite_pre or 0 }};
    {% else %}
        impactFinal = parseInt(document.getElementById('impactInput').value) || 0;
        probabiliteFinale = parseInt(document.getElementById('probabiliteInput').value) || 0;
    {% endif %}
    
    if (impactFinal > 0 && probabiliteFinale > 0) {
        const score = impactFinal * probabiliteFinale;
        const niveau = calculerNiveauRisque(score);
        
        // Mettre à jour l'affichage du score
        document.getElementById('scoreAffiche').textContent = score;
        document.getElementById('niveauAffiche').textContent = niveau.nom;
        document.getElementById('niveauAffiche').className = `badge bg-${niveau.couleur} fs-6`;
        
        // Mettre à jour le résultat détaillé
        document.getElementById('scoreCalculé').textContent = score;
        document.getElementById('niveauRisque').textContent = niveau.nom;
        document.getElementById('niveauRisque').className = `badge bg-${niveau.couleur}`;
        document.getElementById('positionMatrice').textContent = `Impact ${impactFinal} / Probabilité ${probabiliteFinale}`;
        
        document.getElementById('resultatPhase1').style.display = 'block';
        dessinerMiniMatrice(impactFinal, probabiliteFinale, score);
        
        // Mettre à jour la position dans la colonne latérale
        document.getElementById('positionScore').textContent = score;
        document.getElementById('positionImpact').textContent = impactFinal;
        document.getElementById('positionProbabilite').textContent = probabiliteFinale;
    } else {
        document.getElementById('resultatPhase1').style.display = 'none';
        document.getElementById('scoreAffiche').textContent = '0';
        document.getElementById('niveauAffiche').textContent = 'Non évalué';
        document.getElementById('niveauAffiche').className = 'badge bg-secondary fs-6';
    }
}

// 6. Mettre à jour les fonctions de calcul des phases 2 et 3
function calculerScorePhase2() {
    // Toujours utiliser les valeurs FINALES pour le calcul
    {% if evaluation_en_cours %}
        const impactFinal = {{ evaluation_en_cours.impact_conf or evaluation_en_cours.impact_val or evaluation_en_cours.impact_pre or 0 }};
        const probabiliteFinale = {{ evaluation_en_cours.probabilite_conf or evaluation_en_cours.probabilite_val or evaluation_en_cours.probabilite_pre or 0 }};
    {% else %}
        const impactFinal = 0;
        const probabiliteFinale = 0;
    {% endif %}
    
    if (impactFinal > 0 && probabiliteFinale > 0) {
        const score = impactFinal * probabiliteFinale;
        const niveau = calculerNiveauRisque(score);
        
        document.getElementById('impactFinal2').textContent = impactFinal;
        document.getElementById('probabiliteFinale2').textContent = probabiliteFinale;
        document.getElementById('scoreFinal2').textContent = score;
        document.getElementById('niveauFinal2').textContent = niveau.nom;
        document.getElementById('niveauFinal2').className = `badge bg-${niveau.couleur}`;
        
        dessinerMiniMatrice(impactFinal, probabiliteFinale, score);
    }
}

function calculerScorePhase3() {
    // Toujours utiliser les valeurs FINALES pour le calcul
    {% if evaluation_en_cours %}
        const impactFinal = {{ evaluation_en_cours.impact_conf or evaluation_en_cours.impact_val or evaluation_en_cours.impact_pre or 0 }};
        const probabiliteFinale = {{ evaluation_en_cours.probabilite_conf or evaluation_en_cours.probabilite_val or evaluation_en_cours.probabilite_pre or 0 }};
    {% else %}
        const impactFinal = 0;
        const probabiliteFinale = 0;
    {% endif %}
    
    if (impactFinal > 0 && probabiliteFinale > 0) {
        const score = impactFinal * probabiliteFinale;
        const niveau = calculerNiveauRisque(score);
        
        document.getElementById('impactFinal3').textContent = impactFinal;
        document.getElementById('probabiliteFinale3').textContent = probabiliteFinale;
        document.getElementById('scoreFinal3').textContent = score;
        document.getElementById('niveauFinal3').textContent = niveau.nom;
        document.getElementById('niveauFinal3').className = `badge bg-${niveau.couleur}`;
        document.getElementById('positionFinale').textContent = `Impact ${impactFinal} / Probabilité ${probabiliteFinale}`;
        
        dessinerMiniMatrice(impactFinal, probabiliteFinale, score);
    }
}

function calculerNiveauRisque(score) {
    if (score <= 4) return { nom: 'Faible', couleur: 'success' };
    if (score <= 10) return { nom: 'Moyen', couleur: 'warning' };
    if (score <= 16) return { nom: 'Élevé', couleur: 'danger' };
    return { nom: 'Critique', couleur: 'dark' };
}

// 2. Mettre à jour la fonction dessinerMiniMatrice() pour utiliser les valeurs finales
function dessinerMiniMatrice(impact = 0, probabilite = 0, score = 0) {
    const canvas = document.getElementById('matriceCanvas');
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    const size = 200;
    const cellSize = size / 5;
    
    canvas.width = size;
    canvas.height = size;
    
    ctx.clearRect(0, 0, size, size);
    
    // Dessiner la grille de la matrice
    for (let i = 0; i < 5; i++) {
        for (let j = 0; j < 5; j++) {
            const scoreCell = (5 - i) * (j + 1); // Impact décroissant de 5 à 1, probabilité croissante de 1 à 5
            const couleur = getCouleurCellule(scoreCell);
            
            ctx.fillStyle = couleur;
            ctx.fillRect(j * cellSize, i * cellSize, cellSize, cellSize);
            
            ctx.strokeStyle = '#ddd';
            ctx.strokeRect(j * cellSize, i * cellSize, cellSize, cellSize);
            
            ctx.fillStyle = scoreCell > 12 ? 'white' : 'black';
            ctx.font = '10px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(
                scoreCell.toString(), 
                j * cellSize + cellSize / 2, 
                i * cellSize + cellSize / 2
            );
        }
    }
    
    // Positionner le risque sur la matrice avec les valeurs FINALES
    if (impact > 0 && probabilite > 0) {
        // Calcul des coordonnées : impact (5-1) correspond à lignes (0-4), probabilité (1-5) correspond à colonnes (0-4)
        const x = (probabilite - 1) * cellSize + cellSize / 2;
        const y = (5 - impact) * cellSize + cellSize / 2; // Inverser l'axe Y car impact 5 = ligne 0
        
        // Dessiner un marqueur rouge
        ctx.fillStyle = 'red';
        ctx.beginPath();
        ctx.arc(x, y, 6, 0, 2 * Math.PI);
        ctx.fill();
        
        // Contour blanc pour meilleure visibilité
        ctx.strokeStyle = 'white';
        ctx.lineWidth = 2;
        ctx.stroke();
        
        console.log(`📍 Position matrice: Impact ${impact}, Probabilité ${probabilite} → (${x}, ${y})`);
    }
}

function getCouleurCellule(score) {
    // Utiliser les couleurs paramétrées si disponibles
    {% set couleurs_matrise = session.get('couleurs_personnalisees', {}) %}
    if (score <= 4) return '{{ couleurs_matrise.get("matrice_faible", "#28a745") }}';
    if (score <= 10) return '{{ couleurs_matrise.get("matrice_moyen", "#ffc107") }}';  
    if (score <= 16) return '{{ couleurs_matrise.get("matrice_eleve", "#ff8c00") }}';
    return '{{ couleurs_matrise.get("matrice_critique", "#dc3545") }}';
}

// 5. Ajouter une fonction pour forcer le recalcul avec les valeurs finales
function forcerRecalculAvecValeursFinales() {
    {% if evaluation_en_cours %}
        // Récupérer les valeurs FINALES
        const impactFinal = {{ evaluation_en_cours.impact_conf or evaluation_en_cours.impact_val or evaluation_en_cours.impact_pre or 0 }};
        const probabiliteFinale = {{ evaluation_en_cours.probabilite_conf or evaluation_en_cours.probabilite_val or evaluation_en_cours.probabilite_pre or 0 }};
        
        if (impactFinal > 0 && probabiliteFinale > 0) {
            // Mettre à jour les inputs cachés avec les valeurs finales
            document.getElementById('impactInput').value = impactFinal;
            document.getElementById('probabiliteInput').value = probabiliteFinale;
            
            // Mettre à jour visuellement les baromètres
            const types = ['impact', 'probabilite'];
            types.forEach(type => {
                const element = document.querySelector(`.echelle-item-horizontal[data-type="${type}"][data-value="${type === 'impact' ? impactFinal : probabiliteFinale}"]`);
                if (element) {
                    const parent = element.closest('.barometre-echelles-horizontal');
                    const elements = parent.querySelectorAll(`.echelle-item-horizontal[data-type="${type}"]`);
                    elements.forEach(el => el.classList.remove('active'));
                    element.classList.add('active');
                }
            });
            
            // Recalculer et redessiner
            calculerScorePhase1();
            dessinerMiniMatrice(impactFinal, probabiliteFinale, impactFinal * probabiliteFinale);
        }
    {% endif %}
}

// Appeler cette fonction après chaque mise à jour
document.addEventListener('DOMContentLoaded', function() {
    // ... code existant ...
    
    // Forcer le recalcul avec les valeurs finales après un court délai
    setTimeout(forcerRecalculAvecValeursFinales, 200);
});

function imprimerGuide() {
    const modal = document.getElementById('guideModal');
    const modalContent = modal.querySelector('.modal-content').cloneNode(true);
    
    // Supprimer les boutons du footer
    const footer = modalContent.querySelector('.modal-footer');
    if (footer) footer.remove();
    
    // Ouvrir une nouvelle fenêtre pour l'impression
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Guide d'Évaluation Triphase</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .card { margin-bottom: 15px; border: 1px solid #ddd; border-radius: 5px; }
                .card-header { padding: 10px; font-weight: bold; }
                .table { width: 100%; margin-top: 15px; }
                .echelle-item { display: flex; align-items: center; margin-bottom: 8px; }
                .echelle-niveau { width: 20px; height: 20px; border-radius: 3px; margin-right: 10px; }
                @media print {
                    .card { break-inside: avoid; }
                }
            </style>
        </head>
        <body>
            <h1>Guide d'Évaluation Triphase - Référentiel Complet</h1>
            ${modalContent.innerHTML}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

// Gestion des onglets avec sauvegarde de l'état
document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('button[data-bs-toggle="pill"]');
    tabs.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            localStorage.setItem('activeEvaluationTab', event.target.id);
        });
    });
    
    const activeTabId = localStorage.getItem('activeEvaluationTab');
    if (activeTabId) {
        const activeTab = document.getElementById(activeTabId);
        if (activeTab) {
            const tab = new bootstrap.Tab(activeTab);
            tab.show();
        }
    }
});

// Validation des formulaires
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        if (submitBtn) {
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Traitement...';
        }
    });
});

function exporterEvaluationCourante() {
    const risqueRef = "{{ risque.reference }}";
    const risqueIntitule = "{{ risque.intitule }}";
    const dateExport = new Date().toLocaleDateString('fr-FR');
    
    const content = `
        <html>
        <head>
            <title>Évaluation ${risqueRef}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                .section { margin-bottom: 20px; }
                .badge { padding: 5px 10px; border-radius: 4px; color: white; font-weight: bold; }
                .badge-faible { background: #27ae60; }
                .badge-moyen { background: #f39c12; }
                .badge-eleve { background: #ff8c00; }
                .badge-critique { background: #e74c3c; }
            </style>
        </head>
        <body>
            <div class="header">
                <h1>ÉVALUATION TRIPHASÉE DU RISQUE</h1>
                <h2>${risqueRef} - ${risqueIntitule}</h2>
                <p>Export généré le ${dateExport}</p>
            </div>
            
            <div class="section">
                <h3>Résumé de l'Évaluation</h3>
                <!-- Données dynamiques à implémenter -->
            </div>
        </body>
        </html>
    `;
    
    const printWindow = window.open('', '_blank');
    printWindow.document.write(content);
    printWindow.document.close();
    printWindow.print();
}
</script>

<style>
/* Styles pour le baromètre HORIZONTAL */
.barometre-container {
    padding: 10px 0;
}

.barometre-echelles-horizontal {
    display: flex;
    justify-content: space-between;
    gap: 4px;
    margin-bottom: 10px;
}

.echelle-item-horizontal {
    flex: 1;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    padding: 8px 4px;
    border-radius: 6px;
    min-height: 100px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

.echelle-item-horizontal:hover {
    background-color: #f8f9fa;
    transform: translateY(-2px);
}

.echelle-item-horizontal.active {
    background-color: #e9ecef;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.echelle-niveau-horizontal {
    width: 100%;
    height: 24px;
    border-radius: 4px;
    margin-bottom: 6px;
    transition: all 0.3s ease;
}

.echelle-item-horizontal.active .echelle-niveau-horizontal {
    transform: scale(1.05);
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

.echelle-label-horizontal {
    font-size: 12px;
    font-weight: 600;
    color: #495057;
}

.echelle-label-horizontal small {
    display: block;
    font-size: 10px;
    font-weight: 400;
    color: #6c757d;
    margin-top: 4px;
}

/* Styles pour le guide */
.echelle-item {
    display: flex;
    align-items: center;
    margin-bottom: 8px;
}

.echelle-niveau {
    width: 20px;
    height: 20px;
    border-radius: 3px;
    margin-right: 10px;
}

.barometre-labels small {
    font-size: 10px;
    color: #6c757d;
    font-weight: 500;
}

/* Styles existants améliorés */
.nav-pills .nav-link {
    border-radius: 0.5rem;
    padding: 1rem 0.5rem;
    margin: 0 0.25rem;
    transition: all 0.3s ease;
}

.nav-pills .nav-link.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.nav-pills .nav-link:not(.active):hover {
    background-color: #f8f9fa;
    transform: translateY(-2px);
}

.card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.card:hover {
    transform: translateY(-2px);
}

#matriceCanvas {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
}

.alert {
    border: none;
    border-left: 4px solid;
}

.alert-info { border-left-color: #0dcaf0; }
.alert-warning { border-left-color: #ffc107; }
.alert-success { border-left-color: #198754; }

/* Responsive */
@media (max-width: 768px) {
    .barometre-echelles-horizontal {
        flex-direction: column;
        gap: 8px;
    }
    
    .echelle-item-horizontal {
        flex-direction: row;
        text-align: left;
        align-items: center;
        gap: 10px;
        min-height: auto;
        padding: 8px 12px;
    }
    
    .echelle-niveau-horizontal {
        width: 40px;
        height: 40px;
        margin-bottom: 0;
        border-radius: 50%;
    }
    
    .echelle-label-horizontal {
        text-align: left;
        flex: 1;
    }
}

@media (max-width: 992px) {
    .barometre-echelles-horizontal {
        flex-wrap: wrap;
    }
    
    .echelle-item-horizontal {
        min-width: 45%;
        margin-bottom: 10px;
    }
}
</style>
{% endblock %}
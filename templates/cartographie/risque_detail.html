{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-exclamation-triangle"></i> Fiche du Risque : {{ risque.reference }}
        {% for champ in champs_par_section.general if champ.nom_technique == 'priorite' and champ.get_valeur() == 'haute' %}
            <span class="badge bg-danger ms-2">Haute priorité</span>
        {% endfor %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('detail_cartographie', id=risque.cartographie_id) }}" class="btn btn-secondary me-2">
            <i class="fas fa-arrow-left"></i> Retour à la cartographie
        </a>
        <a href="{{ url_for('evaluer_risque_triphase', id=risque.id) }}" class="btn btn-primary me-2">
            <i class="fas fa-chart-bar"></i> Évaluer
        </a>
        {% if not risque.kri %}
        <a href="{{ url_for('nouveau_kri', risque_id=risque.id) }}" class="btn btn-success me-2">
            <i class="fas fa-chart-line"></i> Créer KRI
        </a>
        {% endif %}
        <a href="{{ url_for('modifier_risque', id=risque.id) }}" class="btn btn-outline-warning me-2">
            <i class="fas fa-edit"></i> Modifier
        </a>
        
        <!-- Bouton pour ajouter des éléments -->
        {% if current_user.has_permission('can_manage_risks') or risque.created_by == current_user.id %}
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-success dropdown-toggle" data-bs-toggle="dropdown">
                <i class="fas fa-plus"></i> Ajouter
            </button>
            <ul class="dropdown-menu">
                <li>
                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalAjoutChamp">
                        <i class="fas fa-tag me-2"></i>Champ personnalisé
                    </a>
                </li>
                <li>
                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#modalAjoutFichier">
                        <i class="fas fa-file-upload me-2"></i>Fichier
                    </a>
                </li>
                <li><hr class="dropdown-divider"></li>
                <li>
                    <form action="{{ url_for('nouvelle_evaluation_risque', id=risque.id) }}" method="post" class="d-inline">
                        <button type="submit" class="dropdown-item">
                            <i class="fas fa-redo me-2"></i>Nouvelle évaluation
                        </button>
                    </form>
                </li>
            </ul>
        </div>
        {% endif %}
    </div>
</div>

<!-- Formulaire de modification de référence -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <h6 class="mb-0"><i class="fas fa-tag me-2"></i>Référence du Risque</h6>
    </div>
    <div class="card-body">
        <form action="{{ url_for('modifier_reference_risque', id=risque.id) }}" method="post" class="row g-3 align-items-center">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="col-md-3">
                <label for="reference" class="form-label fw-bold">Référence :</label>
                <input type="text" class="form-control" id="reference" name="reference" 
                       value="{{ risque.reference }}" required maxlength="50" pattern="[A-Za-z0-9\-_]+"
                       title="Utilisez uniquement des lettres, chiffres, tirets et underscores">
            </div>
            <div class="col-md-6">
                <small class="text-muted">
                    <i class="fas fa-info-circle"></i> Cette référence sera affichée sur les matrices de risques. 
                    Utilisez un nom abrégé pour identifier facilement le risque (ex: RISQ-001, FIN-IMP, OP-SECUR).
                </small>
            </div>
            <div class="col-md-3">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-save me-1"></i>Modifier la référence
                </button>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <!-- Colonne de gauche - Informations générales et analyse -->
    <div class="col-md-6">
        <!-- Informations générales -->
        <div class="card shadow mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Informations Générales</h6>
                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#sectionGeneral" aria-expanded="true">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="card-body collapse show" id="sectionGeneral">
                <table class="table table-sm table-borderless">
                    <tr>
                        <th width="40%">Référence:</th>
                        <td><strong class="text-primary">{{ risque.reference }}</strong></td>
                    </tr>
                    <tr>
                        <th>Intitulé:</th>
                        <td>{{ risque.intitule }}</td>
                    </tr>
                    <tr>
                        <th>Description:</th>
                        <td>{{ risque.description or '<span class="text-muted">Non renseignée</span>'|safe }}</td>
                    </tr>
                    <tr>
                        <th>Catégorie:</th>
                        <td><span class="badge bg-secondary">{{ risque.categorie or 'Non classé' }}</span></td>
                    </tr>
                    <tr>
                        <th>Type de risque:</th>
                        <td>{{ risque.type_risque or '<span class="text-muted">Non spécifié</span>'|safe }}</td>
                    </tr>
                    <tr>
                        <th>Processus concerné:</th>
                        <td>{{ risque.processus_concerne or '<span class="text-muted">Non spécifié</span>'|safe }}</td>
                    </tr>
                    
                    <!-- Champs personnalisés de la section 'general' -->
                    {% for champ in champs_par_section.general %}
                    <tr>
                        <th>{{ champ.config.nom_affichage if champ.config else champ.nom_technique }}:</th>
                        <td>
                            {% if champ.config and champ.config.type_champ == 'checkbox' %}
                                {% if champ.get_valeur() %}
                                <span class="badge bg-success">Oui</span>
                                {% else %}
                                <span class="badge bg-secondary">Non</span>
                                {% endif %}
                            {% elif champ.config and champ.config.type_champ == 'select' %}
                                <span class="badge bg-info">{{ champ.get_valeur() }}</span>
                            {% elif champ.config and champ.config.type_champ == 'date' %}
                                {{ champ.get_valeur().strftime('%d/%m/%Y') if champ.get_valeur() else '<span class="text-muted">Non renseigné</span>'|safe }}
                            {% elif champ.config and champ.config.type_champ == 'fichier' and champ.get_valeur() %}
                                <a href="{{ url_for('telecharger_champ_fichier', champ_id=champ.id) }}" 
                                   class="text-decoration-none" target="_blank">
                                    <i class="fas fa-file me-1"></i>{{ champ.get_valeur() }}
                                </a>
                            {% elif champ.config and champ.config.type_champ == 'multiselect' %}
                                {% for valeur in champ.get_valeur() or [] %}
                                <span class="badge bg-primary me-1">{{ valeur }}</span>
                                {% endfor %}
                            {% else %}
                                {{ champ.get_valeur() or '<span class="text-muted">Non renseigné</span>'|safe }}
                            {% endif %}
                            
                            {% if current_user.has_permission('can_manage_risks') or risque.created_by == current_user.id %}
                            <button class="btn btn-sm btn-outline-warning float-end" 
                                    onclick="editerChamp({{ champ.id }})"
                                    title="Modifier ce champ">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    
                    <tr>
                        <th>Cartographie:</th>
                        <td>
                            <a href="{{ url_for('detail_cartographie', id=risque.cartographie_id) }}" class="text-decoration-none">
                                {{ risque.cartographie.nom }}
                            </a>
                        </td>
                    </tr>
                    <tr>
                        <th>Créé par:</th>
                        <td>{{ risque.createur.username }} le {{ risque.created_at.strftime('%d/%m/%Y à %H:%M') }}</td>
                    </tr>
                    {% if risque.updated_at and risque.updated_at != risque.created_at %}
                    <tr>
                        <th>Modifié le:</th>
                        <td>{{ risque.updated_at.strftime('%d/%m/%Y à %H:%M') }}</td>
                    </tr>
                    {% endif %}
                    {% if risque.is_archived %}
                    <tr class="table-warning">
                        <th>Statut:</th>
                        <td>
                            <span class="badge bg-warning">Archivé</span>
                            {% if risque.archive_reason %}
                            <br><small class="text-muted">Raison: {{ risque.archive_reason }}</small>
                            {% endif %}
                        </td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>

        <!-- Analyse du Risque -->
        <div class="card shadow mb-4">
            <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-search"></i> Analyse du Risque</h6>
                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#sectionAnalyse" aria-expanded="true">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="card-body collapse show" id="sectionAnalyse">
                <h6><i class="fas fa-bug me-1"></i>Cause racine:</h6>
                <div class="ps-3 border-start border-warning border-3 mb-3">
                    {{ risque.cause_racine or '<span class="text-muted">Non renseignée</span>'|safe }}
                </div>
                
                <h6><i class="fas fa-exclamation-circle me-1"></i>Conséquences:</h6>
                <div class="ps-3 border-start border-warning border-3 mb-3">
                    {{ risque.consequences or '<span class="text-muted">Non renseignées</span>'|safe }}
                </div>
                
                <!-- Champs personnalisés de la section 'analyse' -->
                {% for champ in champs_par_section.analyse %}
                <div class="mb-3">
                    <h6>
                        {{ champ.config.nom_affichage if champ.config else champ.nom_technique }}:
                        {% if champ.config and champ.config.est_obligatoire %}
                        <span class="text-danger">*</span>
                        {% endif %}
                    </h6>
                    <div class="ps-3 border-start border-warning border-3">
                        {% if champ.config and champ.config.type_champ == 'textarea' %}
                            {{ champ.get_valeur()|nl2br|safe }}
                        {% elif champ.config and champ.config.type_champ == 'multiselect' %}
                            {% for valeur in champ.get_valeur() or [] %}
                            <span class="badge bg-warning me-1">{{ valeur }}</span>
                            {% endfor %}
                        {% elif champ.config and champ.config.type_champ == 'checkbox' %}
                            {% if champ.get_valeur() %}
                            <span class="badge bg-success">Oui</span>
                            {% else %}
                            <span class="badge bg-secondary">Non</span>
                            {% endif %}
                        {% elif champ.config and champ.config.type_champ == 'select' %}
                            <span class="badge bg-warning">{{ champ.get_valeur() }}</span>
                        {% elif champ.config and champ.config.type_champ == 'fichier' and champ.get_valeur() %}
                            <a href="{{ url_for('telecharger_champ_fichier', champ_id=champ.id) }}" 
                               class="text-decoration-none" target="_blank">
                                <i class="fas fa-file me-1"></i>{{ champ.get_valeur() }}
                            </a>
                        {% else %}
                            {{ champ.get_valeur() or '<span class="text-muted">Non renseigné</span>'|safe }}
                        {% endif %}
                        
                        {% if current_user.has_permission('can_manage_risks') or risque.created_by == current_user.id %}
                        <button class="btn btn-sm btn-outline-warning float-end mt-2" 
                                onclick="editerChamp({{ champ.id }})"
                                title="Modifier ce champ">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% endif %}
                    </div>
                    {% if champ.config and champ.config.aide_texte %}
                    <small class="text-muted">{{ champ.config.aide_texte }}</small>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Champs personnalisés (autres sections) -->
        {% if champs_par_section.personnalise %}
        <div class="card shadow mb-4">
            <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-tags"></i> Informations complémentaires</h6>
                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#sectionPersonnalise" aria-expanded="true">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="card-body collapse show" id="sectionPersonnalise">
                <table class="table table-sm table-borderless">
                    {% for champ in champs_par_section.personnalise %}
                    <tr>
                        <th width="40%">{{ champ.config.nom_affichage if champ.config else champ.nom_technique }}:</th>
                        <td>
                            {% if champ.config and champ.config.type_champ == 'checkbox' %}
                                {% if champ.get_valeur() %}
                                <span class="badge bg-success">Oui</span>
                                {% else %}
                                <span class="badge bg-secondary">Non</span>
                                {% endif %}
                            {% elif champ.config and champ.config.type_champ == 'select' %}
                                <span class="badge bg-secondary">{{ champ.get_valeur() }}</span>
                            {% elif champ.config and champ.config.type_champ == 'date' %}
                                {{ champ.get_valeur().strftime('%d/%m/%Y') if champ.get_valeur() else '<span class="text-muted">Non renseigné</span>'|safe }}
                            {% elif champ.config and champ.config.type_champ == 'fichier' and champ.get_valeur() %}
                                <a href="{{ url_for('telecharger_champ_fichier', champ_id=champ.id) }}" 
                                   class="text-decoration-none" target="_blank">
                                    <i class="fas fa-file me-1"></i>{{ champ.get_valeur() }}
                                </a>
                            {% else %}
                                {{ champ.get_valeur() or '<span class="text-muted">Non renseigné</span>'|safe }}
                            {% endif %}
                            
                            {% if current_user.has_permission('can_manage_risks') or risque.created_by == current_user.id %}
                            <button class="btn btn-sm btn-outline-secondary float-end" 
                                    onclick="editerChamp({{ champ.id }})"
                                    title="Modifier ce champ">
                                <i class="fas fa-edit"></i>
                            </button>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Colonne de droite - Évaluations et KRI -->
    <div class="col-md-6">
        <!-- Dernière évaluation -->
        <div class="card shadow mb-4">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Dernière Évaluation</h6>
                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#sectionEvaluation" aria-expanded="true">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="card-body collapse show" id="sectionEvaluation">
                {% if derniere_evaluation %}
                    {% if impact_final and probabilite_final and impact_final > 0 and probabilite_final > 0 %}
                    <!-- Évaluation complète -->
                    <div class="row text-center mb-3">
                        <div class="col-md-4">
                            <div class="card border-primary">
                                <div class="card-body py-2">
                                    <h3 class="text-primary mb-0">{{ impact_final }}/5</h3>
                                    <small class="text-muted">Impact</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-warning">
                                <div class="card-body py-2">
                                    <h3 class="text-warning mb-0">{{ probabilite_final }}/5</h3>
                                    <small class="text-muted">Probabilité</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card border-success">
                                <div class="card-body py-2">
                                    <h3 class="text-success mb-0">{{ niveau_maitrise_final or 'N/A' }}/5</h3>
                                    <small class="text-muted">Maîtrise</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-center mb-3">
                        <h4 class="mb-2">Score global</h4>
                        {% if score_final and niveau_risque_final %}
                        <span class="badge bg-{% if niveau_risque_final == 'Critique' %}danger{% elif niveau_risque_final == 'Élevé' %}warning{% elif niveau_risque_final == 'Moyen' %}info{% else %}success{% endif %} fs-6 p-3">
                            {{ score_final }} - {{ niveau_risque_final }}
                        </span>
                        {% else %}
                        <span class="badge bg-secondary fs-6 p-3">Score non calculé</span>
                        {% endif %}
                    </div>
                    
                    <!-- Informations de campagne -->
                    {% if derniere_evaluation.campagne_nom %}
                    <div class="mt-3 p-3 bg-light rounded">
                        <strong>Campagne:</strong> {{ derniere_evaluation.campagne_nom }}
                        {% if derniere_evaluation.campagne_date_debut %}
                        <br><small class="text-muted">
                            Période: {{ derniere_evaluation.campagne_date_debut.strftime('%d/%m/%Y') }}
                            {% if derniere_evaluation.campagne_date_fin %}
                            au {{ derniere_evaluation.campagne_date_fin.strftime('%d/%m/%Y') }}
                            {% endif %}
                        </small>
                        {% endif %}
                    </div>
                    {% endif %}
                    
                    <!-- Commentaires -->
                    {% if derniere_evaluation.commentaire_confirmation %}
                    <div class="mt-3 p-3 bg-light rounded">
                        <strong>Commentaire final:</strong>
                        <p class="mb-0 mt-1">{{ derniere_evaluation.commentaire_confirmation }}</p>
                    </div>
                    {% elif derniere_evaluation.commentaire_validation %}
                    <div class="mt-3 p-3 bg-light rounded">
                        <strong>Commentaire validation:</strong>
                        <p class="mb-0 mt-1">{{ derniere_evaluation.commentaire_validation }}</p>
                    </div>
                    {% elif derniere_evaluation.commentaire_pre_evaluation %}
                    <div class="mt-3 p-3 bg-light rounded">
                        <strong>Commentaire pré-évaluation:</strong>
                        <p class="mb-0 mt-1">{{ derniere_evaluation.commentaire_pre_evaluation }}</p>
                    </div>
                    {% endif %}
                    
                    <!-- Métadonnées -->
                    <div class="mt-3 small text-muted text-center">
                        {% if derniere_evaluation.evaluateur_final %}
                            <i class="fas fa-user me-1"></i>Confirmé par {{ derniere_evaluation.evaluateur_final.username }}
                        {% elif derniere_evaluation.validateur %}
                            <i class="fas fa-user me-1"></i>Validé par {{ derniere_evaluation.validateur.username }}
                        {% elif derniere_evaluation.referent_pre_evaluation %}
                            <i class="fas fa-user me-1"></i>Pré-évalué par {{ derniere_evaluation.referent_pre_evaluation.username }}
                        {% endif %}
                        <br><i class="fas fa-clock me-1"></i>le {{ derniere_evaluation.created_at.strftime('%d/%m/%Y à %H:%M') }}
                    </div>
                    
                    {% else %}
                    <!-- Évaluation incomplète -->
                    <div class="alert alert-warning text-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Évaluation incomplète</strong>
                        <p class="mb-0 mt-2">Cette évaluation n'a pas d'impact ou de probabilité définis.</p>
                        <a href="{{ url_for('evaluer_risque_triphase', id=risque.id) }}" class="btn btn-warning btn-sm mt-2">
                            Compléter l'évaluation
                        </a>
                    </div>
                    {% endif %}
                    
                {% else %}
                <!-- Aucune évaluation -->
                <div class="text-center text-muted py-4">
                    <i class="fas fa-chart-bar fa-3x mb-3 text-muted"></i>
                    <p class="mb-3">Aucune évaluation disponible</p>
                    <a href="{{ url_for('evaluer_risque_triphase', id=risque.id) }}" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Première évaluation
                    </a>
                </div>
                {% endif %}
                
                <!-- Champs personnalisés de la section 'evaluation' -->
                {% for champ in champs_par_section.evaluation %}
                <div class="mt-3 p-3 bg-light rounded">
                    <strong>{{ champ.config.nom_affichage if champ.config else champ.nom_technique }}:</strong>
                    <div class="mt-1">
                        {% if champ.config and champ.config.type_champ == 'textarea' %}
                            {{ champ.get_valeur()|nl2br|safe }}
                        {% elif champ.config and champ.config.type_champ == 'select' %}
                            <span class="badge bg-info">{{ champ.get_valeur() }}</span>
                        {% elif champ.config and champ.config.type_champ == 'checkbox' %}
                            {% if champ.get_valeur() %}
                            <span class="badge bg-success">Oui</span>
                            {% else %}
                            <span class="badge bg-secondary">Non</span>
                            {% endif %}
                        {% elif champ.config and champ.config.type_champ == 'multiselect' %}
                            {% for valeur in champ.get_valeur() or [] %}
                            <span class="badge bg-info me-1">{{ valeur }}</span>
                            {% endfor %}
                        {% elif champ.config and champ.config.type_champ == 'fichier' and champ.get_valeur() %}
                            <a href="{{ url_for('telecharger_champ_fichier', champ_id=champ.id) }}" 
                               class="text-decoration-none" target="_blank">
                                <i class="fas fa-file me-1"></i>{{ champ.get_valeur() }}
                            </a>
                        {% else %}
                            {{ champ.get_valeur() or '<span class="text-muted">Non renseigné</span>'|safe }}
                        {% endif %}
                        
                        {% if current_user.has_permission('can_manage_risks') or risque.created_by == current_user.id %}
                        <button class="btn btn-sm btn-outline-info float-end" 
                                onclick="editerChamp({{ champ.id }})"
                                title="Modifier ce champ">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% endif %}
                    </div>
                    {% if champ.config and champ.config.aide_texte %}
                    <small class="text-muted">{{ champ.config.aide_texte }}</small>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- KRI associé -->
        {% if risque.kri %}
        <div class="card shadow mb-4">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-chart-line"></i> Indicateur de Risque (KRI)</h6>
                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#sectionKRI" aria-expanded="true">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="card-body collapse show" id="sectionKRI">
                <h6 class="text-success">{{ risque.kri.nom }}</h6>
                <p class="small text-muted">{{ risque.kri.description or 'Aucune description' }}</p>
                
                <table class="table table-sm table-borderless">
                    <tr>
                        <th width="40%">Unité:</th>
                        <td><code>{{ risque.kri.unite_mesure }}</code></td>
                    </tr>
                    <tr>
                        <th>Seuil d'alerte:</th>
                        <td>
                            <span class="badge bg-warning">{{ risque.kri.seuil_alerte or 'Non défini' }}</span>
                        </td>
                    </tr>
                    <tr>
                        <th>Seuil critique:</th>
                        <td>
                            <span class="badge bg-danger">{{ risque.kri.seuil_critique or 'Non défini' }}</span>
                        </td>
                    </tr>
                    <tr>
                        <th>Fréquence:</th>
                        <td>{{ risque.kri.frequence_mesure or 'Non spécifiée' }}</td>
                    </tr>
                    <tr>
                        <th>Responsable:</th>
                        <td>{{ risque.kri.responsable_mesure.username if risque.kri.responsable_mesure else 'Non assigné' }}</td>
                    </tr>
                    <tr>
                        <th>Statut:</th>
                        <td>
                            {% if risque.kri.is_archived %}
                            <span class="badge bg-warning">Archivé</span>
                            {% else %}
                            <span class="badge bg-success">Actif</span>
                            {% endif %}
                        </td>
                    </tr>
                </table>
                
                {% if risque.kri.mesures %}
                <div class="mt-3 p-3 bg-light rounded">
                    <strong>Dernière mesure:</strong>
                    {% set derniere_mesure = risque.kri.mesures|sort(attribute='date_mesure', reverse=true)|first %}
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <span class="badge bg-{% if risque.kri.seuil_critique and derniere_mesure.valeur >= risque.kri.seuil_critique %}danger{% elif risque.kri.seuil_alerte and derniere_mesure.valeur >= risque.kri.seuil_alerte %}warning{% else %}success{% endif %} fs-6">
                            {{ derniere_mesure.valeur }} {{ risque.kri.unite_mesure }}
                        </span>
                        <small class="text-muted">{{ derniere_mesure.date_mesure.strftime('%d/%m/%Y') }}</small>
                    </div>
                </div>
                {% else %}
                <div class="alert alert-info text-center py-2">
                    <small><i class="fas fa-info-circle me-1"></i>Aucune mesure enregistrée</small>
                </div>
                {% endif %}
                
                <div class="mt-3 text-center">
                    <a href="{{ url_for('liste_kri') }}" class="btn btn-outline-success btn-sm">
                        <i class="fas fa-list me-1"></i>Voir tous les KRI
                    </a>
                    {% if current_user.has_permission('can_manage_kri') %}
                    <a href="{{ url_for('modifier_kri', kri_id=risque.kri.id) }}" class="btn btn-outline-warning btn-sm">                        <i class="fas fa-edit me-1"></i>Modifier KRI
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <!-- Pas de KRI -->
        <div class="card shadow mb-4">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0"><i class="fas fa-chart-line"></i> Indicateur de Risque (KRI)</h6>
                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#sectionKRI" aria-expanded="true">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="card-body collapse show text-center py-4" id="sectionKRI">
                <i class="fas fa-chart-line fa-2x text-muted mb-3"></i>
                <p class="text-muted mb-3">Aucun KRI associé à ce risque</p>
                <a href="{{ url_for('nouveau_kri', risque_id=risque.id) }}" class="btn btn-success">
                    <i class="fas fa-plus me-1"></i>Créer un KRI
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Section Documentation et Fichiers -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card shadow">
            <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-file-alt me-2"></i>Documentation et Fichiers
                </h6>
                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#sectionDocumentation" aria-expanded="true">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="card-body collapse show" id="sectionDocumentation">
                <div class="row">
                    <!-- Champs de documentation -->
                    {% if champs_par_section.documentation %}
                    <div class="col-md-6">
                        <h6>Informations documentaires</h6>
                        {% for champ in champs_par_section.documentation %}
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                {{ champ.config.nom_affichage if champ.config else champ.nom_technique }}:
                            </label>
                            <div class="border rounded p-3 position-relative">
                                {% if champ.config and champ.config.type_champ == 'fichier' and champ.get_valeur() %}
                                    <a href="{{ url_for('telecharger_champ_fichier', champ_id=champ.id) }}" 
                                       class="text-decoration-none d-block" target="_blank">
                                        <i class="fas fa-file me-2"></i>{{ champ.get_valeur() }}
                                    </a>
                                {% elif champ.config and champ.config.type_champ == 'textarea' %}
                                    {{ champ.get_valeur()|nl2br|safe }}
                                {% elif champ.config and champ.config.type_champ == 'select' %}
                                    <span class="badge bg-info">{{ champ.get_valeur() }}</span>
                                {% elif champ.config and champ.config.type_champ == 'multiselect' %}
                                    {% for valeur in champ.get_valeur() or [] %}
                                    <span class="badge bg-info me-1">{{ valeur }}</span>
                                    {% endfor %}
                                {% elif champ.config and champ.config.type_champ == 'checkbox' %}
                                    {% if champ.get_valeur() %}
                                    <span class="badge bg-success">Oui</span>
                                    {% else %}
                                    <span class="badge bg-secondary">Non</span>
                                    {% endif %}
                                {% else %}
                                    {{ champ.get_valeur() or '<span class="text-muted">Non renseigné</span>'|safe }}
                                {% endif %}
                                
                                {% if current_user.has_permission('can_manage_risks') or risque.created_by == current_user.id %}
                                <button class="btn btn-sm btn-outline-info position-absolute top-0 end-0 m-2" 
                                        onclick="editerChamp({{ champ.id }})"
                                        title="Modifier ce champ">
                                    <i class="fas fa-edit"></i>
                                </button>
                                {% endif %}
                            </div>
                            {% if champ.config and champ.config.aide_texte %}
                            <small class="text-muted">{{ champ.config.aide_texte }}</small>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <!-- Liste des fichiers attachés -->
                    <div class="col-md-{% if champs_par_section.documentation %}6{% else %}12{% endif %}">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">Fichiers attachés</h6>
                            <span class="badge bg-primary">{{ fichiers|length }}</span>
                        </div>
                        
                        {% if fichiers %}
                        <div class="list-group">
                            {% for fichier in fichiers %}
                            <div class="list-group-item">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center">
                                        <!-- Icône selon le type de fichier -->
                                        {% if fichier.type_fichier %}
                                            {% if 'pdf' in fichier.type_fichier %}
                                            <i class="fas fa-file-pdf text-danger fa-lg me-3"></i>
                                            {% elif 'word' in fichier.type_fichier or 'document' in fichier.type_fichier %}
                                            <i class="fas fa-file-word text-primary fa-lg me-3"></i>
                                            {% elif 'excel' in fichier.type_fichier or 'spreadsheet' in fichier.type_fichier %}
                                            <i class="fas fa-file-excel text-success fa-lg me-3"></i>
                                            {% elif 'image' in fichier.type_fichier %}
                                            <i class="fas fa-file-image text-warning fa-lg me-3"></i>
                                            {% else %}
                                            <i class="fas fa-file-alt fa-lg me-3"></i>
                                            {% endif %}
                                        {% else %}
                                            <i class="fas fa-file-alt fa-lg me-3"></i>
                                        {% endif %}
                                        
                                        <div>
                                            <a href="{{ url_for('telecharger_fichier_risque', id=fichier.id) }}"
                                               class="text-decoration-none fw-bold"
                                               target="_blank">
                                                {{ fichier.nom_fichier }}
                                            </a>
                                            {% if fichier.categorie %}
                                            <span class="badge bg-secondary ms-2">{{ fichier.categorie }}</span>
                                            {% endif %}
                                            <br>
                                            <small class="text-muted">
                                                Ajouté par {{ fichier.uploader.username if fichier.uploader else 'Inconnu' }}
                                                le {{ fichier.created_at.strftime('%d/%m/%Y à %H:%M') }}
                                            </small>
                                        </div>
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <span class="badge bg-light text-dark me-2">
                                            {{ (fichier.taille / 1024)|round(1) }} Ko
                                        </span>
                                        {% if current_user.has_permission('can_manage_risks') or risque.created_by == current_user.id or current_user.id == fichier.uploaded_by %}
                                        <form method="POST" 
                                              action="{{ url_for('supprimer_fichier_risque', id=fichier.id) }}"
                                              class="d-inline"
                                              onsubmit="return confirm('Supprimer définitivement ce fichier ?');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </div>
                                </div>
                                {% if fichier.description %}
                                <div class="mt-2">
                                    <small class="text-muted">{{ fichier.description }}</small>
                                </div>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="alert alert-info text-center py-4">
                            <i class="fas fa-file-alt fa-3x mb-3"></i>
                            <p class="mb-2">Aucun fichier attaché à ce risque</p>
                            <p class="small text-muted mb-0">Vous pouvez ajouter des documents, images, analyses...</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Historique des évaluations -->
<!-- Historique des évaluations -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                    <i class="fas fa-history me-2"></i>Historique des Évaluations
                    <span class="badge bg-primary ms-2">{{ historique_evaluations|length }}</span>
                </h6>
                <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" 
                        data-bs-target="#sectionHistorique" aria-expanded="true">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="card-body collapse show" id="sectionHistorique">
                {% if historique_evaluations %}
                <div class="table-responsive">
                    <table class="table table-sm table-striped table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Date</th>
                                <th>Phase</th>
                                <th>Impact</th>
                                <th>Probabilité</th>
                                <th>Maîtrise</th>
                                <th>Score</th>
                                <th>Niveau</th>
                                <th>Évaluateur</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for eval in historique_evaluations %}
                            {% set valeurs = eval.get_valeurs_finales() %}
                            <tr class="{% if not eval.est_complete() %}table-warning{% endif %}">
                                <td>
                                    <small>{{ eval.created_at.strftime('%d/%m/%Y') }}</small>
                                    <br><small class="text-muted">{{ eval.created_at.strftime('%H:%M') }}</small>
                                </td>
                                <td>
                                    {% if eval.date_confirmation %}
                                        <span class="badge bg-success">Confirmée</span>
                                    {% elif eval.date_validation %}
                                        <span class="badge bg-warning">Validée</span>
                                    {% else %}
                                        <span class="badge bg-info">Pré-éval</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if valeurs.impact %}
                                    <span class="badge bg-primary">{{ valeurs.impact }}/5</span>
                                    {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if valeurs.probabilite %}
                                    <span class="badge bg-warning">{{ valeurs.probabilite }}/5</span>
                                    {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if valeurs.niveau_maitrise %}
                                    <span class="badge bg-success">{{ valeurs.niveau_maitrise }}/5</span>
                                    {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ valeurs.score or 'N/A' }}</strong>
                                </td>
                                <td>
                                    {% if valeurs.niveau_risque %}
                                    <span class="badge bg-{% if valeurs.niveau_risque == 'Critique' %}danger{% elif valeurs.niveau_risque == 'Élevé' %}warning{% elif valeurs.niveau_risque == 'Moyen' %}info{% else %}success{% endif %}">
                                        {{ valeurs.niveau_risque }}
                                    </span>
                                    {% else %}
                                    <span class="badge bg-secondary">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if eval.evaluateur_final %}
                                        {{ eval.evaluateur_final.username }}
                                    {% elif eval.validateur %}
                                        {{ eval.validateur.username }}
                                    {% elif eval.referent_pre_evaluation %}
                                        {{ eval.referent_pre_evaluation.username }}
                                    {% else %}
                                        Non assigné
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <!-- Bouton pour voir les détails -->
                                        <button type="button" class="btn btn-outline-info btn-sm" 
                                                onclick="voirDetailsEvaluation({{ eval.id }})"
                                                title="Voir les détails">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        
                                        <!-- Bouton pour réutiliser cette évaluation -->
                                        <form action="{{ url_for('nouvelle_evaluation_risque', id=risque.id) }}" method="post" class="d-inline">
                                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                            <input type="hidden" name="evaluation_id" value="{{ eval.id }}">
                                            <button type="submit" class="btn btn-outline-primary btn-sm" 
                                                    title="Réutiliser cette évaluation">
                                                <i class="fas fa-redo"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="fas fa-history fa-3x mb-3"></i>
                    <p>Aucune évaluation enregistrée</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modals pour l'ajout de fichiers et champs personnalisés -->
{% if current_user.has_permission('can_manage_risks') or risque.created_by == current_user.id %}

<!-- Modal pour ajouter un fichier -->
<!-- Modal pour ajouter un fichier -->
<div class="modal fade" id="modalAjoutFichier" tabindex="-1" aria-labelledby="modalAjoutFichierLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAjoutFichierLabel">
                    <i class="fas fa-file-upload"></i> Ajouter un fichier
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <!-- SUPPRIMEZ LE FORMULAIRE EN TROP ICI -->
            <form method="POST" action="{{ url_for('ajouter_fichier_risque', risque_id=risque.id) }}" 
                  enctype="multipart/form-data" id="formAjoutFichier">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Fichier :</label>
                        <input type="file" class="form-control" name="fichier" id="fichierInput" required>
                        <small class="form-text text-muted">
                            Formats autorisés : {{ config_fichiers.extensions|join(', ') }}<br>
                            Taille max : {{ config_fichiers.taille_max_mo }} Mo
                        </small>
                        <div class="invalid-feedback" id="fichierError"></div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Catégorie :</label>
                        <select class="form-select" name="categorie" required>
                            <option value="">Sélectionnez une catégorie</option>
                            {% for categorie in config_fichiers.categories %}
                            <option value="{{ categorie }}">{{ categorie }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Description :</label>
                        <textarea class="form-control" name="description" rows="3" 
                                  placeholder="Description du fichier (optionnel)..." 
                                  maxlength="500"></textarea>
                        <small class="form-text text-muted">Maximum 500 caractères</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary" id="btnUploadFichier">
                        <i class="fas fa-upload me-1"></i>Téléverser
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour ajouter un champ personnalisé -->
<div class="modal fade" id="modalAjoutChamp" tabindex="-1" aria-labelledby="modalAjoutChampLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalAjoutChampLabel">
                    <i class="fas fa-plus"></i> Ajouter un champ personnalisé
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" action="{{ url_for('ajouter_champ_personnalise', risque_id=risque.id) }}" id="formAjoutChamp">
                <div class="modal-body">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    
                    <div class="mb-3">
                        <label class="form-label fw-bold">Sélectionner un champ :</label>
                        <select class="form-select" name="champ_config_id" id="selectChampConfig" 
                                onchange="chargerConfigurationChamp()" required>
                            <option value="">-- Sélectionner un champ --</option>
                            {% for config in champs_disponibles %}
                            <option value="{{ config.id }}" 
                                    data-type="{{ config.type_champ }}"
                                    data-obligatoire="{{ 'true' if config.est_obligatoire else 'false' }}">
                                {{ config.nom_affichage }} 
                                <small class="text-muted">({{ config.section }})</small>
                            </option>
                            {% endfor %}
                        </select>
                        <small class="form-text text-muted">
                            Seuls les champs non encore ajoutés sont affichés
                        </small>
                    </div>
                    
                    <div id="contenuValeurChamp">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            Sélectionnez d'abord un champ pour voir les options de saisie
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-primary" disabled id="btnAjouterChamp">
                        <i class="fas fa-plus me-1"></i>Ajouter
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal pour éditer un champ existant -->
<div class="modal fade" id="modalEditerChamp" tabindex="-1" aria-labelledby="modalEditerChampLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalEditerChampLabel">
                    <i class="fas fa-edit"></i> Modifier le champ
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="contenuEditionChamp">
                <!-- Chargé dynamiquement -->
            </div>
        </div>
    </div>
</div>

{% endif %}

<!-- Actions rapides -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card border-0">
            <div class="card-body text-center">
                <div class="btn-group" role="group">
                    <a href="{{ url_for('evaluer_risque_triphase', id=risque.id) }}" class="btn btn-primary">
                        <i class="fas fa-chart-bar me-1"></i>Nouvelle Évaluation
                    </a>
                    <a href="{{ url_for('modifier_risque', id=risque.id) }}" class="btn btn-outline-warning">
                        <i class="fas fa-edit me-1"></i>Modifier le Risque
                    </a>
                    <a href="{{ url_for('evaluer_risque_triphase', id=risque.id) }}" class="btn btn-primary">
                        <i class="fas fa-chart-bar me-1"></i>Évaluer
                    </a>
                    <a href="{{ url_for('nouvelle_campagne_evaluation', id=risque.id) }}" class="btn btn-success">
                        <i class="fas fa-calendar-plus me-1"></i>Nouvelle Campagne
                    </a>
                    {% if not risque.kri %}
                    <a href="{{ url_for('nouveau_kri', risque_id=risque.id) }}" class="btn btn-success">
                        <i class="fas fa-chart-line me-1"></i>Créer KRI
                    </a>
                    {% endif %}
                    <a href="{{ url_for('detail_cartographie', id=risque.cartographie_id) }}" class="btn btn-outline-info">
                        <i class="fas fa-map me-1"></i>Voir sur la Matrice
                    </a>
                    {% if current_user.has_permission('can_manage_risks') %}
                    <a href="{{ url_for('exporter_risque', id=risque.id) }}" class="btn btn-outline-secondary">
                        <i class="fas fa-download me-1"></i>Exporter
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Gestion de la sélection de champ dans le modal
    const selectChamp = document.getElementById('selectChampConfig');
    const btnAjouterChamp = document.getElementById('btnAjouterChamp');
    const contenuValeurChamp = document.getElementById('contenuValeurChamp');
    
    // Validation des fichiers
    const fichierInput = document.getElementById('fichierInput');
    const formAjoutFichier = document.getElementById('formAjoutFichier');
    const btnUploadFichier = document.getElementById('btnUploadFichier');
    
    if (fichierInput && formAjoutFichier) {
        formAjoutFichier.addEventListener('submit', function(e) {
            if (fichierInput.files.length > 0) {
                const file = fichierInput.files[0];
                const extension = file.name.split('.').pop().toLowerCase();
                const allowedExtensions = {{ config_fichiers.extensions|tojson }};
                const maxSize = {{ config_fichiers.taille_max_mo }} * 1024 * 1024;
                
                // Vérifier l'extension
                if (!allowedExtensions.includes(extension)) {
                    e.preventDefault();
                    const errorDiv = document.getElementById('fichierError');
                    errorDiv.textContent = `Extension .${extension} non autorisée. Formats acceptés: ${allowedExtensions.join(', ')}`;
                    fichierInput.classList.add('is-invalid');
                    return;
                }
                
                // Vérifier la taille
                if (file.size > maxSize) {
                    e.preventDefault();
                    const errorDiv = document.getElementById('fichierError');
                    const sizeMB = (file.size / (1024 * 1024)).toFixed(2);
                    errorDiv.textContent = `Fichier trop volumineux (${sizeMB} Mo). Maximum: {{ config_fichiers.taille_max_mo }} Mo`;
                    fichierInput.classList.add('is-invalid');
                    return;
                }
                
                // Désactiver le bouton pendant l'upload
                btnUploadFichier.disabled = true;
                btnUploadFichier.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Téléversement...';
            }
        });
        
        // Réinitialiser la validation quand le fichier change
        fichierInput.addEventListener('change', function() {
            this.classList.remove('is-invalid');
            document.getElementById('fichierError').textContent = '';
        });
    }
    
    if (selectChamp) {
        selectChamp.addEventListener('change', function() {
            const champId = this.value;
            if (champId) {
                fetch(`/parametrage/champ/${champId}/configuration`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Erreur de chargement');
                        }
                        return response.json();
                    })
                    .then(config => {
                        let html = '';
                        const selectedOption = this.options[this.selectedIndex];
                        const estObligatoire = selectedOption.getAttribute('data-obligatoire') === 'true';
                        
                        switch(config.type_champ) {
                            case 'texte':
                                html = `
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Valeur :</label>
                                        <input type="text" class="form-control" name="valeur" 
                                               ${estObligatoire ? 'required' : ''}
                                               maxlength="255">
                                        ${config.aide_texte ? `<small class="form-text text-muted">${config.aide_texte}</small>` : ''}
                                    </div>
                                `;
                                break;
                                
                            case 'textarea':
                                html = `
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Valeur :</label>
                                        <textarea class="form-control" name="valeur" rows="4" 
                                                  ${estObligatoire ? 'required' : ''}></textarea>
                                        ${config.aide_texte ? `<small class="form-text text-muted">${config.aide_texte}</small>` : ''}
                                    </div>
                                `;
                                break;
                                
                            case 'select':
                                let options = '';
                                if (config.valeurs_possibles && config.valeurs_possibles.length > 0) {
                                    config.valeurs_possibles.forEach(val => {
                                        options += `<option value="${val}">${val}</option>`;
                                    });
                                }
                                html = `
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Valeur :</label>
                                        <select class="form-select" name="valeur" ${estObligatoire ? 'required' : ''}>
                                            <option value="">-- Sélectionner --</option>
                                            ${options}
                                        </select>
                                        ${config.aide_texte ? `<small class="form-text text-muted">${config.aide_texte}</small>` : ''}
                                    </div>
                                `;
                                break;
                                
                            case 'multiselect':
                                let multiOptions = '';
                                if (config.valeurs_possibles && config.valeurs_possibles.length > 0) {
                                    config.valeurs_possibles.forEach(val => {
                                        multiOptions += `<option value="${val}">${val}</option>`;
                                    });
                                }
                                html = `
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Valeurs :</label>
                                        <select class="form-select" name="valeur" multiple 
                                                size="4" ${estObligatoire ? 'required' : ''}>
                                            ${multiOptions}
                                        </select>
                                        <small class="form-text text-muted">Maintenez Ctrl (ou Cmd sur Mac) pour sélectionner plusieurs valeurs</small>
                                        ${config.aide_texte ? `<br><small class="form-text text-muted">${config.aide_texte}</small>` : ''}
                                    </div>
                                `;
                                break;
                                
                            case 'checkbox':
                                html = `
                                    <div class="mb-3 form-check">
                                        <input type="checkbox" class="form-check-input" name="valeur" id="valeurCheckbox" value="true">
                                        <label class="form-check-label fw-bold" for="valeurCheckbox">Coché</label>
                                        ${config.aide_texte ? `<small class="form-text text-muted d-block">${config.aide_texte}</small>` : ''}
                                    </div>
                                `;
                                break;
                                
                            case 'date':
                                html = `
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Date :</label>
                                        <input type="date" class="form-control" name="valeur" 
                                               ${estObligatoire ? 'required' : ''}>
                                        ${config.aide_texte ? `<small class="form-text text-muted">${config.aide_texte}</small>` : ''}
                                    </div>
                                `;
                                break;
                                
                            case 'fichier':
                                html = `
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Fichier :</label>
                                        <input type="file" class="form-control" name="valeur" 
                                               ${estObligatoire ? 'required' : ''}>
                                        ${config.aide_texte ? `<small class="form-text text-muted">${config.aide_texte}</small>` : ''}
                                    </div>
                                `;
                                break;
                                
                            default:
                                html = `
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Type de champ non supporté : ${config.type_champ}
                                    </div>
                                `;
                        }
                        
                        contenuValeurChamp.innerHTML = html;
                        btnAjouterChamp.disabled = false;
                    })
                    .catch(error => {
                        console.error('Erreur:', error);
                        contenuValeurChamp.innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle"></i>
                                Erreur lors du chargement de la configuration
                            </div>
                        `;
                        btnAjouterChamp.disabled = true;
                    });
            } else {
                contenuValeurChamp.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        Sélectionnez d'abord un champ pour voir les options de saisie
                    </div>
                `;
                btnAjouterChamp.disabled = true;
            }
        });
    }
    
    // Initialiser les tooltips Bootstrap
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
});

// Fonction pour éditer un champ existant
function editerChamp(champId) {
    fetch(`/risque/champ/${champId}/editer`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Erreur de chargement');
            }
            return response.text();
        })
        .then(html => {
            document.getElementById('contenuEditionChamp').innerHTML = html;
            const modal = new bootstrap.Modal(document.getElementById('modalEditerChamp'));
            modal.show();
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors du chargement du formulaire d\'édition');
        });
}

// Confirmation de suppression
function confirmerSuppression(message) {
    return confirm(message || 'Êtes-vous sûr de vouloir supprimer cet élément ?');
}
// Fonction pour voir les détails d'une évaluation
function voirDetailsEvaluation(evaluationId) {
    fetch(`/api/evaluation/${evaluationId}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Créer le contenu de la modal
                let html = `
                <div class="modal-header">
                    <h5 class="modal-title">Détails de l'évaluation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Phase 1 - Pré-évaluation</h6>
                            <p><strong>Impact:</strong> ${data.impact_pre || 'Non défini'}/5</p>
                            <p><strong>Probabilité:</strong> ${data.probabilite_pre || 'Non défini'}/5</p>
                            <p><strong>Maîtrise:</strong> ${data.niveau_maitrise_pre || 'Non défini'}/5</p>
                            <p><strong>Commentaire:</strong> ${data.commentaire_pre_evaluation || 'Aucun'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Phase 2 - Validation</h6>
                            <p><strong>Impact ajusté:</strong> ${data.impact_val || 'Non ajusté'}/5</p>
                            <p><strong>Probabilité ajustée:</strong> ${data.probabilite_val || 'Non ajusté'}/5</p>
                            <p><strong>Statut:</strong> <span class="badge bg-${data.statut_validation === 'valide' ? 'success' : 'warning'}">${data.statut_validation}</span></p>
                            <p><strong>Commentaire:</strong> ${data.commentaire_validation || 'Aucun'}</p>
                        </div>
                    </div>
                    ${data.date_confirmation ? `
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Phase 3 - Confirmation</h6>
                            <p><strong>Impact final:</strong> ${data.impact_conf || 'Non ajusté'}/5</p>
                            <p><strong>Probabilité finale:</strong> ${data.probabilite_conf || 'Non ajusté'}/5</p>
                            <p><strong>Score final:</strong> ${data.score_risque || 'Non calculé'}</p>
                            <p><strong>Niveau:</strong> <span class="badge bg-${data.niveau_risque === 'Critique' ? 'danger' : data.niveau_risque === 'Élevé' ? 'warning' : data.niveau_risque === 'Moyen' ? 'info' : 'success'}">${data.niveau_risque}</span></p>
                        </div>
                    </div>
                    ` : ''}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <a href="${data.url_modification}" class="btn btn-primary">Modifier</a>
                </div>
                `;
                
                // Créer une modal dynamique
                const modalDiv = document.createElement('div');
                modalDiv.className = 'modal fade';
                modalDiv.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            ${html}
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalDiv);
                const modal = new bootstrap.Modal(modalDiv);
                modal.show();
                
                // Nettoyer après fermeture
                modalDiv.addEventListener('hidden.bs.modal', function () {
                    document.body.removeChild(modalDiv);
                });
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors du chargement des détails');
        });
}
</script>

<style>
/* Styles supplémentaires */
.border-start {
    border-left-width: 4px !important;
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

.card-header button {
    transition: transform 0.3s ease;
}

.card-header button[aria-expanded="false"] .fa-chevron-down {
    transform: rotate(-90deg);
}

.badge {
    font-weight: 500;
}

.table th {
    font-weight: 600;
}

.alert {
    border-left: 4px solid;
}

.alert-info {
    border-left-color: #0dcaf0;
}

.alert-warning {
    border-left-color: #ffc107;
}

.alert-danger {
    border-left-color: #dc3545;
}

.alert-success {
    border-left-color: #198754;
}
</style>
{% endblock %}
{% endblock %}
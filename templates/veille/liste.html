{% extends "base.html" %}

{% block title %}Veille Réglementaire - FabriceKonan Corporate{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête avec boutons d'action -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h4 mb-2">
                <i class="fas fa-balance-scale me-2" style="color: var(--fk-accent);"></i>
                Veille Réglementaire
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Tableau de bord</a></li>
                    <li class="breadcrumb-item active">Veille réglementaire</li>
                </ol>
            </nav>
        </div>
        <div class="btn-group" role="group">
            <a href="{{ url_for('nouvelle_veille') }}" class="fk-btn fk-btn-primary me-2">
                <i class="fas fa-plus me-2"></i>
                Nouvelle Veille
            </a>
            <a href="{{ url_for('veille_archives') }}" class="fk-btn fk-btn-outline me-2">
                <i class="fas fa-archive me-2"></i>
                Archives
            </a>
            <a href="{{ url_for('calendrier_veille') }}" class="fk-btn fk-btn-outline me-2">
                <i class="fas fa-calendar-alt me-2"></i>
                Calendrier
            </a>
            <a href="{{ url_for('rapport_veille') }}" class="fk-btn fk-btn-outline">
                <i class="fas fa-chart-bar me-2"></i>
                Rapports
            </a>
        </div>
    </div>

    <!-- Tableau de bord des indicateurs -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="fk-card h-100">
                <div class="fk-card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i> Conformité</h5>
                </div>
                <div class="fk-card-body text-center">
                    <div class="display-4 fw-bold text-primary mb-2">{{ "%.1f"|format(rapport.taux_conformite) }}%</div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-primary" style="width: {{ rapport.taux_conformite }}%"></div>
                    </div>
                    <p class="text-muted mb-0">Taux de conformité global</p>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="fk-card h-100">
                <div class="fk-card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-clipboard-check me-2"></i> Terminées</h5>
                </div>
                <div class="fk-card-body text-center">
                    <div class="display-4 fw-bold text-success mb-2">{{ rapport.actions_terminees }}</div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-success" 
                            style="width: {{ rapport.pct_terminees }}%">
                        </div>
                    </div>
                    <p class="text-muted mb-0">Actions terminées</p>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="fk-card h-100">
                <div class="fk-card-header bg-warning text-white">
                    <h5 class="mb-0"><i class="fas fa-spinner me-2"></i> En Cours</h5>
                </div>
                <div class="fk-card-body text-center">
                    <div class="display-4 fw-bold text-warning mb-2">{{ rapport.actions_en_cours }}</div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-warning" 
                            style="width: {{ rapport.pct_en_cours }}%">
                        </div>
                    </div>
                    <p class="text-muted mb-0">Actions en cours</p>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="fk-card h-100">
                <div class="fk-card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i> En Retard</h5>
                </div>
                <div class="fk-card-body text-center">
                    <div class="display-4 fw-bold text-danger mb-2">{{ rapport.actions_retardees }}</div>
                    <div class="progress mb-3" style="height: 8px;">
                        <div class="progress-bar bg-danger" 
                            style="width: {{ rapport.pct_retardees }}%">
                        </div>
                    </div>
                    <p class="text-muted mb-0">Actions en retard</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Alertes en retard -->
    {% if rapport.actions_en_retard %}
    <div class="fk-alert fk-alert-warning mb-4">
        <i class="fas fa-clock fa-lg me-3"></i>
        <div class="flex-grow-1">
            <h6 class="mb-2"><strong>Actions en Retard</strong></h6>
            <ul class="mb-0">
                {% for item in rapport.actions_en_retard %}
                <li>
                    {{ item.action.description }} 
                    <span class="badge bg-danger ms-2">{{ item.jours_retard }} jour{% if item.jours_retard > 1 %}s{% endif %} de retard</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>
    {% endif %}

    <!-- Filtres et recherche -->
    <div class="fk-card mb-4">
        <div class="fk-card-header">
            <h5 class="mb-0"><i class="fas fa-filter me-2"></i> Filtres et Recherche</h5>
        </div>
        <div class="fk-card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-light"><i class="fas fa-search text-muted"></i></span>
                        <input type="text" class="fk-form-control" id="searchVeille" placeholder="Rechercher une réglementation...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="fk-form-control" id="filterStatut">
                        <option value="all">Tous les statuts</option>
                        <option value="en_vigueur">En vigueur</option>
                        <option value="projet">Projet</option>
                        <option value="abroge">Abrogé</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="fk-form-control" id="filterImpact">
                        <option value="all">Tous les impacts</option>
                        <option value="eleve">Impact élevé</option>
                        <option value="moyen">Impact moyen</option>
                        <option value="faible">Impact faible</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button class="fk-btn fk-btn-outline w-100" id="resetFilters">
                        <i class="fas fa-redo me-2"></i> Réinitialiser
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Table des veilles -->
    <div class="fk-card">
        <div class="fk-card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-list me-2"></i> Réglementations Suivies
                <span class="fk-badge fk-badge-primary ms-2">{{ veilles|length }}</span>
            </h5>
            <div>
                <small class="text-muted me-3">Affichage : {{ veilles|length }} sur {{ veilles_total }}</small>
                <div class="form-check form-switch d-inline-block">
                    <input class="form-check-input" type="checkbox" id="toggleDetails" checked>
                    <label class="form-check-label small" for="toggleDetails">Détails</label>
                </div>
            </div>
        </div>
        
        <div class="fk-card-body">
            {% if veilles %}
            <div class="table-responsive">
                <table class="fk-table" id="veilleTable">
                    <thead>
                        <tr>
                            <th width="25%">Titre & Description</th>
                            <th width="10%">Référence</th>
                            <th width="10%">Type</th>
                            <th width="10%">Statut</th>
                            <th width="10%">Impact</th>
                            <th width="15%">Date Application</th>
                            <th width="10%">Actions/Docs</th>
                            <th width="10%" class="text-end">Opérations</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for veille in veilles %}
                        <tr class="transition-all" data-statut="{{ veille.statut }}" data-impact="{{ veille.impact_estime }}">
                            <td>
                                <div class="d-flex align-items-start">
                                    <div class="flex-shrink-0 me-3">
                                        <div class="rounded-circle bg-primary bg-opacity-10 p-2">
                                            <i class="fas fa-balance-scale text-primary"></i>
                                        </div>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">{{ veille.titre }}</h6>
                                        {% if veille.description %}
                                        <p class="mb-0 text-muted small details-row">{{ veille.description|truncate(80) }}</p>
                                        {% endif %}
                                    </div>
                                </div>
                            </td>
                            <td>
                                <code class="bg-light px-2 py-1 rounded">{{ veille.reference or '-' }}</code>
                            </td>
                            <td>
                                <span class="fk-badge fk-badge-primary">{{ veille.type_reglementation }}</span>
                            </td>
                            <td>
                                {% if veille.statut == 'en_vigueur' %}
                                <span class="fk-badge fk-badge-success">En vigueur</span>
                                {% elif veille.statut == 'projet' %}
                                <span class="fk-badge fk-badge-warning">Projet</span>
                                {% elif veille.statut == 'abroge' %}
                                <span class="fk-badge fk-badge-error">Abrogé</span>
                                {% else %}
                                <span class="fk-badge">{{ veille.statut }}</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if veille.impact_estime == 'eleve' %}
                                <div class="d-flex align-items-center">
                                    <div class="bg-danger bg-opacity-10 rounded p-2 me-2">
                                        <i class="fas fa-exclamation-triangle text-danger"></i>
                                    </div>
                                    <span class="fw-bold text-danger">Élevé</span>
                                </div>
                                {% elif veille.impact_estime == 'moyen' %}
                                <div class="d-flex align-items-center">
                                    <div class="bg-warning bg-opacity-10 rounded p-2 me-2">
                                        <i class="fas fa-info-circle text-warning"></i>
                                    </div>
                                    <span class="fw-bold text-warning">Moyen</span>
                                </div>
                                {% elif veille.impact_estime == 'faible' %}
                                <div class="d-flex align-items-center">
                                    <div class="bg-success bg-opacity-10 rounded p-2 me-2">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </div>
                                    <span class="fw-bold text-success">Faible</span>
                                </div>
                                {% else %}
                                <span class="text-muted">Non évalué</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if veille.date_application %}
                                <div class="d-flex flex-column">
                                    <strong>{{ veille.date_application.strftime('%d/%m/%Y') }}</strong>
                                    {% if veille.days_until_application is not none %}
                                    <small class="{% if veille.days_until_application < 0 %}text-danger{% elif veille.days_until_application < 30 %}text-warning{% else %}text-success{% endif %}">
                                        {% if veille.days_until_application > 0 %}
                                        <i class="fas fa-clock me-1"></i>J-{{ veille.days_until_application }}
                                        {% elif veille.days_until_application == 0 %}
                                        <i class="fas fa-bell me-1"></i>Aujourd'hui
                                        {% else %}
                                        <i class="fas fa-history me-1"></i>J+{{ -veille.days_until_application }}
                                        {% endif %}
                                    </small>
                                    {% endif %}
                                </div>
                                {% else %}
                                <span class="text-muted">-</span>
                                {% endif %}
                            </td>
                            <td>
                                <div class="d-flex flex-column gap-1">
                                    {% set actions_actives = veille.actions|selectattr('is_archived', 'equalto', false)|list %}
                                    <span class="badge {% if actions_actives|length > 0 %}bg-primary{% else %}bg-secondary{% endif %}">
                                        <i class="fas fa-tasks me-1"></i>{{ actions_actives|length }} actions
                                    </span>
                                    
                                    {% set actions_archivees = veille.actions|selectattr('is_archived', 'equalto', true)|list %}
                                    {% if actions_archivees|length > 0 %}
                                    <span class="badge bg-secondary">
                                        <i class="fas fa-archive me-1"></i>{{ actions_archivees|length }} archivées
                                    </span>
                                    {% endif %}
                                    
                                    <span class="badge {% if veille.documents|length > 0 %}bg-info{% else %}bg-secondary{% endif %}">
                                        <i class="fas fa-file me-1"></i>{{ veille.documents|length }} docs
                                    </span>
                                </div>
                            </td>
                            <td class="text-end">
                                <div class="btn-group btn-group-sm" role="group">
                                    <button class="btn btn-sm btn-outline-info" 
                                            data-bs-toggle="modal" 
                                            data-bs-target="#detailVeilleModal{{ veille.id }}"
                                            data-bs-tooltip="tooltip" title="Voir les détails">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#actionModal{{ veille.id }}"
                                            data-bs-tooltip="tooltip" title="Gérer les actions">
                                        <i class="fas fa-tasks"></i>
                                    </button>
                                    <a href="{{ url_for('modifier_veille', id=veille.id) }}" 
                                       class="btn btn-sm btn-outline-warning"
                                       data-bs-tooltip="tooltip" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button class="btn btn-sm btn-outline-secondary"
                                            data-bs-toggle="modal"
                                            data-bs-target="#documentModal{{ veille.id }}"
                                            data-bs-tooltip="tooltip" title="Documents">
                                        <i class="fas fa-file"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary"
                                            onclick="archiverVeille({{ veille.id }}, '{{ veille.titre }}')"
                                            data-bs-tooltip="tooltip" title="Archiver">
                                        <i class="fas fa-archive"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-balance-scale fa-4x text-muted opacity-25"></i>
                </div>
                <h4 class="mb-3">Aucune veille réglementaire</h4>
                <p class="text-muted mb-4">
                    Commencez par ajouter les réglementations applicables à votre organisation.
                </p>
                <a href="{{ url_for('nouvelle_veille') }}" class="fk-btn fk-btn-primary">
                    <i class="fas fa-plus me-2"></i>
                    Ajouter ma première veille
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modals pour chaque veille -->
{% for veille in veilles %}
<!-- Modal Détail Veille -->
<div class="modal fade" id="detailVeilleModal{{ veille.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header fk-card-header">
                <h5 class="modal-title mb-0">{{ veille.titre }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <strong>Référence:</strong>
                            <p class="mb-0">{{ veille.reference or '-' }}</p>
                        </div>
                        <div class="mb-3">
                            <strong>Type:</strong>
                            <p class="mb-0">{{ veille.type_reglementation }}</p>
                        </div>
                        <div class="mb-3">
                            <strong>Organisme émetteur:</strong>
                            <p class="mb-0">{{ veille.organisme_emetteur or '-' }}</p>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                            <strong>Date publication:</strong>
                            <p class="mb-0">
                                {% if veille.date_publication %}
                                {{ veille.date_publication.strftime('%d/%m/%Y') }}
                                {% else %}-{% endif %}
                            </p>
                        </div>
                        <div class="mb-3">
                            <strong>Date application:</strong>
                            <p class="mb-0">
                                {% if veille.date_application %}
                                {{ veille.date_application.strftime('%d/%m/%Y') }}
                                {% else %}-{% endif %}
                            </p>
                        </div>
                        <div class="mb-3">
                            <strong>Statut:</strong>
                            <p class="mb-0">
                                {% if veille.statut == 'en_vigueur' %}
                                <span class="fk-badge fk-badge-success">En vigueur</span>
                                {% elif veille.statut == 'projet' %}
                                <span class="fk-badge fk-badge-warning">Projet</span>
                                {% else %}
                                <span class="fk-badge">{{ veille.statut }}</span>
                                {% endif %}
                            </p>
                        </div>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h6>Description:</h6>
                    <div class="border rounded p-3 bg-light">
                        {{ veille.description or 'Aucune description' }}
                    </div>
                </div>
                
                <div class="mb-4">
                    <h6>Impact estimé:</h6>
                    {% if veille.impact_estime == 'eleve' %}
                    <div class="fk-alert fk-alert-error">
                        <i class="fas fa-exclamation-triangle me-3"></i>
                        <div>
                            <strong>Impact Élevé</strong>
                            <p class="mb-0">Impact significatif sur les opérations. Adaptation majeure nécessaire.</p>
                        </div>
                    </div>
                    {% elif veille.impact_estime == 'moyen' %}
                    <div class="fk-alert fk-alert-warning">
                        <i class="fas fa-info-circle me-3"></i>
                        <div>
                            <strong>Impact Moyen</strong>
                            <p class="mb-0">Adaptation modérée nécessaire avec planification appropriée.</p>
                        </div>
                    </div>
                    {% elif veille.impact_estime == 'faible' %}
                    <div class="fk-alert fk-alert-success">
                        <i class="fas fa-check-circle me-3"></i>
                        <div>
                            <strong>Impact Faible</strong>
                            <p class="mb-0">Adaptation mineure sans impact opérationnel significatif.</p>
                        </div>
                    </div>
                    {% else %}
                    <div class="fk-alert fk-alert-info">
                        <i class="fas fa-question-circle me-3"></i>
                        <div>
                            <strong>Impact non évalué</strong>
                            <p class="mb-0">L'impact n'a pas encore été évalué.</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="fk-btn fk-btn-outline" data-bs-dismiss="modal">Fermer</button>
                <a href="{{ url_for('modifier_veille', id=veille.id) }}" class="fk-btn fk-btn-primary">
                    <i class="fas fa-edit me-2"></i> Modifier
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Modal Actions -->
<div class="modal fade" id="actionModal{{ veille.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header fk-card-header">
                <h5 class="modal-title mb-0">Actions - {{ veille.titre }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Onglets -->
                <ul class="nav nav-tabs mb-3" id="actionTabs{{ veille.id }}" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="active-tab{{ veille.id }}" data-bs-toggle="tab" 
                                data-bs-target="#actionsActive{{ veille.id }}" type="button" role="tab">
                            <i class="fas fa-tasks me-2"></i>Actions Actives
                            <span class="fk-badge fk-badge-primary ms-1">{{ veille.actions|selectattr('is_archived', 'equalto', false)|list|length }}</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="archive-tab{{ veille.id }}" data-bs-toggle="tab" 
                                data-bs-target="#actionsArchivees{{ veille.id }}" type="button" role="tab">
                            <i class="fas fa-archive me-2"></i>Archives
                            <span class="fk-badge ms-1">{{ veille.actions|selectattr('is_archived', 'equalto', true)|list|length }}</span>
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content">
                    <!-- Onglet Actions Actives -->
                    <div class="tab-pane fade show active" id="actionsActive{{ veille.id }}" role="tabpanel">
                        {% set actions_actives = veille.actions|selectattr('is_archived', 'equalto', false)|list %}
                        
                        {% if actions_actives %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th width="35%">Description</th>
                                        <th width="20%">Responsable</th>
                                        <th width="15%">Échéance</th>
                                        <th width="15%">Statut</th>
                                        <th width="15%">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for action in actions_actives %}
                                    <tr>
                                        <td>{{ action.description }}</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="rounded-circle bg-primary bg-opacity-10 p-1 me-2">
                                                    <i class="fas fa-user text-primary"></i>
                                                </div>
                                                <div>
                                                    <div>{{ action.responsable.username if action.responsable else 'Non assigné' }}</div>
                                                    <small class="text-muted">{{ action.responsable.role if action.responsable else '' }}</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            {% if action.date_echeance %}
                                            {% set is_late = action.date_echeance < datetime.now().date() and action.statut != 'termine' %}
                                            <div class="{% if is_late %}text-danger{% elif action.statut == 'termine' %}text-success{% else %}text-warning{% endif %}">
                                                {{ action.date_echeance.strftime('%d/%m/%Y') }}
                                                {% if is_late %}
                                                <div class="badge bg-danger mt-1">En retard</div>
                                                {% endif %}
                                            </div>
                                            {% else %}
                                            <span class="text-muted">Non définie</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <form action="{{ url_for('modifier_statut_action', action_id=action.id) }}" method="POST" class="d-inline">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <select name="statut" class="form-select form-select-sm" onchange="this.form.submit()">
                                                    <option value="a_faire" {% if action.statut == 'a_faire' %}selected{% endif %}>À faire</option>
                                                    <option value="en_cours" {% if action.statut == 'en_cours' %}selected{% endif %}>En cours</option>
                                                    <option value="termine" {% if action.statut == 'termine' %}selected{% endif %}>Terminé</option>
                                                </select>
                                            </form>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                {% if action.commentaire %}
                                                <button class="btn btn-sm btn-info" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#commentaireModal{{ action.id }}"
                                                        title="Voir/modifier le commentaire">
                                                    <i class="fas fa-comment"></i>
                                                </button>
                                                {% else %}
                                                <button class="btn btn-sm btn-outline-secondary" 
                                                        data-bs-toggle="modal" 
                                                        data-bs-target="#commentaireModal{{ action.id }}"
                                                        title="Ajouter un commentaire">
                                                    <i class="fas fa-comment"></i>
                                                </button>
                                                {% endif %}
                                                <button class="btn btn-sm btn-warning" 
                                                        onclick="archiverAction({{ action.id }}, '{{ veille.titre }}')"
                                                        title="Archiver">
                                                    <i class="fas fa-archive"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-tasks fa-3x text-muted mb-3 opacity-25"></i>
                            <h6 class="text-muted">Aucune action active</h6>
                            <p class="text-muted">Ajoutez des actions pour cette réglementation</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Onglet Archives -->
                    <div class="tab-pane fade" id="actionsArchivees{{ veille.id }}" role="tabpanel">
                        {% set actions_archivees = veille.actions|selectattr('is_archived', 'equalto', true)|list %}
                        
                        {% if actions_archivees %}
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Responsable</th>
                                        <th>Échéance</th>
                                        <th>Statut</th>
                                        <th>Archivée le</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for action in actions_archivees %}
                                    <tr class="table-secondary">
                                        <td><s>{{ action.description }}</s></td>
                                        <td>{{ action.responsable.username if action.responsable else 'Non assigné' }}</td>
                                        <td>
                                            {% if action.date_echeance %}
                                            {{ action.date_echeance.strftime('%d/%m/%Y') }}
                                            {% else %}
                                            <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ action.statut }}</span>
                                        </td>
                                        <td>{{ action.updated_at.strftime('%d/%m/%Y') }}</td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-sm btn-success" 
                                                        onclick="restaurerAction({{ action.id }}, '{{ veille.titre }}')"
                                                        title="Restaurer">
                                                    <i class="fas fa-undo"></i>
                                                </button>
                                                <button class="btn btn-sm btn-danger" 
                                                        onclick="supprimerAction({{ action.id }}, '{{ veille.titre }}')"
                                                        title="Supprimer">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-archive fa-3x text-muted mb-3 opacity-25"></i>
                            <h6 class="text-muted">Aucune action archivée</h6>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <hr class="my-4">
                
                <h6 class="mb-3"><i class="fas fa-plus-circle me-2 text-success"></i>Ajouter une nouvelle action</h6>
                <form action="{{ url_for('ajouter_action_conformite', veille_id=veille.id) }}" method="POST" class="needs-validation" novalidate>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Description *</label>
                            <input type="text" name="description" class="form-control" placeholder="Description de l'action" required>
                            <div class="invalid-feedback">
                                Veuillez saisir une description.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Responsable *</label>
                            <select name="responsable_id" class="form-select" required>
                                <option value="">Sélectionner un responsable...</option>
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.username }} - {{ user.role }}</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                Veuillez sélectionner un responsable.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Date d'échéance *</label>
                            <input type="date" name="date_echeance" class="form-control" required>
                            <div class="invalid-feedback">
                                Veuillez saisir une date d'échéance.
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">&nbsp;</label>
                            <button type="submit" class="fk-btn fk-btn-primary w-100">
                                <i class="fas fa-plus me-2"></i> Ajouter l'action
                            </button>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <a href="{{ url_for('archives_actions') }}" class="fk-btn fk-btn-outline">
                    <i class="fas fa-archive me-2"></i> Voir toutes les archives
                </a>
                <button type="button" class="fk-btn fk-btn-outline" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Documents -->
<div class="modal fade" id="documentModal{{ veille.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header fk-card-header">
                <h5 class="modal-title mb-0">Documents - {{ veille.titre }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                {% if veille.documents %}
                <div class="table-responsive">
                    <table class="table table-hover table-sm">
                        <thead>
                            <tr>
                                <th>Nom du fichier</th>
                                <th>Type</th>
                                <th>Taille</th>
                                <th>Ajouté le</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doc in veille.documents %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="rounded-circle bg-info bg-opacity-10 p-2 me-3">
                                            <i class="fas fa-file text-info"></i>
                                        </div>
                                        <div>{{ doc.nom_original }}</div>
                                    </div>
                                </td>
                                <td><span class="badge bg-info">{{ doc.type_fichier }}</span></td>
                                <td>{{ (doc.taille / 1024)|round(1) }} KB</td>
                                <td>{{ doc.created_at.strftime('%d/%m/%Y') }}</td>
                                <td>
                                    <a href="{{ url_for('telecharger_document_veille', doc_id=doc.id) }}" 
                                       class="btn btn-sm btn-success" title="Télécharger">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    <a href="{{ url_for('supprimer_document_veille', doc_id=doc.id) }}" 
                                       class="btn btn-sm btn-danger" 
                                       onclick="return confirmSupprimerDocument()"
                                       title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-file fa-3x text-muted mb-3 opacity-25"></i>
                    <h6 class="text-muted">Aucun document</h6>
                    <p class="text-muted">Ajoutez des documents relatifs à cette réglementation</p>
                </div>
                {% endif %}
                
                <hr class="my-4">
                
                <h6 class="mb-3"><i class="fas fa-upload me-2 text-primary"></i>Ajouter un document</h6>
                <form action="{{ url_for('ajouter_document_veille', veille_id=veille.id) }}" method="POST" enctype="multipart/form-data" class="needs-validation" novalidate>
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-3">
                        <input type="file" name="document" class="form-control" accept=".pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png" required>
                        <div class="invalid-feedback">
                            Veuillez sélectionner un fichier.
                        </div>
                        <small class="text-muted">Formats autorisés: PDF, Word, Excel, PowerPoint, images (max 16MB)</small>
                    </div>
                    <div class="text-end">
                        <button type="submit" class="fk-btn fk-btn-primary">
                            <i class="fas fa-upload me-2"></i> Téléverser
                        </button>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="fk-btn fk-btn-outline" data-bs-dismiss="modal">Fermer</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
// Fonctions pour gérer les actions
function archiverAction(actionId, titre) {
    if (confirm(`Archiver l'action pour "${titre}" ? Elle sera déplacée dans les archives.`)) {
        // Utilisez la route POST avec fetch
        fetch(`/veille/action/archiver/${actionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content || ''
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Erreur réseau');
        })
        .then(data => {
            if (data.success) {
                // Recharger la page ou mettre à jour l'interface
                window.location.reload();
            } else {
                alert('Erreur: ' + (data.error || 'Inconnue'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de l\'archivage');
        });
    }
}

function restaurerAction(actionId, titre) {
    if (confirm(`Restaurer l'action pour "${titre}" ? Elle redeviendra active.`)) {
        fetch(`/veille/action/restaurer/${actionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erreur lors de la restauration');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la restauration');
        });
    }
}

function supprimerAction(actionId, titre) {
    if (confirm(`Supprimer définitivement l'action pour "${titre}" ? Cette action est irréversible.`)) {
        fetch(`/veille/action/supprimer/${actionId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Erreur lors de la suppression');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de la suppression');
        });
    }
}

function confirmSupprimerDocument() {
    return confirm('Supprimer ce document ? Cette action est irréversible.');
}

// Initialisation
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser les tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-tooltip="tooltip"]'));
    const tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // Filtrage des veilles
    const searchInput = document.getElementById('searchVeille');
    const filterStatut = document.getElementById('filterStatut');
    const filterImpact = document.getElementById('filterImpact');
    const resetBtn = document.getElementById('resetFilters');
    const toggleDetails = document.getElementById('toggleDetails');

    function filterTable() {
        const search = searchInput.value.toLowerCase();
        const statut = filterStatut.value;
        const impact = filterImpact.value;

        document.querySelectorAll('#veilleTable tbody tr').forEach(row => {
            const text = row.textContent.toLowerCase();
            const rowStatut = row.dataset.statut;
            const rowImpact = row.dataset.impact;

            let show = true;

            if (search && !text.includes(search)) {
                show = false;
            }

            if (statut !== 'all' && rowStatut !== statut) {
                show = false;
            }

            if (impact !== 'all' && rowImpact !== impact) {
                show = false;
            }

            row.style.display = show ? '' : 'none';
        });
    }

    searchInput.addEventListener('keyup', filterTable);
    filterStatut.addEventListener('change', filterTable);
    filterImpact.addEventListener('change', filterTable);

    resetBtn.addEventListener('click', function() {
        searchInput.value = '';
        filterStatut.value = 'all';
        filterImpact.value = 'all';
        filterTable();
    });

    // Toggle détails
    if (toggleDetails) {
        toggleDetails.addEventListener('change', function() {
            const detailsRows = document.querySelectorAll('.details-row');
            detailsRows.forEach(row => {
                row.style.display = this.checked ? '' : 'none';
            });
        });
    }

    // Validation des formulaires
    const forms = document.querySelectorAll('.needs-validation');
    forms.forEach(form => {
        form.addEventListener('submit', function(event) {
            if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
            }
            form.classList.add('was-validated');
        }, false);
    });

    // Animation des cartes au scroll
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    document.querySelectorAll('.fk-card').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'all 0.6s ease-out';
        observer.observe(el);
    });
});
function archiverVeille(veilleId, titre) {
    if (confirm(`Archiver la veille "${titre}" ? Elle sera déplacée dans les archives.`)) {
        fetch(`/veille/archiver/${veilleId}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => {
            if (response.ok) {
                window.location.reload();
            } else {
                alert('Erreur lors de l\'archivage');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erreur lors de l\'archivage');
        });
    }
}
</script>
{% endblock %}

<style>
/* Styles spécifiques pour cette page */
.fk-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.fk-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 40px rgba(0, 0, 0, 0.12);
}

.progress {
    background-color: #f1f5f9;
}

.progress-bar {
    transition: width 0.5s ease-in-out;
}

.table-hover tbody tr:hover {
    background-color: rgba(var(--fk-accent-rgb, 59, 130, 246), 0.05);
}

.nav-tabs .nav-link {
    border: none;
    border-bottom: 3px solid transparent;
    color: var(--fk-steel);
    padding: 0.75rem 1rem;
    transition: all 0.3s;
}

.nav-tabs .nav-link:hover {
    border-bottom-color: #e2e8f0;
}

.nav-tabs .nav-link.active {
    color: var(--fk-accent);
    border-bottom-color: var(--fk-accent);
    background-color: transparent;
    font-weight: 600;
}

.modal-header.fk-card-header {
    background: linear-gradient(135deg, var(--fk-navy) 0%, var(--fk-blue) 100%);
    color: white;
}

/* Responsive */
@media (max-width: 768px) {
    .btn-group {
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .fk-btn {
        margin-bottom: 0.5rem;
    }
    
    .modal-dialog {
        margin: 0.5rem;
    }
}

/* Animations */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in {
    animation: fadeIn 0.3s ease-out;
}

/* Custom badges */
.badge.bg-primary {
    background: linear-gradient(135deg, var(--fk-accent) 0%, var(--fk-light-blue) 100%) !important;
}
</style>
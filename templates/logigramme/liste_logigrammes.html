{% extends "base.html" %}

{% block title %}Logigrammes des Processus - FabriceKonan Corporate{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête avec bouton d'action -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="h4 mb-2">
                <i class="fas fa-project-diagram me-2 text-primary"></i>
                Logigrammes des Processus
            </h2>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Tableau de bord</a></li>
                    <li class="breadcrumb-item active">Logigrammes</li>
                </ol>
            </nav>
        </div>
        <div>
            <a href="{{ url_for('nouveau_logigramme') }}" class="fk-btn fk-btn-primary">
                <i class="fas fa-plus me-2"></i>
                Nouveau Logigramme
            </a>
        </div>
    </div>

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="fk-card h-100">
                <div class="fk-card-body text-center">
                    <div class="mb-3">
                        <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-primary bg-opacity-10 p-3">
                            <i class="fas fa-project-diagram fa-2x text-primary"></i>
                        </div>
                    </div>
                    <h3 class="mb-1">{{ activites_actives|length }}</h3>
                    <p class="text-muted mb-0">Logigrammes actifs</p>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="fk-card h-100">
                <div class="fk-card-body text-center">
                    <div class="mb-3">
                        <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-warning bg-opacity-10 p-3">
                            <i class="fas fa-archive fa-2x text-warning"></i>
                        </div>
                    </div>
                    <h3 class="mb-1">{{ activites_archivees|length }}</h3>
                    <p class="text-muted mb-0">Archivés</p>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="fk-card h-100">
                <div class="fk-card-body text-center">
                    <div class="mb-3">
                        <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-success bg-opacity-10 p-3">
                            <i class="fas fa-shapes fa-2x text-success"></i>
                        </div>
                    </div>
                    <h3 class="mb-1">{{ total_elements }}</h3>
                    <p class="text-muted mb-0">Éléments total</p>
                </div>
            </div>
        </div>
        
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="fk-card h-100">
                <div class="fk-card-body text-center">
                    <div class="mb-3">
                        <div class="d-inline-flex align-items-center justify-content-center rounded-circle bg-info bg-opacity-10 p-3">
                            <i class="fas fa-link fa-2x text-info"></i>
                        </div>
                    </div>
                    <h3 class="mb-1">{{ total_liens }}</h3>
                    <p class="text-muted mb-0">Connexions total</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre de recherche et filtres -->
    <div class="fk-card mb-4">
        <div class="fk-card-body">
            <div class="row g-3 align-items-center">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" class="form-control fk-form-control border-start-0" 
                               id="searchInput" placeholder="Rechercher un logigramme...">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select fk-form-control" id="directionFilter">
                        <option value="">Toutes les directions</option>
                        {% for direction in directions %}
                        <option value="{{ direction.id }}">{{ direction.nom }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select fk-form-control" id="triSelect">
                        <option value="recent">Plus récents</option>
                        <option value="ancien">Plus anciens</option>
                        <option value="nom">Par nom (A-Z)</option>
                        <option value="elements">Plus d'éléments</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <a href="{{ url_for('archives_logigrammes') }}" class="fk-btn fk-btn-outline w-100">
                        <i class="fas fa-archive me-2"></i>Archives
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des logigrammes actifs -->
    <div class="row" id="logigrammesList">
        {% for activite in activites_actives %}
        <div class="col-xl-4 col-lg-6 mb-4 logigramme-item" 
             data-direction="{{ activite.direction_id }}"
             data-nom="{{ activite.nom|lower }}"
             data-description="{{ activite.description|lower }}"
             data-elements="{{ activite.elements|length }}"
             data-date="{{ activite.created_at.timestamp() }}">
            <div class="fk-card h-100">
                <div class="fk-card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary bg-opacity-10 rounded p-2 me-3">
                            <i class="fas fa-project-diagram text-primary"></i>
                        </div>
                        <div>
                            <h5 class="mb-1 text-truncate" style="max-width: 200px;" title="{{ activite.nom }}">
                                {{ activite.nom }}
                            </h5>
                            {% if activite.direction or activite.service %}
                            <div class="d-flex gap-1">
                                {% if activite.direction %}
                                <span class="fk-badge fk-badge-primary small">
                                    <i class="fas fa-sitemap me-1"></i>{{ activite.direction.nom }}
                                </span>
                                {% endif %}
                                {% if activite.service %}
                                <span class="fk-badge fk-badge-primary small">
                                    <i class="fas fa-building me-1"></i>{{ activite.service.nom }}
                                </span>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    <span class="fk-badge fk-badge-primary">
                        {{ activite.elements|length }} éléments
                    </span>
                </div>
                
                <div class="fk-card-body">
                    <!-- Description -->
                    <div class="mb-3">
                        <p class="mb-0 text-muted small">
                            {% if activite.description %}
                                {{ activite.description|truncate(100) }}
                            {% else %}
                                <em class="text-muted">Aucune description</em>
                            {% endif %}
                        </p>
                    </div>
                    
                    <!-- Métriques -->
                    <div class="border-top pt-3">
                        <div class="row text-center">
                            <div class="col-6 border-end">
                                <small class="text-muted d-block">Éléments</small>
                                <strong class="text-primary">{{ activite.elements|length }}</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Liens</small>
                                <strong class="text-info">{{ activite.liens|length }}</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dates -->
                    <div class="border-top pt-3 mt-3">
                        <div class="d-flex justify-content-between small">
                            <div>
                                <small class="text-muted">Créé le</small>
                                <div class="fw-semibold">
                                    {{ activite.created_at.strftime('%d/%m/%Y') if activite.created_at else 'N/A' }}
                                </div>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">Modifié</small>
                                <div class="fw-semibold">
                                    {{ activite.updated_at.strftime('%d/%m/%y') if activite.updated_at else activite.created_at.strftime('%d/%m/%y') }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Actions -->
                <div class="fk-card-body border-top pt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="btn-group">
                            <a href="{{ url_for('editer_logigramme', id=activite.id) }}" 
                               class="fk-btn fk-btn-outline btn-sm">
                                <i class="fas fa-edit me-1"></i>Éditer
                            </a>
                            <button type="button" class="fk-btn fk-btn-outline btn-sm dropdown-toggle dropdown-toggle-split" 
                                    data-bs-toggle="dropdown">
                                <span class="visually-hidden">Plus d'actions</span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <a class="dropdown-item modifier-logigramme" href="#" 
                                       data-id="{{ activite.id }}"
                                       data-nom="{{ activite.nom }}"
                                       data-description="{{ activite.description or '' }}"
                                       data-direction="{{ activite.direction_id or '' }}"
                                       data-service="{{ activite.service_id or '' }}">
                                        <i class="fas fa-cog me-2"></i>Modifier infos
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="#" onclick="dupliquerLogigramme({{ activite.id }})">
                                        <i class="fas fa-copy me-2"></i>Dupliquer
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider"></li>
                                <li>
                                    <a class="dropdown-item text-warning archiver-logigramme" href="#" 
                                       data-id="{{ activite.id }}"
                                       data-nom="{{ activite.nom }}">
                                        <i class="fas fa-archive me-2"></i>Archiver
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <span class="badge bg-success small">
                            <i class="fas fa-circle fa-xs me-1"></i>Actif
                        </span>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <!-- État vide -->
        <div class="col-12">
            <div class="fk-card">
                <div class="fk-card-body text-center py-5">
                    <div class="mb-4">
                        <i class="fas fa-project-diagram fa-4x text-muted opacity-25"></i>
                    </div>
                    <h4 class="mb-3">Aucun logigramme actif</h4>
                    <p class="text-muted mb-4">
                        Créez votre premier logigramme pour modéliser vos processus métier.
                    </p>
                    <a href="{{ url_for('nouveau_logigramme') }}" class="fk-btn fk-btn-primary">
                        <i class="fas fa-plus me-2"></i>
                        Créer un logigramme
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Section archives (réduite) -->
    {% if activites_archivees %}
    <div class="row mt-5">
        <div class="col-12">
            <div class="fk-card">
                <div class="fk-card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-archive me-2 text-warning"></i>
                        Derniers logigrammes archivés
                    </h5>
                    <a href="{{ url_for('archives_logigrammes') }}" class="fk-btn fk-btn-outline btn-sm">
                        Voir tous ({{ activites_archivees|length }})
                    </a>
                </div>
                <div class="fk-card-body">
                    <div class="row">
                        {% for activite in activites_archivees[:3] %}
                        <div class="col-md-4 mb-3">
                            <div class="border border-warning border-2 rounded p-3">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0 text-truncate flex-grow-1 me-2" title="{{ activite.nom }}">
                                        {{ activite.nom }}
                                    </h6>
                                    <span class="badge bg-warning text-dark small">
                                        {{ activite.archived_at.strftime('%d/%m') }}
                                    </span>
                                </div>
                                <div class="small text-muted">
                                    <i class="fas fa-shapes me-1"></i>{{ activite.elements|length }} éléments
                                    <i class="fas fa-link ms-3 me-1"></i>{{ activite.liens|length }} liens
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal de modification -->
<div class="modal fade" id="modalModification" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header fk-card-header">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>
                    Modifier le logigramme
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formModification">
                    <input type="hidden" id="logigrammeIdModif">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="nomLogigramme" class="form-label fw-semibold">Nom du logigramme *</label>
                                <input type="text" class="form-control fk-form-control" id="nomLogigramme" required>
                            </div>
                            <div class="mb-3">
                                <label for="descriptionLogigramme" class="form-label fw-semibold">Description</label>
                                <textarea class="form-control fk-form-control" id="descriptionLogigramme" rows="3"></textarea>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="fk-card">
                                <div class="fk-card-body">
                                    <h6 class="card-title fw-semibold">Affectation</h6>
                                    <div class="mb-3">
                                        <label for="directionLogigramme" class="form-label small">Direction associée</label>
                                        <select class="form-select fk-form-control" id="directionLogigramme">
                                            <option value="">Sélectionner une direction</option>
                                            {% for direction in directions %}
                                            <option value="{{ direction.id }}">{{ direction.nom }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label for="serviceLogigramme" class="form-label small">Service associé</label>
                                        <select class="form-select fk-form-control" id="serviceLogigramme">
                                            <option value="">Sélectionner un service</option>
                                            {% for service in services %}
                                            <option value="{{ service.id }}" data-direction="{{ service.direction_id }}">
                                                {{ service.nom }}
                                            </option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="fk-btn fk-btn-outline" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="fk-btn fk-btn-primary" id="btnConfirmerModification">
                    <i class="fas fa-save me-2"></i>Enregistrer
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal d'archivage -->
<div class="modal fade" id="modalArchivage" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header fk-card-header bg-warning">
                <h5 class="modal-title">
                    <i class="fas fa-archive me-2"></i>
                    Archiver le logigramme
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Êtes-vous sûr de vouloir archiver le logigramme <strong id="nomLogigrammeArchiver"></strong> ?</p>
                <div class="fk-alert fk-alert-warning">
                    <i class="fas fa-info-circle me-2"></i>
                    Le logigramme sera déplacé dans les archives et ne sera plus modifiable.
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="creerBackup">
                    <label class="form-check-label" for="creerBackup">
                        Créer une sauvegarde avant archivage
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="fk-btn fk-btn-outline" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="fk-btn fk-btn-warning" id="btnConfirmerArchivage">
                    <i class="fas fa-archive me-2"></i>Archiver
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de duplication -->
<div class="modal fade" id="modalDuplication" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header fk-card-header bg-info text-white">
                <h5 class="modal-title">
                    <i class="fas fa-copy me-2"></i>
                    Dupliquer le logigramme
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="nomCopie" class="form-label">Nom de la copie *</label>
                    <input type="text" class="form-control fk-form-control" id="nomCopie" placeholder="Nom de la copie..." required>
                </div>
                <div class="form-text">La copie contiendra tous les éléments et liens de l'original.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="fk-btn fk-btn-outline" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="fk-btn fk-btn-info" id="btnConfirmerDuplication">
                    <i class="fas fa-copy me-2"></i>Dupliquer
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Styles spécifiques pour cette page */
.fk-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.fk-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-medium);
}

.modal-header.fk-card-header {
    background: var(--primary-gradient);
    color: white;
    border-bottom: none;
}

.btn-warning {
    background: linear-gradient(135deg, var(--fk-warning) 0%, #FBBF24 100%);
    color: #000;
    border: none;
}

.btn-info {
    background: linear-gradient(135deg, #06b6d4 0%, #3bc9db 100%);
    color: white;
    border: none;
}

/* Responsive */
@media (max-width: 768px) {
    .fk-card-body {
        padding: 1rem;
    }
    
    .d-flex.justify-content-between {
        flex-direction: column;
        gap: 1rem;
    }
    
    .btn-group {
        width: 100%;
    }
    
    .btn-group .fk-btn {
        flex: 1;
    }
}
</style>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    let logigrammeActionId = null;

    // ============================================
    // FONCTIONS PRINCIPALES
    // ============================================
    
    // Modifier un logigramme
    function modifierLogigramme(id, nom, description, directionId, serviceId) {
        logigrammeActionId = id;
        
        // Remplir le formulaire
        document.getElementById('logigrammeIdModif').value = id;
        document.getElementById('nomLogigramme').value = nom;
        document.getElementById('descriptionLogigramme').value = description || '';
        document.getElementById('directionLogigramme').value = directionId || '';
        document.getElementById('serviceLogigramme').value = serviceId || '';
        
        // Filtrer les services
        filtrerServices();
        
        const modal = new bootstrap.Modal(document.getElementById('modalModification'));
        modal.show();
    }

    // Archiver un logigramme
    function archiverLogigramme(id, nom) {
        logigrammeActionId = id;
        document.getElementById('nomLogigrammeArchiver').textContent = nom;
        document.getElementById('creerBackup').checked = true;
        const modal = new bootstrap.Modal(document.getElementById('modalArchivage'));
        modal.show();
    }

    // Dupliquer un logigramme
    function dupliquerLogigramme(id) {
        logigrammeActionId = id;
        document.getElementById('nomCopie').value = '';
        const modal = new bootstrap.Modal(document.getElementById('modalDuplication'));
        modal.show();
    }

    // Filtrer les services selon la direction
    function filtrerServices() {
        const directionId = document.getElementById('directionLogigramme').value;
        const serviceSelect = document.getElementById('serviceLogigramme');
        const services = serviceSelect.querySelectorAll('option');
        
        services.forEach(option => {
            if (option.value === '') return;
            
            if (!directionId || option.getAttribute('data-direction') === directionId) {
                option.style.display = 'block';
                option.disabled = false;
            } else {
                option.style.display = 'none';
                option.disabled = true;
            }
        });
        
        // Réinitialiser si incompatible
        if (directionId && serviceSelect.value) {
            const selectedOption = serviceSelect.querySelector(`option[value="${serviceSelect.value}"]`);
            if (selectedOption && selectedOption.getAttribute('data-direction') !== directionId) {
                serviceSelect.value = '';
            }
        }
    }

    // ============================================
    // ÉVÉNEMENTS
    // ============================================
    
    // Gestion des clics sur les boutons d'action
    document.addEventListener('click', function(e) {
        // Modification
        if (e.target.closest('.modifier-logigramme')) {
            e.preventDefault();
            const link = e.target.closest('.modifier-logigramme');
            const id = link.dataset.id;
            const nom = link.dataset.nom;
            const description = link.dataset.description;
            const directionId = link.dataset.direction;
            const serviceId = link.dataset.service;
            
            modifierLogigramme(id, nom, description, directionId, serviceId);
        }
        
        // Archivage
        if (e.target.closest('.archiver-logigramme')) {
            e.preventDefault();
            const link = e.target.closest('.archiver-logigramme');
            const id = link.dataset.id;
            const nom = link.dataset.nom;
            
            archiverLogigramme(id, nom);
        }
    });

    // Événement pour le filtre des services
    document.getElementById('directionLogigramme').addEventListener('change', filtrerServices);
    
    // Confirmation de modification
    document.getElementById('btnConfirmerModification').addEventListener('click', async function() {
        const nom = document.getElementById('nomLogigramme').value.trim();
        const description = document.getElementById('descriptionLogigramme').value.trim();
        const directionId = document.getElementById('directionLogigramme').value;
        const serviceId = document.getElementById('serviceLogigramme').value;
        
        if (!nom) {
            showToast('Le nom est obligatoire', 'warning');
            return;
        }
        
        try {
            const response = await fetchWithCSRF(`/api/logigramme/${logigrammeActionId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    nom: nom,
                    description: description,
                    direction_id: directionId || null,
                    service_id: serviceId || null
                })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('modalModification')).hide();
                showToast('Logigramme modifié avec succès', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error(result.message || result.error || 'Erreur lors de la modification');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showToast('Erreur lors de la modification: ' + error.message, 'error');
        }
    });
    
    // Confirmation d'archivage
    document.getElementById('btnConfirmerArchivage').addEventListener('click', async function() {
        if (!logigrammeActionId) return;

        try {
            const response = await fetchWithCSRF(`/api/logigramme/${logigrammeActionId}/archiver`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            const result = await response.json();

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('modalArchivage')).hide();
                showToast('Logigramme archivé avec succès', 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                throw new Error(result.error || 'Erreur lors de l\'archivage');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showToast('Erreur lors de l\'archivage: ' + error.message, 'error');
        }
    });
    
    // Confirmation de duplication
    document.getElementById('btnConfirmerDuplication').addEventListener('click', async function() {
        if (!logigrammeActionId) return;

        const nomCopie = document.getElementById('nomCopie').value.trim();
        if (!nomCopie) {
            showToast('Veuillez saisir un nom pour la copie', 'warning');
            return;
        }

        try {
            const response = await fetchWithCSRF(`/api/logigramme/${logigrammeActionId}/dupliquer`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nom: nomCopie })
            });

            const result = await response.json();
            
            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('modalDuplication')).hide();
                showToast('Logigramme dupliqué avec succès', 'success');
                // Rediriger vers le nouveau logigramme
                setTimeout(() => {
                    window.location.href = `/editer_logigramme/${result.id}`;
                }, 1500);
            } else {
                throw new Error(result.error || 'Erreur lors de la duplication');
            }
        } catch (error) {
            console.error('Erreur:', error);
            showToast('Erreur lors de la duplication: ' + error.message, 'error');
        }
    });

    // ============================================
    // FONCTIONS UTILITAIRES
    // ============================================
    
    // Filtrage et tri
    function filtrerEtTrierLogigrammes() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();
        const directionFilter = document.getElementById('directionFilter').value;
        const triSelect = document.getElementById('triSelect').value;
        
        const elements = Array.from(document.querySelectorAll('.logigramme-item'));
        
        // Filtrer
        const elementsFiltres = elements.filter(element => {
            const nom = element.dataset.nom;
            const description = element.dataset.description;
            const direction = element.dataset.direction;
            
            let visible = true;
            
            // Filtre de recherche
            if (searchTerm && !nom.includes(searchTerm) && !description.includes(searchTerm)) {
                visible = false;
            }
            
            // Filtre par direction
            if (directionFilter && direction !== directionFilter) {
                visible = false;
            }
            
            return visible;
        });
        
        // Trier
        elementsFiltres.sort((a, b) => {
            switch(triSelect) {
                case 'recent':
                    return parseFloat(b.dataset.date) - parseFloat(a.dataset.date);
                case 'ancien':
                    return parseFloat(a.dataset.date) - parseFloat(b.dataset.date);
                case 'nom':
                    return a.dataset.nom.localeCompare(b.dataset.nom);
                case 'elements':
                    return parseFloat(b.dataset.elements) - parseFloat(a.dataset.elements);
                default:
                    return 0;
            }
        });
        
        // Afficher
        const container = document.getElementById('logigrammesList');
        container.innerHTML = '';
        elementsFiltres.forEach(element => container.appendChild(element));
    }

    // Événements de filtrage
    document.getElementById('searchInput').addEventListener('input', filtrerEtTrierLogigrammes);
    document.getElementById('directionFilter').addEventListener('change', filtrerEtTrierLogigrammes);
    document.getElementById('triSelect').addEventListener('change', filtrerEtTrierLogigrammes);

    // Enter pour confirmer la duplication
    document.getElementById('nomCopie').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('btnConfirmerDuplication').click();
        }
    });

    // ============================================
    // ANIMATIONS
    // ============================================
    
    // Animation des cartes au scroll
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);
    
    document.querySelectorAll('.fk-card').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'all 0.6s ease-out';
        observer.observe(el);
    });
});
</script>
{% endblock %}
<!-- templates/client_admin/usage.html -->
{% extends "base.html" %}

{% block title %}Utilisation et limites{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('client_admin_dashboard') }}">Admin Client</a></li>
            <li class="breadcrumb-item active">Utilisation</li>
        </ol>
    </nav>

    <!-- En-tête -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-2">Utilisation et limites</h1>
            <p class="text-muted mb-0">
                Suivez l'utilisation de votre abonnement {{ current_user.client.formule.nom if current_user.client.formule else '' }}
            </p>
        </div>
        {% if formules_upgrade %}
        <div class="col-md-4 text-md-end">
            <div class="dropdown">
                <button class="fk-btn fk-btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-level-up-alt me-2"></i>Améliorer l'abonnement
                </button>
                <ul class="dropdown-menu">
                    {% for formule in formules_upgrade %}
                    <li>
                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#upgradeModal{{ formule.id }}">
                            <strong>{{ formule.nom }}</strong>
                            <br>
                            <small>{{ formule.prix_mensuel }}€/mois • {{ formule.max_utilisateurs }} utilisateurs</small>
                        </a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Formule actuelle -->
    <div class="fk-card mb-4">
        <div class="fk-card-header">
            <h5 class="mb-0">Formule actuelle</h5>
        </div>
        <div class="fk-card-body">
            {% if current_user.client.formule %}
            {% set formule = current_user.client.formule %}
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-1">{{ formule.nom }}</h4>
                    <p class="text-muted mb-2">
                        <i class="fas fa-info-circle me-1"></i>{{ formule.description }}
                    </p>
                    
                    <div class="d-flex flex-wrap gap-3">
                        <div>
                            <small class="text-muted">Prix</small>
                            <div>
                                <strong>{{ formule.prix_mensuel }}€</strong>
                                <small class="text-muted">/mois</small>
                                {% if formule.prix_annuel %}
                                <br><small>{{ formule.prix_annuel }}€/an</small>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div>
                            <small class="text-muted">Features</small>
                            <div>
                                <strong>{{ formule.get_features_list()|length }}</strong>
                                <small class="text-muted"> features activées</small>
                            </div>
                        </div>
                        
                        <div>
                            <small class="text-muted">Modules</small>
                            <div>
                                <strong>{{ formule.get_modules_list()|length }}</strong>
                                <small class="text-muted"> modules accessibles</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 text-md-end">
                    <div class="badge bg-{{ 'success' if formule.code == 'enterprise' else 'warning' if formule.code == 'premium' else 'info' }} fs-6 p-2">
                        {{ formule.code|upper }}
                    </div>
                </div>
            </div>
            {% else %}
            <div class="text-center py-3">
                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                <h5>Aucune formule active</h5>
                <p class="text-muted">Contactez le support pour souscrire à une formule.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Statistiques d'utilisation -->
    {% if stats %}
    <div class="fk-card mb-4">
        <div class="fk-card-header">
            <h5 class="mb-0">Utilisation actuelle</h5>
        </div>
        <div class="fk-card-body">
            <div class="row">
                {% for key, data in stats.items() %}
                <div class="col-md-6 mb-4">
                    <div class="d-flex justify-content-between mb-1">
                        <span>
                            <strong>{{ key|title }}</strong>
                            <small class="text-muted ms-1">({{ data.current }}/{{ data.limit }})</small>
                        </span>
                        <span class="text-{{ data.color_class }}">
                            {{ '%0.0f'|format(data.percent) }}%
                        </span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-{{ data.color_class }}" 
                             style="width: {{ data.percent }}%"></div>
                    </div>
                    {% if data.percent >= 80 %}
                    <small class="text-{{ data.color_class }}">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        {% if data.percent >= 90 %}
                        Limite presque atteinte !
                        {% else %}
                        Limite approchée
                        {% endif %}
                    </small>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Historique des abonnements -->
    {% if abonnements %}
    <div class="fk-card">
        <div class="fk-card-header">
            <h5 class="mb-0">Historique des abonnements</h5>
        </div>
        <div class="fk-card-body">
            <div class="table-responsive">
                <table class="table fk-table">
                    <thead>
                        <tr>
                            <th>Formule</th>
                            <th>Période</th>
                            <th>Montant</th>
                            <th>Début</th>
                            <th>Fin</th>
                            <th>Statut</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for abonnement in abonnements %}
                        <tr>
                            <td>
                                <strong>{{ abonnement.formule.nom }}</strong>
                            </td>
                            <td>{{ abonnement.periode|title }}</td>
                            <td>
                                <strong>{{ abonnement.montant }}€</strong>
                                <br><small>{{ abonnement.devise }}</small>
                            </td>
                            <td>{{ abonnement.date_debut|format_date }}</td>
                            <td>
                                {% if abonnement.date_fin %}
                                {{ abonnement.date_fin|format_date }}
                                {% else %}
                                <span class="text-muted">En cours</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-{{ 'success' if abonnement.statut == 'actif' else 'secondary' }}">
                                    {{ abonnement.statut|title }}
                                </span>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Modals pour les upgrades -->
    {% for formule in formules_upgrade %}
    <div class="modal fade" id="upgradeModal{{ formule.id }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Passer à {{ formule.nom }}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Nouveautés :</h6>
                        <ul class="small mb-0">
                            <li>{{ formule.max_utilisateurs }} utilisateurs (actuellement {{ stats.utilisateurs.limit }})</li>
                            <li>{{ formule.max_risques }} risques (actuellement {{ stats.risques.limit }})</li>
                            <li>{{ formule.get_features_list()|length }} nouvelles features</li>
                            <li>{{ formule.get_modules_list()|length }} nouveaux modules</li>
                        </ul>
                    </div>
                    
                    <div class="text-center my-4">
                        <h3 class="text-primary">{{ formule.prix_mensuel }}€</h3>
                        <p class="text-muted">/ mois</p>
                        {% if formule.prix_annuel %}
                        <p class="small">
                            <i class="fas fa-percentage me-1"></i>
                            Économisez {{ '%0.0f'|format((1 - (formule.prix_annuel / (formule.prix_mensuel * 12))) * 100) }}% avec l'abonnement annuel
                        </p>
                        {% endif %}
                    </div>
                    
                    <p class="text-muted small">
                        <i class="fas fa-clock me-1"></i>
                        Le changement prend effet immédiatement. Vous serez facturé au prorata.
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Plus tard
                    </button>
                    <button type="button" class="btn btn-primary"
                            onclick="requestUpgrade({{ formule.id }})">
                        <i class="fas fa-check me-2"></i>Confirmer l'upgrade
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<script>
function requestUpgrade(formuleId) {
    if (confirm('Êtes-vous sûr de vouloir passer à cette formule ?\n\nVous serez redirigé vers le support.')) {
        // Envoyer une demande d'upgrade
        fetch('/api/client/upgrade-request', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({
                formule_id: formuleId,
                client_id: {{ current_user.client.id }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Demande d\'upgrade envoyée. Notre équipe vous contactera rapidement.');
                // Fermer le modal
                const modal = bootstrap.Modal.getInstance(document.querySelector('#upgradeModal' + formuleId));
                modal.hide();
            } else {
                alert('Erreur: ' + data.error);
            }
        });
    }
}
</script>
{% endblock %}
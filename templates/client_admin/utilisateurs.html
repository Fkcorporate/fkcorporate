<!-- templates/client_admin/utilisateurs.html -->
{% extends "base.html" %}

{% block title %}Gestion des utilisateurs - Admin Client{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('client_admin_dashboard') }}">Admin Client</a></li>
                    <li class="breadcrumb-item active">Utilisateurs</li>
                </ol>
            </nav>
            
            <!-- En-tête avec bouton -->
            <!-- En-tête avec bouton -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Gestion des utilisateurs</h1>
                <div>
                    {% if can_edit_users and stats.total < stats.limite %}
                    <a href="{{ url_for('client_admin_creer_utilisateur') }}" class="btn btn-modern-primary">
                        <i class="fas fa-user-plus me-2"></i>Nouvel utilisateur
                    </a>
                    <!-- BOUTON AJOUTÉ ICI -->
                    {% if current_user.is_client_admin %}
                    <a href="{{ url_for('client_admin_creer_gestionnaire') }}" class="btn btn-modern-warning ms-2">
                        <i class="fas fa-user-shield me-2"></i>Créer un gestionnaire
                    </a>
                    {% endif %}
                    {% elif can_edit_users %}
                    <button class="btn btn-modern-primary" disabled title="Limite d'utilisateurs atteinte">
                        <i class="fas fa-user-plus me-2"></i>Nouvel utilisateur
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
            <div class="alert alert-{{ category if category != 'error' else 'danger' }} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Statistiques -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card card-modern card-stat">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-primary bg-opacity-10 d-flex align-items-center justify-content-center me-3" 
                             style="width: 48px; height: 48px;">
                            <i class="fas fa-users fa-lg text-primary"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">{{ stats.total }}</h4>
                            <p class="text-muted mb-0">Utilisateurs total</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card card-modern card-stat">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-success bg-opacity-10 d-flex align-items-center justify-content-center me-3" 
                             style="width: 48px; height: 48px;">
                            <i class="fas fa-user-check fa-lg text-success"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">{{ stats.actifs }}</h4>
                            <p class="text-muted mb-0">Utilisateurs actifs</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card card-modern card-stat">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-warning bg-opacity-10 d-flex align-items-center justify-content-center me-3" 
                             style="width: 48px; height: 48px;">
                            <i class="fas fa-user-shield fa-lg text-warning"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">{{ stats.admin_count }}</h4>
                            <p class="text-muted mb-0">Administrateurs</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-3">
            <div class="card card-modern card-stat">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-info bg-opacity-10 d-flex align-items-center justify-content-center me-3" 
                             style="width: 48px; height: 48px;">
                            <i class="fas fa-chart-line fa-lg text-info"></i>
                        </div>
                        <div>
                            <h4 class="mb-0">{{ stats.limite }}</h4>
                            <p class="text-muted mb-0">Limite formule</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Barre de progression utilisation -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card card-modern">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Utilisation de votre formule</h6>
                        <span class="badge bg-{{ 'danger' if stats.total >= stats.limite else 'warning' if stats.total >= stats.limite*0.9 else 'success' }}">
                            {{ stats.total }}/{{ stats.limite }} utilisateurs
                            ({{ stats.pourcentage|round|int }}%)
                        </span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <div class="progress-bar bg-{{ 'danger' if stats.total >= stats.limite else 'warning' if stats.total >= stats.limite*0.9 else 'success' }}" 
                             style="width: {{ stats.pourcentage if stats.pourcentage <= 100 else 100 }}%">
                        </div>
                    </div>
                    <div class="mt-2 small text-muted">
                        {% if stats.total >= stats.limite %}
                        <i class="fas fa-exclamation-triangle text-danger me-1"></i>
                        <span class="text-danger">Limite atteinte ! Vous ne pouvez plus créer d'utilisateurs.</span>
                        {% elif stats.total >= stats.limite*0.9 %}
                        <i class="fas fa-exclamation-circle text-warning me-1"></i>
                        <span class="text-warning">Vous approchez de la limite ({{ stats.pourcentage|round|int }}%)</span>
                        {% else %}
                        <i class="fas fa-check-circle text-success me-1"></i>
                        <span>Bonne marge disponible ({{ stats.limite - stats.total }} places restantes)</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau des utilisateurs -->
    <div class="row">
        <div class="col-12">
            <div class="card card-modern">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Liste des utilisateurs</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="exportUsersToCSV()">
                            <i class="fas fa-download me-1"></i>Exporter
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="refreshUserList()">
                            <i class="fas fa-sync-alt me-1"></i>Rafraîchir
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    {% if users %}
                    <div class="table-responsive">
                        <table class="table table-modern table-hover">
                            <thead>
                                <tr>
                                    <th>Utilisateur</th>
                                    <th>Rôle</th>
                                    <th>Département</th>
                                    <th>Statut</th>
                                    <th>Date création</th>
                                    <th>Dernière connexion</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="rounded-circle bg-light d-flex align-items-center justify-content-center me-3" 
                                                 style="width: 36px; height: 36px;">
                                                {% if user.is_client_admin %}
                                                <i class="fas fa-crown text-warning"></i>
                                                {% elif user.role == 'admin' %}
                                                <i class="fas fa-shield-alt text-danger"></i>
                                                {% elif user.role == 'manager' %}
                                                <i class="fas fa-user-tie text-warning"></i>
                                                {% else %}
                                                <i class="fas fa-user text-muted"></i>
                                                {% endif %}
                                            </div>
                                            <div>
                                                <strong>{{ user.username }}</strong>
                                                <br>
                                                <small class="text-muted">{{ user.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge-modern 
                                            {% if user.role == 'admin' or user.is_client_admin %}badge-danger
                                            {% elif user.role == 'manager' %}badge-warning
                                            {% elif user.role == 'auditeur' %}badge-info
                                            {% elif user.role == 'consultant' %}badge-success
                                            {% else %}badge-secondary{% endif %}">
                                            {{ user.get_role_display_name() }}
                                            {% if user.is_client_admin %}
                                            <i class="fas fa-crown ms-1"></i>
                                            {% endif %}
                                        </span>
                                    </td>
                                    <td>{{ user.department or 'Non spécifié' }}</td>
                                    <td>
                                        {% if user.is_active %}
                                        <span class="badge bg-success">Actif</span>
                                        {% else %}
                                        <span class="badge bg-danger">Inactif</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <small>{{ user.created_at.strftime('%d/%m/%Y') }}</small>
                                    </td>
                                    <td>
                                        {% if user.last_login %}
                                        <small>{{ user.last_login.strftime('%d/%m/%Y %H:%M') }}</small>
                                        {% else %}
                                        <small class="text-muted">Jamais</small>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <!-- Voir/Éditer -->
                                            <a href="{{ url_for('client_admin_editer_utilisateur', id=user.id) if can_edit_users else '#' }}" 
                                               class="btn btn-outline-primary"
                                               {% if not can_edit_users %}disabled{% endif %}
                                               title="{{ 'Voir/Éditer' if can_edit_users else 'Permission insuffisante' }}">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <!-- Gérer permissions (seulement admin) -->
                                            {% if current_user.is_client_admin and user.id != current_user.id %}
                                            <a href="{{ url_for('admin_gerer_permissions', id=user.id) }}" 
                                                class="btn btn-outline-info"
                                                title="Gérer permissions">
                                                <i class="fas fa-key"></i>
                                            </a>
                                            {% endif %}
                                            
                                            <!-- Activer/Désactiver -->
                                            {% if can_edit_users and user.id != current_user.id and not user.is_client_admin %}
                                            <button class="btn btn-outline-{{ 'warning' if user.is_active else 'success' }} toggle-user"
                                                    data-user-id="{{ user.id }}"
                                                    data-username="{{ user.username }}"
                                                    data-current-status="{{ 'actif' if user.is_active else 'inactif' }}"
                                                    title="{{ 'Désactiver' if user.is_active else 'Activer' }}">
                                                <i class="fas fa-{{ 'ban' if user.is_active else 'check' }}"></i>
                                            </button>
                                            {% elif user.id == current_user.id %}
                                            <button class="btn btn-outline-secondary" disabled title="Vous ne pouvez pas modifier votre propre statut">
                                                <i class="fas fa-user"></i>
                                            </button>
                                            {% elif user.is_client_admin %}
                                            <button class="btn btn-outline-secondary" disabled title="Administrateur client - modification restreinte">
                                                <i class="fas fa-shield-alt"></i>
                                            </button>
                                            {% endif %}
                                            
                                            <!-- Supprimer -->
                                            {% if can_edit_users and user.id != current_user.id and not user.is_client_admin %}
                                            <button class="btn btn-outline-danger delete-user"
                                                    data-user-id="{{ user.id }}"
                                                    data-username="{{ user.username }}"
                                                    title="Supprimer">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% elif user.id == current_user.id %}
                                            <button class="btn btn-outline-secondary" disabled title="Vous ne pouvez pas vous supprimer vous-même">
                                                <i class="fas fa-user-slash"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination (optionnelle) -->
                    {% if users|length > 10 %}
                    <nav aria-label="Navigation utilisateurs" class="mt-4">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Précédent</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item">
                                <a class="page-link" href="#">Suivant</a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                    
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5>Aucun utilisateur</h5>
                        <p class="text-muted mb-4">Commencez par créer votre premier utilisateur</p>
                        {% if can_edit_users and stats.total < stats.limite %}
                        <a href="{{ url_for('client_admin_creer_utilisateur') }}" class="btn btn-modern-primary">
                            <i class="fas fa-user-plus me-2"></i>Créer un utilisateur
                        </a>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Informations supplémentaires -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card card-modern">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Informations</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-shield-alt text-primary me-2"></i>
                            <strong>Administrateurs :</strong> Peuvent gérer tous les aspects du client
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-user-check text-success me-2"></i>
                            <strong>Utilisateurs actifs :</strong> Peuvent se connecter et utiliser le système
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-user-times text-danger me-2"></i>
                            <strong>Utilisateurs inactifs :</strong> Ne peuvent pas se connecter
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-chart-line text-warning me-2"></i>
                            <strong>Limite formule :</strong> {{ stats.limite }} utilisateurs maximum
                        </li>
                        <li>
                            <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                            <strong>Restrictions :</strong> Vous ne pouvez pas modifier/supprimer votre propre compte ou d'autres administrateurs
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card card-modern">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Statistiques détaillées</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-6">
                            <div class="mb-3">
                                <h6 class="mb-1">Répartition par rôle</h6>
                                <canvas id="roleChart" height="150"></canvas>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="mb-3">
                                <h6 class="mb-1">Statut des comptes</h6>
                                <canvas id="statusChart" height="150"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-sync-alt me-1"></i>
                            Dernière mise à jour : {{ now.strftime('%d/%m/%Y %H:%M') }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation activation/désactivation -->
<div class="modal fade" id="toggleUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirmation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="toggleUserMessage">Êtes-vous sûr de vouloir modifier le statut de cet utilisateur ?</p>
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <small>Cette action affectera immédiatement la capacité de l'utilisateur à se connecter.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary" id="confirmToggleUser">Confirmer</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmation suppression -->
<div class="modal fade" id="deleteUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Suppression d'utilisateur</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Attention : Cette action est irréversible !</strong>
                </div>
                <p id="deleteUserMessage">Êtes-vous absolument sûr de vouloir supprimer cet utilisateur ?</p>
                <ul class="text-danger small">
                    <li>Toutes les données associées seront perdues</li>
                    <li>L'utilisateur ne pourra plus se connecter</li>
                    <li>Cette action ne peut pas être annulée</li>
                </ul>
                <div class="alert alert-warning mt-3">
                    <i class="fas fa-lightbulb me-2"></i>
                    <small><strong>Conseil :</strong> Si vous souhaitez simplement empêcher l'accès, désactivez le compte plutôt que de le supprimer.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteUser">Supprimer définitivement</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Variables globales pour les modals
let currentUserId = null;
let currentUsername = null;

// Générer un token CSRF s'il n'est pas disponible
const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || 
                  document.querySelector('input[name="csrf_token"]')?.value || 
                  '{{ csrf_token() if csrf_token else "" }}';

// Initialiser les charts
function initCharts() {
    // Données pour le chart des rôles
    const roleData = {
        labels: ['Utilisateurs', 'Managers', 'Auditeurs', 'Administrateurs', 'Consultants'],
        datasets: [{
            data: [
                {{ stats.user_count }},
                {{ users|selectattr('role', 'equalto', 'manager')|list|length }},
                {{ users|selectattr('role', 'equalto', 'auditeur')|list|length }},
                {{ stats.admin_count }},
                {{ users|selectattr('role', 'equalto', 'consultant')|list|length }}
            ],
            backgroundColor: [
                '#6c757d', // gris - utilisateurs
                '#ffc107', // jaune - managers
                '#0dcaf0', // bleu clair - auditeurs
                '#dc3545', // rouge - admins
                '#198754'  // vert - consultants
            ]
        }]
    };

    // Données pour le chart des statuts
    const statusData = {
        labels: ['Actifs', 'Inactifs'],
        datasets: [{
            data: [{{ stats.actifs }}, {{ stats.inactifs }}],
            backgroundColor: ['#198754', '#dc3545']
        }]
    };

    // Chart des rôles
    const roleCtx = document.getElementById('roleChart');
    if (roleCtx) {
        new Chart(roleCtx.getContext('2d'), {
            type: 'doughnut',
            data: roleData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }

    // Chart des statuts
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
        new Chart(statusCtx.getContext('2d'), {
            type: 'doughnut',
            data: statusData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
}

// Gérer activation/désactivation
document.querySelectorAll('.toggle-user').forEach(button => {
    button.addEventListener('click', function() {
        currentUserId = this.dataset.userId;
        currentUsername = this.dataset.username;
        const currentStatus = this.dataset.currentStatus;
        const newStatus = currentStatus === 'actif' ? 'inactif' : 'actif';
        
        // Mettre à jour le message du modal
        document.getElementById('toggleUserMessage').innerHTML = `
            Êtes-vous sûr de vouloir <strong class="text-${newStatus === 'inactif' ? 'danger' : 'success'}">${newStatus === 'inactif' ? 'désactiver' : 'activer'}</strong> 
            l'utilisateur <strong>${currentUsername}</strong> ?
        `;
        
        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('toggleUserModal'));
        modal.show();
    });
});

// Confirmer activation/désactivation
document.getElementById('confirmToggleUser').addEventListener('click', function() {
    if (!currentUserId) return;
    
    const btn = this;
    const originalText = btn.innerHTML;
    
    // Désactiver le bouton pendant la requête
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Traitement...';
    
    // Utiliser la route admin client spécifique
    fetch(`/client-admin/utilisateur/${currentUserId}/toggle`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // Rafraîchir la page après 1.5 secondes
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showToast(data.error || 'Erreur lors de la modification', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showToast('Erreur réseau: ' + error.message, 'error');
    })
    .finally(() => {
        // Fermer le modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('toggleUserModal'));
        if (modal) modal.hide();
        
        // Réactiver le bouton
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
});

// Gérer suppression
document.querySelectorAll('.delete-user').forEach(button => {
    button.addEventListener('click', function() {
        currentUserId = this.dataset.userId;
        currentUsername = this.dataset.username;
        
        // Mettre à jour le message du modal
        document.getElementById('deleteUserMessage').innerHTML = `
            Êtes-vous absolument sûr de vouloir supprimer l'utilisateur 
            <strong class="text-danger">${currentUsername}</strong> ?<br><br>
            <span class="text-muted">Cette action est définitive et ne peut pas être annulée.</span>
        `;
        
        // Afficher le modal
        const modal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
        modal.show();
    });
});

// Confirmer suppression
document.getElementById('confirmDeleteUser').addEventListener('click', function() {
    if (!currentUserId) return;
    
    const btn = this;
    const originalText = btn.innerHTML;
    
    // Désactiver le bouton pendant la requête
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Suppression...';
    
    // Utiliser la route admin client spécifique
    fetch(`/client-admin/utilisateur/${currentUserId}/supprimer`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            showToast(data.message, 'success');
            // Rafraîchir la page après 1.5 secondes
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showToast(data.error || data.details || 'Erreur lors de la suppression', 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showToast('Erreur réseau: ' + error.message, 'error');
    })
    .finally(() => {
        // Fermer le modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('deleteUserModal'));
        if (modal) modal.hide();
        
        // Réactiver le bouton
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
});

// Exporter en CSV
function exportUsersToCSV() {
    const rows = [
        ['Nom', 'Email', 'Rôle', 'Département', 'Statut', 'Date création', 'Dernière connexion']
    ];
    
    {% for user in users %}
    rows.push([
        '{{ user.username }}',
        '{{ user.email }}',
        '{{ user.get_role_display_name() }}',
        '{{ user.department or "" }}',
        '{{ "Actif" if user.is_active else "Inactif" }}',
        '{{ user.created_at.strftime("%d/%m/%Y") }}',
        '{% if user.last_login %}{{ user.last_login.strftime("%d/%m/%Y %H:%M") }}{% else %}Jamais{% endif %}'
    ]);
    {% endfor %}
    
    let csvContent = "data:text/csv;charset=utf-8,";
    rows.forEach(row => {
        csvContent += row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(";") + "\n";
    });
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "utilisateurs_{{ client.reference if client else 'client' }}_{{ now.strftime('%Y%m%d_%H%M') }}.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showToast('Export CSV généré avec succès', 'success');
}

// Rafraîchir la liste
function refreshUserList() {
    const refreshBtn = document.querySelector('button[onclick="refreshUserList()"]');
    if (!refreshBtn) return;
    
    const originalHtml = refreshBtn.innerHTML;
    
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Rafraîchissement...';
    
    setTimeout(() => {
        window.location.reload();
    }, 500);
}

// Afficher les notifications
function showToast(message, type = 'info') {
    // Types Bootstrap pour les toasts
    const typeClasses = {
        'success': 'text-bg-success',
        'error': 'text-bg-danger',
        'warning': 'text-bg-warning',
        'info': 'text-bg-info'
    };
    
    const toastClass = typeClasses[type] || 'text-bg-info';
    
    const toastHtml = `
        <div class="toast ${toastClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    // Créer ou réutiliser le conteneur de toasts
    let toastContainer = document.querySelector('.toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.className = 'toast-container position-fixed bottom-0 end-0 p-3';
        document.body.appendChild(toastContainer);
    }
    
    // Ajouter le toast
    toastContainer.insertAdjacentHTML('beforeend', toastHtml);
    
    // Afficher le toast
    const toastElement = toastContainer.lastElementChild;
    const toast = new bootstrap.Toast(toastElement, { 
        delay: 4000,
        autohide: true
    });
    toast.show();
    
    // Supprimer le toast après disparition
    toastElement.addEventListener('hidden.bs.toast', function() {
        this.remove();
    });
}

// Initialiser au chargement
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser les charts
    initCharts();
    
    // Initialiser les tooltips Bootstrap
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
    
    // Désactiver les boutons si nécessaire
    document.querySelectorAll('.btn[disabled]').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            if (this.disabled) {
                const title = this.getAttribute('title') || this.getAttribute('data-bs-original-title');
                if (title) {
                    showToast(title, 'warning');
                }
            }
        });
    });
    
    // Gérer les erreurs de formulaire
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('error')) {
        showToast(urlParams.get('error'), 'error');
    }
});
</script>

<style>
.card-stat {
    border: none;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    transition: transform 0.2s ease;
}

.card-stat:hover {
    transform: translateY(-2px);
}

.badge-modern {
    padding: 0.35em 0.65em;
    font-size: 0.75em;
    font-weight: 600;
    border-radius: 6px;
}

.badge-danger {
    background-color: rgba(220, 53, 69, 0.1);
    color: #dc3545;
}

.badge-warning {
    background-color: rgba(255, 193, 7, 0.1);
    color: #ffc107;
}

.badge-info {
    background-color: rgba(13, 202, 240, 0.1);
    color: #0dcaf0;
}

.badge-success {
    background-color: rgba(25, 135, 84, 0.1);
    color: #198754;
}

.badge-secondary {
    background-color: rgba(108, 117, 125, 0.1);
    color: #6c757d;
}

.table-modern {
    --bs-table-striped-bg: rgba(0, 0, 0, 0.02);
    border-collapse: separate;
    border-spacing: 0;
}

.table-modern thead th {
    border-bottom: 2px solid #e9ecef;
    font-weight: 600;
    text-transform: uppercase;
    font-size: 0.85em;
    letter-spacing: 0.5px;
    color: #6c757d;
}

.table-modern tbody tr {
    transition: background-color 0.15s ease;
}

.table-modern tbody tr:hover {
    background-color: rgba(0, 123, 255, 0.03);
}

.btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.875rem;
}

.progress {
    border-radius: 10px;
    overflow: hidden;
}

.progress-bar {
    border-radius: 10px;
    transition: width 0.6s ease;
}

/* Animation pour le bouton rafraîchir */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.fa-spinner {
    animation: spin 1s linear infinite;
}

/* Style pour les boutons désactivés */
.btn[disabled] {
    opacity: 0.5;
    cursor: not-allowed;
}

/* Responsive */
@media (max-width: 768px) {
    .card-stat .d-flex {
        flex-direction: column;
        text-align: center;
    }
    
    .card-stat .rounded-circle {
        margin: 0 auto 1rem auto;
    }
    
    .btn-group {
        flex-wrap: wrap;
        margin-top: 0.5rem;
    }
    
    .table-modern thead {
        display: none;
    }
    
    .table-modern tbody tr {
        display: block;
        margin-bottom: 1rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    
    .table-modern tbody td {
        display: block;
        text-align: right;
        padding: 0.5rem;
        position: relative;
        border: none;
    }
    
    .table-modern tbody td::before {
        content: attr(data-label);
        position: absolute;
        left: 0.5rem;
        font-weight: 600;
        color: #6c757d;
    }
    
    .table-modern tbody td:first-child {
        padding-top: 1rem;
    }
    
    .table-modern tbody td:last-child {
        padding-bottom: 1rem;
        border-bottom: none;
    }
}
/* Style pour le bouton gestionnaire */
.btn-modern-warning {
    background-color: #ffc107;
    color: #212529;
    border: 1px solid #ffc107;
    font-weight: 500;
    transition: all 0.3s ease;
}

.btn-modern-warning:hover {
    background-color: #e0a800;
    border-color: #e0a800;
    color: #212529;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(255, 193, 7, 0.2);
}

.btn-modern-warning:active {
    background-color: #d39e00;
    border-color: #c69500;
}
</style>
{% endblock %}